# Staging/Production Workflow Guide

This guide explains how to set up and use a proper staging/production deployment workflow with Render.com.

## Overview

The workflow consists of:
- **Local Development**: Work on your machine with local database
- **Staging Branch**: Automatically deploys to staging environment on Render
- **Production Branch**: Automatically deploys to production environment on Render
- **Database Sync**: Keep staging database synchronized with production

## Setup Instructions

### 1. Environment Configuration

Create a `.env` file in your project root (copy from `env.example`):

```bash
# Flask Configuration
SECRET_KEY=your-secret-key-here
FLASK_ENV=development
FLASK_DEBUG=True

# Database Configuration
# For local development with PostgreSQL
DATABASE_URL=postgresql://localhost:5432/ecclesiastical_lineage_dev

# Remote Database URLs for syncing
# Production database (for syncing staging)
PRODUCTION_DATABASE_URL=postgresql://user:pass@host:port/database

# Staging database (for syncing from production)
STAGING_DATABASE_URL=postgresql://user:pass@host:port/database

# Development Settings
PORT=5001
DEBUG=True
```

### 2. Render.com Setup

#### Create Two Separate Services on Render:

1. **Staging Service**:
   - Use `render-staging.yaml` configuration
   - Connect to `staging` branch
   - Auto-deploy on push to staging

2. **Production Service**:
   - Use `render-production.yaml` configuration  
   - Connect to `main` branch
   - Auto-deploy on push to main

#### Get Database URLs:

1. Go to your Render dashboard
2. For each service, go to the database section
3. Copy the connection string for each database
4. Add them to your `.env` file

### 3. Local Development Setup

```bash
# Install PostgreSQL (if not already installed)
brew install postgresql@16
brew services start postgresql@16

# Create local database
createdb ecclesiastical_lineage_dev

# Install Python dependencies
pip install -r requirements.txt

# Initialize local database
python3 init_postgres_db.py
```

## Workflow Process

### Daily Development Workflow

1. **Start with fresh staging data** (optional):
   ```bash
   ./sync_staging_from_production.sh
   ```

2. **Develop locally**:
   ```bash
   # Make your changes
   # Test locally
   python3 app.py --port 5001
   ```

3. **Deploy to staging**:
   ```bash
   git add .
   git commit -m "Your changes"
   git push origin staging
   # Staging automatically deploys on Render
   ```

4. **Test on staging**:
   - Visit your staging URL
   - Test all functionality
   - Verify database changes work correctly

5. **Deploy to production** (when ready):
   ```bash
   git checkout main
   git merge staging
   git push origin main
   # Production automatically deploys on Render
   ```

### Database Synchronization

#### Sync Staging from Production

When you want staging to have the same data as production:

```bash
./sync_staging_from_production.sh
```

This script:
- Exports all data from production database
- Imports it into staging database
- Overwrites staging data (be careful!)

#### Sync Local from Production

To get production data locally for testing:

```bash
./sync_dev_db.sh
```

## File Structure

```
ecclesiastical-lineage/
├── .env                              # Your local environment (not in git)
├── env.example                       # Template for .env
├── render-staging.yaml              # Staging deployment config
├── render-production.yaml           # Production deployment config
├── deploy_staging.sh                # Staging deployment script
├── deploy_production.sh             # Production deployment script
├── sync_staging_from_production.sh  # Sync staging from production
├── sync_dev_db.sh                   # Sync local from remote
└── STAGING_PRODUCTION_WORKFLOW.md   # This guide
```

## Environment Variables

### Local Development
- `DATABASE_URL`: Local PostgreSQL database
- `SECRET_KEY`: Your secret key
- `FLASK_ENV`: development
- `FLASK_DEBUG`: True

### Staging (Render)
- `DATABASE_URL`: Staging PostgreSQL database (set by Render)
- `SECRET_KEY`: Generated by Render
- `ENVIRONMENT`: staging
- `FLASK_ENV`: staging

### Production (Render)
- `DATABASE_URL`: Production PostgreSQL database (set by Render)
- `SECRET_KEY`: Generated by Render
- `ENVIRONMENT`: production
- `FLASK_ENV`: production

## Branch Strategy

- **`staging`**: Your testing branch, auto-deploys to staging environment
- **`main`**: Your production branch, auto-deploys to production environment

### Typical Git Workflow

```bash
# Start new feature
git checkout staging
git pull origin staging

# Make changes
# ... edit files ...

# Test locally
python3 app.py --port 5001

# Commit and push to staging
git add .
git commit -m "Add new feature"
git push origin staging

# Test on staging environment
# ... test on staging URL ...

# When ready, merge to production
git checkout main
git pull origin main
git merge staging
git push origin main

# Clean up
git checkout staging
git pull origin main  # Keep staging up to date
```

## Database Management

### Keeping Staging in Sync

To ensure staging always has the same data as production:

1. **Before major testing**:
   ```bash
   ./sync_staging_from_production.sh
   ```

2. **After production data changes**:
   ```bash
   ./sync_staging_from_production.sh
   ```

### Database Migrations

Database migrations are handled automatically by the deployment scripts:

- **Staging**: `deploy_staging.sh` runs migrations
- **Production**: `deploy_production.sh` runs migrations

Both scripts:
1. Install dependencies
2. Initialize database tables
3. Run Flask-Migrate migrations
4. Migrate legacy data
5. Verify migration success

## Troubleshooting

### Common Issues

#### 1. Staging Database Out of Sync

**Symptom**: Staging has different data than production

**Solution**:
```bash
./sync_staging_from_production.sh
```

#### 2. Deployment Fails

**Check**:
- Environment variables are set correctly
- Database connection is working
- All dependencies are installed

**Debug**:
```bash
# Check environment variables
python3 debug_env.py

# Test database connection
python3 test_db_connection.py
```

#### 3. Local Development Issues

**Check**:
- PostgreSQL is running: `brew services start postgresql@16`
- Local database exists: `psql -l | grep ecclesiastical_lineage_dev`
- Environment variables are set in `.env`

### Getting Help

1. Check the deployment logs in Render dashboard
2. Run debug scripts locally
3. Verify environment variables
4. Check database connectivity

## Security Notes

- **Never commit `.env` file** to version control
- **Use different databases** for staging and production
- **Sync staging from production** (not the other way around)
- **Test thoroughly** on staging before production deployment

## Best Practices

1. **Always test on staging** before production
2. **Keep staging in sync** with production data
3. **Use meaningful commit messages**
4. **Monitor deployment logs**
5. **Backup production data** before major changes
6. **Use feature branches** for complex changes

---

**Last Updated**: January 2025  
**Version**: 1.0
