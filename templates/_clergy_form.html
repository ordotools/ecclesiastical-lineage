{% macro clergy_form(fields, clergy=None, edit_mode=False, user=None, redirect_url=None, use_htmx=True, context_type=None, context_clergy_id=None) %}

<!-- Form submission overlay styles -->
<style>
.form-submission-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 1em;
    color: rgba(255, 255, 255, 0.9);
}

.form-submission-overlay.active {
    display: flex;
}

.form-submission-overlay .overlay-content {
    text-align: center;
    max-width: 300px;
}

.form-submission-overlay .overlay-title {
    font-size: 1em;
    font-weight: 500;
    margin-bottom: 1em;
    color: rgba(255, 255, 255, 0.9);
}

.form-submission-overlay .progress-container {
    width: 100%;
    max-width: 300px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
    height: 8px;
    margin-bottom: 0.5em;
}

.form-submission-overlay .progress-bar {
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 4px;
    transition: width 0.3s ease;
    width: 0%;
}

.form-submission-overlay .progress-text {
    font-size: 0.85em;
    color: rgba(255, 255, 255, 0.7);
    margin-top: 0.5em;
}

.form-submission-overlay .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.2);
    border-top: 3px solid rgba(255, 255, 255, 0.8);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1em;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

{# Auto-generate form action if not provided #}
{% set form_action = fields.form_action if fields.form_action else (
    url_for('clergy.edit_clergy', clergy_id=clergy.id) if edit_mode and clergy else
    url_for('main.add_clergy_from_lineage') if context_type else
    url_for('clergy.add_clergy')
) %}

<div style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 1em; margin: 0 auto; max-width: 600px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); position: relative;">
    <div style="margin-bottom: 1em; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 0.5em;">
        <h2 style="margin: 0; color: white; font-weight: 500; font-size: 1.2em;">{% if edit_mode %}Edit {{ clergy.name }}{% else %}Add New Clergy{% endif %}</h2>
    </div>
    <div>
        <form id="clergyForm" method="POST" action="{{ form_action }}" enctype="multipart/form-data" 
              {% if use_htmx %}
              <!-- COMMENTED OUT FOR REBUILD: HTMX attributes
              hx-post="{{ form_action }}" 
              hx-target="body" 
              hx-swap="outerHTML"
              hx-trigger="submit"
              hx-push-url="true"
              hx-on::after-request="if(event.detail.successful) { window.location.href = '{{ redirect_url or url_for('clergy.clergy_list') }}'; }"
              -->
              {% endif %}
            
            <!-- Hidden fields to preserve context -->
            {% if context_type %}
            <input type="hidden" name="context_type" value="{{ context_type }}">
            {% endif %}
            {% if context_clergy_id %}
            <input type="hidden" name="context_clergy_id" value="{{ context_clergy_id }}">
            {% endif %}
            <!-- Clean Form Layout -->
            <div>
                <!-- Form Fields Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75em;">
                    <!-- Row 1: Name (2 columns) -->
                    <div style="grid-column: 1 / -1;">
                        <label for="name" style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.85em;">Full Name *</label>
                        <input type="text" id="name" name="name" 
                               value="{{ clergy.name if edit_mode and clergy else '' }}" required
                               style="width: 100%; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.9em; color: white; transition: border-color 0.2s;">
                    </div>

                    <!-- Papal Name Field (only shown for popes) - Row 2, 2 columns -->
                    <div id="papalNameField" style="display: none; grid-column: 1 / -1; grid-row: 2; flex-direction: column;">
                        <label for="papal_name" style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.85em;">Papal Name</label>
                        <input type="text" id="papal_name" name="papal_name" 
                               value="{{ clergy.papal_name if edit_mode and clergy else '' }}" 
                               placeholder="e.g., Pope Francis, Pope Benedict XVI"
                               style="width: 100%; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.9em; color: white; transition: border-color 0.2s;">
                    </div>

                    <!-- Photo Section (col 1, 3 rows, starting row 3) -->
                    <div id="photoField" style="grid-column: 1; grid-row: 3 / 6; display: flex; flex-direction: column; height: 100%;">
                        <label style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.85em;">Photo</label>
                        <div id="photoContainer" class="drag-drop-container" style="border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding: 1em; flex: 1; display: flex; align-items: stretch; justify-content: center; flex-direction: column; height: 100%;">
                            <div id="imagePreview" style="text-align: center; flex: 1; display: flex; align-items: center; justify-content: center;">
                                {% if edit_mode and clergy and clergy.image_data %}
                                    {% set image_data = clergy.image_data | from_json %}
                                    {% if image_data and image_data.detail %}
                                        <img src="{{ image_data.detail }}" alt="{{ clergy.name }}" id="previewImage" style="max-width: 100px; max-height: 100px; border-radius: 4px;"
                                             data-full-image="{{ clergy.image_data|safe }}">
                                    {% elif clergy.image_url %}
                                        <img src="{{ clergy.image_url }}" alt="{{ clergy.name }}" id="previewImage" style="max-width: 100px; max-height: 100px; border-radius: 4px;"
                                             data-full-image="{{ clergy.image_data|safe }}">
                                    {% endif %}
                                {% elif edit_mode and clergy and clergy.image_url %}
                                    <img src="{{ clergy.image_url }}" alt="{{ clergy.name }}" id="previewImage" style="max-width: 100px; max-height: 100px; border-radius: 4px;">
                                {% else %}
                                    <div id="noPhotoPlaceholder" style="color: rgba(255, 255, 255, 0.6); font-size: 0.9em; padding: 1.5em; border: 1px dashed rgba(255, 255, 255, 0.3); border-radius: 4px; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100px;">
                                        <i class="fas fa-user" style="font-size: 1.5em; margin-bottom: 0.5em; opacity: 0.6;"></i>
                                        <div>No Photo</div>
                                        <div style="font-size: 0.8em; margin-top: 0.5em; opacity: 0.7;">Click or drag & drop to upload</div>
                                    </div>
                                {% endif %}
                            </div>
                            <!-- Image control buttons -->
                            <div style="margin-top: 0.75em; display: flex; flex-direction: column; gap: 0.4em; width: 100%; flex-shrink: 0;">
                                    <input type="file" id="clergyImage" name="clergy_image" accept="image/*" style="display: none;">
                                <button type="button" id="uploadBtn" title="Upload Image"
                                        style="width: 100%; padding: 0.4em 0.6em; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; border-radius: 4px; cursor: pointer; font-size: 0.75em;">
                                    <i class="fas fa-upload" style="margin-right: 0.4em;"></i>Upload Photo
                                </button>
                                    {% if edit_mode and clergy and clergy.image_url %}
                                <button type="button" id="cropExistingBtn" title="Edit Image"
                                        style="width: 100%; padding: 0.4em 0.6em; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; border-radius: 4px; cursor: pointer; font-size: 0.75em;">
                                    <i class="fas fa-edit" style="margin-right: 0.4em;"></i>Edit Photo
                                </button>
                                <button type="button" id="removeImageBtn" title="Remove Image"
                                        style="width: 100%; padding: 0.4em 0.6em; border: 1px solid rgba(255, 100, 100, 0.4); background: rgba(255, 100, 100, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: rgba(255, 150, 150, 0.9); border-radius: 4px; cursor: pointer; font-size: 0.75em;">
                                    <i class="fas fa-trash" style="margin-right: 0.4em;"></i>Remove Photo
                                </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Row 4: Rank (col 2) -->
                    <div id="rankField" style="grid-column: 2; grid-row: 3;">
                        <label for="rank" style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.85em;">Rank *</label>
                        <select id="rank" name="rank" required
                                style="width: 100%; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.9em; color: white; transition: border-color 0.2s;">
                            <option value="" style="background: #2c3e50; color: white;">Select Rank</option>
                            {% for rank in fields.ranks %}
                            <option value="{{ rank.name }}" data-is-bishop="{{ 'true' if rank.is_bishop else 'false' }}" style="background: #2c3e50; color: white;" {% if edit_mode and clergy and clergy.rank == rank.name %}selected{% endif %}>
                                {{ rank.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Organization (2 columns) -->
                    <div id="organizationField" style="grid-column: 1 / -1; grid-row: 2;">
                        <label for="organization" style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.85em;">Organization</label>
                        <div style="display: flex; gap: 0.5em; align-items: center;">
                            <select id="organization" name="organization" 
                                    style="flex: 1; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.9em; color: white; transition: border-color 0.2s;">
                                <option value="" style="background: #2c3e50; color: white;">Select Organization</option>
                                {% for org in fields.organizations %}
                                <option value="{{ org.name }}" style="background: #2c3e50; color: white;" {% if clergy and clergy.organization == org.name %}selected{% endif %}>
                                    {{ org.name }}{% if org.abbreviation %} ({{ org.abbreviation }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" onclick="showOrganizationModal()" 
                                    style="padding: 0.5em 0.75em; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; border-radius: 4px; cursor: pointer; white-space: nowrap; font-size: 0.8em; transition: all 0.2s;">
                                Add New
                            </button>
                        </div>
                    </div>

                    <!-- Row 5: Date of Birth (col 2) -->
                    <div id="birthField" style="grid-column: 2; grid-row: 4;">
                        <label for="date_of_birth" style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.85em;">Date of Birth</label>
                        <input type="date" id="date_of_birth" name="date_of_birth" 
                               value="{{ clergy.date_of_birth.strftime('%Y-%m-%d') if edit_mode and clergy and clergy.date_of_birth else '' }}"
                               style="width: 100%; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.9em; color: white; transition: border-color 0.2s;">
                    </div>


                    <!-- Row 6: Date of Death (col 2) -->
                    <div id="deathField" style="grid-column: 2; grid-row: 5;">
                        <label for="date_of_death" style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.85em;">Date of Death</label>
                        <input type="date" id="date_of_death" name="date_of_death" 
                               value="{{ clergy.date_of_death.strftime('%Y-%m-%d') if edit_mode and clergy and clergy.date_of_death else '' }}"
                               style="width: 100%; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.9em; color: white; transition: border-color 0.2s;">
                    </div>


                    <!-- Ordinations Section (2 columns) -->
                    <div id="ordinationsField" style="grid-column: 1 / -1;">
                        <h5 style="margin: 0 0 0.5em 0; color: white; font-size: 0.9em; font-weight: 500;">Ordinations</h5>
                        <!-- <div style="margin-bottom: 0.5em; padding: 0.5em; background: rgba(255, 255, 255, 0.1); border-radius: 4px; font-size: 0.8em; color: rgba(255, 255, 255, 0.8);">
                            <strong>Note:</strong> If you enter a bishop name that doesn't exist in the database, a new bishop record will be automatically created with the rank "Bishop".
                        </div> -->
                        <div style="border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding: 1em;">
                            <div style="display: flex; gap: 0.5em; margin-bottom: 1em;">
                                <button type="button" id="addOrdinationBtn" style="padding: 0.4em 0.8em; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                                    Add Ordination

                                </button>
                            </div>
                            
                            <!-- Sample Ordination Entry -->
                            <div style="border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 4px; background: rgba(255, 255, 255, 0.05); padding: 0.75em; margin-bottom: 0.75em;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em; margin-bottom: 0.5em;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.8em;">Date</label>
                                        <input type="date" name="ordinations[0][date]" style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.8em;">Ordaining Bishop</label>
                                        <div style="position: relative;">
                                            <input type="text" name="ordinations[0][ordaining_bishop_input]" placeholder="Search for bishop..." autocomplete="off" style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white;">
                                            <input type="hidden" name="ordinations[0][ordaining_bishop_id]">
                                            <div class="autocomplete-dropdown" style="position: absolute; top: 100%; left: 0; width: 100%; z-index: 20; display: none; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; max-height: 200px; overflow-y: auto;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em; margin-bottom: 0.5em;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5em; font-weight: 400; color: white; font-size: 0.8em;">Status</label>
                                        <div style="display: flex; flex-direction: column; gap: 0.5em;">
                                            <div style="display: flex; align-items: center; gap: 0.5em;">
                                                <input type="checkbox" name="ordinations[0][is_sub_conditione]" id="sub_conditione_0" style="margin: 0;">
                                                <label for="sub_conditione_0" style="color: white; font-size: 0.8em; margin: 0; cursor: pointer;">Sub Conditione</label>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 0.5em;">
                                                <input type="checkbox" name="ordinations[0][is_doubtful_event]" id="doubtful_event_0" style="margin: 0;">
                                                <label for="doubtful_event_0" style="color: white; font-size: 0.8em; margin: 0; cursor: pointer;">Doubtful Event</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5em; font-weight: 400; color: white; font-size: 0.8em;">Validity</label>
                                        <select name="ordinations[0][validity]" style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white;">
                                            <option value="valid">Valid</option>
                                            <option value="doubtfully_valid">Doubtfully Valid</option>
                                            <option value="invalid">Invalid</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.8em;">Notes</label>
                                    <textarea name="ordinations[0][notes]" rows="2" placeholder="Additional notes..." style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white; resize: vertical;"></textarea>
                                </div>
                                <div style="margin-top: 0.5em; text-align: right;">
                                    <button type="button" class="remove-ordination" style="padding: 0.25em 0.5em; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; border-radius: 3px; cursor: pointer; font-size: 0.75em;">
                                        Remove
                                    </button>
                                </div>
                            </div>
                            
                            <div id="ordinationsContainer">
                                <!-- Dynamic ordination sections will be added here -->
                            </div>
                        </div>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Every clergy member must have at least one ordination.
                        </small>
                    </div>

                    <!-- Consecrations Section (2 columns) -->
                    <div id="consecrationsField" style="grid-column: 1 / -1; display: none;">
                        <h5 style="margin: 0 0 0.5em 0; color: white; font-size: 0.9em; font-weight: 500;">Consecrations</h5>
                        <!-- <div style="margin-bottom: 0.5em; padding: 0.5em; background: rgba(255, 255, 255, 0.1); border-radius: 4px; font-size: 0.8em; color: rgba(255, 255, 255, 0.8);">
                            <strong>Note:</strong> If you enter a bishop name that doesn't exist in the database, a new bishop record will be automatically created with the rank "Bishop".
                        </div> -->
                        <div style="border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding: 1em;">
                            <div style="display: flex; gap: 0.5em; margin-bottom: 1em;">
                                <button type="button" id="addConsecrationBtn" style="padding: 0.4em 0.8em; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                                    Add Consecration

                                </button>
                            </div>
                            
                            <!-- Sample Consecration Entry -->
                            <div class="consecration-entry" style="border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 4px; background: rgba(255, 255, 255, 0.05); padding: 0.75em; margin-bottom: 0.75em;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em; margin-bottom: 0.5em;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.8em;">Date</label>
                                        <input type="date" name="consecrations[0][date]" style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.8em;">Consecrator</label>
                                        <div style="position: relative;">
                                            <input type="text" name="consecrations[0][consecrator_input]" placeholder="Search for consecrator..." autocomplete="off" style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white;">
                                            <input type="hidden" name="consecrations[0][consecrator_id]">
                                            <div class="autocomplete-dropdown" style="position: absolute; top: 100%; left: 0; width: 100%; z-index: 20; display: none; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; max-height: 200px; overflow-y: auto;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 0.5em;">
                                    <label style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.8em;">Co-Consecrators</label>
                                    <div style="display: flex; gap: 0.5em; margin-bottom: 0.5em;">
                                        <div style="position: relative; flex: 1;">
                                            <input type="text" name="consecrations[0][co_consecrators][0][input]" placeholder="Search for co-consecrator..." autocomplete="off" style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white;">
                                            <input type="hidden" name="consecrations[0][co_consecrators][0][id]">
                                            <div class="autocomplete-dropdown" style="position: absolute; top: 100%; left: 0; width: 100%; z-index: 20; display: none; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; max-height: 200px; overflow-y: auto;"></div>
                                        </div>
                                        <button type="button" class="add-co-consecrator" style="padding: 0.4em 0.6em; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; border-radius: 3px; cursor: pointer; font-size: 0.75em;">
                                            Add
                                        </button>
                                    </div>
                                    <div class="co-consecrators-list">
                                        <!-- Additional co-consecrators will be added here -->
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em; margin-bottom: 0.5em;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5em; font-weight: 400; color: white; font-size: 0.8em;">Status</label>
                                        <div style="display: flex; flex-direction: column; gap: 0.5em;">
                                            <div style="display: flex; align-items: center; gap: 0.5em;">
                                                <input type="checkbox" name="consecrations[0][is_sub_conditione]" id="consec_sub_conditione_0" style="margin: 0;">
                                                <label for="consec_sub_conditione_0" style="color: white; font-size: 0.8em; margin: 0; cursor: pointer;">Sub Conditione</label>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 0.5em;">
                                                <input type="checkbox" name="consecrations[0][is_doubtful_event]" id="consec_doubtful_event_0" style="margin: 0;">
                                                <label for="consec_doubtful_event_0" style="color: white; font-size: 0.8em; margin: 0; cursor: pointer;">Doubtful Event</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5em; font-weight: 400; color: white; font-size: 0.8em;">Validity</label>
                                        <select name="consecrations[0][validity]" style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white;">
                                            <option value="valid">Valid</option>
                                            <option value="doubtfully_valid">Doubtfully Valid</option>
                                            <option value="invalid">Invalid</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.8em;">Notes</label>
                                    <textarea name="consecrations[0][notes]" rows="2" placeholder="Additional notes..." style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white; resize: vertical;"></textarea>
                                </div>
                                <div style="margin-top: 0.5em; text-align: right;">
                                    <button type="button" class="remove-consecration" style="padding: 0.25em 0.5em; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; border-radius: 3px; cursor: pointer; font-size: 0.75em;">
                                        Remove
                                    </button>
                                </div>
                            </div>
                            
                            <div id="consecrationsContainer">
                                <!-- Dynamic consecration sections will be added here -->
                            </div>
                        </div>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Consecration is required for bishops, archbishops, cardinals, and popes.
                        </small>
                    </div>

                    <!-- Status Indicators Section (2 columns) -->
                    {% if fields.statuses %}
                    <div style="grid-column: 1 / -1; margin-top: 1em;">
                        <h5 style="margin: 0 0 0.5em 0; color: white; font-size: 0.9em; font-weight: 500;">Status Indicators</h5>
                        <div style="border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding: 1em;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75em;">
                                {% for status in fields.statuses %}
                                <div class="status-toggle-item" style="display: flex; align-items: center; gap: 0.5em; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 4px; background: rgba(255, 255, 255, 0.05);">
                                    <input type="checkbox" 
                                           id="status_{{ status.id }}" 
                                           name="status_ids[]" 
                                           value="{{ status.id }}"
                                           {% if edit_mode and clergy and status in clergy.statuses %}checked{% endif %}
                                           style="margin: 0; cursor: pointer;">
                                    <label for="status_{{ status.id }}" style="margin: 0; cursor: pointer; display: flex; align-items: center; gap: 0.4em; flex: 1; color: white; font-size: 0.85em;">
                                        <i class="fas {{ status.icon }}" style="color: {{ status.color }}; font-size: 0.9em;"></i>
                                        <span>{{ status.name|title }}</span>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            <small class="form-text text-muted" style="display: block; margin-top: 0.75em; font-size: 0.75em; color: rgba(255, 255, 255, 0.6);">
                                <i class="fas fa-info-circle"></i> Select any applicable status indicators for this clergy member. Multiple statuses can be selected.
                            </small>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Notes (2 columns) -->
                    <div style="grid-column: 1 / -1;">
                        <label for="notes" style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.85em;">Notes</label>
                        <textarea id="notes" name="notes" rows="3" style="width: 100%; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.9em; color: white; transition: border-color 0.2s; resize: vertical;">{{ clergy.notes if edit_mode and clergy else '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Admin Controls -->
            {% if edit_mode and clergy and user and user.can_edit_clergy() %}
            <div>
                <div>
                    <div>
                        <div>
                            <h6>Administrative Controls</h6>
                        </div>
                        <div>
                            <div>
                                <input type="checkbox" id="mark_deleted" name="mark_deleted" value="1" 
                                       {% if clergy.is_deleted %}checked{% endif %}>
                                <label for="mark_deleted">
                                    Mark this record as deleted
                                </label>
                            </div>
                            <small>
                                This will hide the record from normal views but keep it in the database for audit purposes. 
                                You can uncheck this to restore the record.
                            </small>
                            {% if clergy.is_deleted %}
                            <div>
                                <small>
                                    Record was marked as deleted on: {{ clergy.deleted_at.strftime('%Y-%m-%d %H:%M:%S') if clergy.deleted_at else 'Unknown date' }}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div style="display: flex; gap: 0.5em; justify-content: flex-end; margin-top: 1em; border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 0.75em;">
                <a href="{{ fields.cancel_url or url_for('clergy.clergy_list') }}" id="cancel-btn"
                   style="padding: 0.5em 1em; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 4px; cursor: pointer; font-weight: 400; color: rgba(255, 255, 255, 0.8); transition: all 0.2s; text-decoration: none; display: inline-block; font-size: 0.85em;">
                    Cancel
                </a>
                <button type="submit"
                        style="padding: 0.5em 1em; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; border-radius: 4px; cursor: pointer; font-weight: 400; transition: all 0.2s; font-size: 0.85em;">
                    {% if edit_mode %}Save Changes{% else %}Save Clergy Record{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Organization Modal (only for add mode) -->
{% if not edit_mode %}
<div id="addOrganizationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 1000;">
    <div style="position: absolute; top: 3em; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 16px; padding: 2em; width: 50%; max-width: 600px; min-width: 400px; max-height: calc(100vh - 6em); overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);">
        <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5em; border-bottom: 1px solid rgba(0, 0, 0, 0.1); padding-bottom: 0.75em;">
                <h5 id="addOrganizationModalLabel" style="margin: 0; color: #333; font-weight: 600;">Add New Organization</h5>
                <button type="button" id="closeModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s;">&times;</button>
            </div>
            <div>
                <form id="addOrganizationForm">
                    <div style="margin-bottom: 1.25em;">
                        <label for="new-organization-name" style="display: block; margin-bottom: 0.5em; font-weight: 500; color: #333;">Organization Name *</label>
                        <input type="text" id="new-organization-name" required style="width: 100%; padding: 0.75em; border: 1px solid rgba(0, 0, 0, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 14px; transition: border-color 0.2s, box-shadow 0.2s;">
                    </div>
                    <div style="margin-bottom: 1.25em;">
                        <label for="new-organization-abbreviation" style="display: block; margin-bottom: 0.5em; font-weight: 500; color: #333;">Abbreviation</label>
                        <input type="text" id="new-organization-abbreviation" placeholder="Optional short code" style="width: 100%; padding: 0.75em; border: 1px solid rgba(0, 0, 0, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 14px; transition: border-color 0.2s, box-shadow 0.2s;">
                    </div>
                    <div style="margin-bottom: 1.25em;">
                        <label for="new-organization-description" style="display: block; margin-bottom: 0.5em; font-weight: 500; color: #333;">Description</label>
                        <textarea id="new-organization-description" rows="3" placeholder="Optional description" style="width: 100%; padding: 0.75em; border: 1px solid rgba(0, 0, 0, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 14px; resize: vertical; transition: border-color 0.2s, box-shadow 0.2s;"></textarea>
                    </div>
                </form>
            </div>
            <div style="display: flex; gap: 0.75em; justify-content: flex-end; margin-top: 1.5em; border-top: 1px solid rgba(0, 0, 0, 0.1); padding-top: 1em;">
                <button type="button" id="cancelModal" style="padding: 0.75em 1.5em; border: 1px solid rgba(0, 0, 0, 0.2); background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 8px; cursor: pointer; font-weight: 500; color: #666; transition: all 0.2s;">Cancel</button>
                <button type="button" onclick="addOrganization()" style="padding: 0.75em 1.5em; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">Add Organization</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal functionality -->
<script>
// Note: clearFormState is now in clergy-form-state.js (loaded globally)
// Function to initialize the embedded form functionality
function initializeEmbeddedFormScript() {
    console.log('Initializing embedded form script');
    
    // NOTE: We do NOT clear form state here because:
    // 1. Clearing is already done in selectClergy() BEFORE the HTMX request (for editor)
    // 2. If we clear here, we would clear the newly loaded data that was just populated
    // 3. The form has already been populated with the correct data by populateExistingOrdinations/consecrations
    
    const modal = document.getElementById('addOrganizationModal');
    const closeBtn = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelModal');
    
    
    // Function to show modal
    function showModal() {
        if (modal) {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
    }
    
    // Function to hide modal
    function hideModal() {
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
            // Clear form
            const form = document.getElementById('addOrganizationForm');
            if (form) {
                form.reset();
            }
        }
    }
    
    // Close modal when clicking close button
    if (closeBtn) {
        closeBtn.addEventListener('click', hideModal);
        
        // Add hover effects for close button
        closeBtn.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
        });
        closeBtn.addEventListener('mouseleave', function() {
            this.style.backgroundColor = 'transparent';
        });
    }
    
    // Close modal when clicking cancel button
    if (cancelBtn) {
        cancelBtn.addEventListener('click', hideModal);
    }
    
    // Close modal when clicking outside the modal content
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                hideModal();
            }
        });
    }
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal && modal.style.display === 'block') {
            hideModal();
        }
    });
    
    // Make showModal function globally available
    window.showOrganizationModal = showModal;

    // Dynamic grid layout adjustment for papal name field and consecrations
    function adjustGridLayout() {
        const papalField = document.getElementById('papalNameField');
        const consecrationsField = document.getElementById('consecrationsField');
        const organizationField = document.getElementById('organizationField');
        const photoField = document.getElementById('photoField');
        const rankField = document.getElementById('rankField');
        const birthField = document.getElementById('birthField');
        const deathField = document.getElementById('deathField');

        const papalVisible = papalField && papalField.style.display !== 'none';
        const consecrationsVisible = consecrationsField && consecrationsField.style.display !== 'none';
        
        console.log('Adjusting layout. Papal field visible:', papalVisible, 'Consecrations visible:', consecrationsVisible);
        console.log('Found elements:', { organizationField, photoField, rankField, birthField, deathField, consecrationsField });

        // Calculate row positions based on what's visible
        let currentRow = 2; // Start after name field
        
        // Papal name field (if visible, takes row 2)
        if (papalVisible) {
            if (papalField) {
                papalField.style.gridRow = currentRow.toString();
                console.log('Moved papal name to row', currentRow);
                currentRow++;
            }
        }
        
        // Organization field
        if (organizationField) {
            organizationField.style.gridRow = currentRow.toString();
            console.log('Moved organization to row', currentRow);
            currentRow++;
        }
        
        // Photo field (spans 3 rows)
        if (photoField) {
            photoField.style.gridRow = currentRow + ' / ' + (currentRow + 3);
            console.log('Moved photo to rows', currentRow + '-' + (currentRow + 2));
        }
        
        // Rank field (same row as photo start)
        if (rankField) {
            rankField.style.gridRow = currentRow.toString();
            console.log('Moved rank to row', currentRow);
        }
        
        // Birth field (second row of photo)
        if (birthField) {
            birthField.style.gridRow = (currentRow + 1).toString();
            console.log('Moved birth to row', currentRow + 1);
        }
        
        // Death field (third row of photo)
        if (deathField) {
            deathField.style.gridRow = (currentRow + 2).toString();
            console.log('Moved death to row', currentRow + 2);
        }
        
        // Move to next available row after photo section
        currentRow += 3;
        
        // Ordinations field (always visible, spans 2 columns)
        const ordinationsField = document.getElementById('ordinationsField');
        if (ordinationsField) {
            ordinationsField.style.gridRow = currentRow.toString();
            console.log('Moved ordinations to row', currentRow);
            currentRow++;
        }
        
        // Consecrations field (only if visible)
        if (consecrationsField) {
            if (consecrationsVisible) {
                consecrationsField.style.gridRow = currentRow.toString();
                console.log('Moved consecrations to row', currentRow);
                currentRow++;
            } else {
                consecrationsField.style.display = 'none';
            }
        }
    }

    // Watch for papal name field and consecrations field visibility changes
    const papalObserver = new MutationObserver(adjustGridLayout);
    if (document.getElementById('papalNameField')) {
        papalObserver.observe(document.getElementById('papalNameField'), { 
            attributes: true, 
            attributeFilter: ['style'] 
        });
    }
    if (document.getElementById('consecrationsField')) {
        papalObserver.observe(document.getElementById('consecrationsField'), { 
            attributes: true, 
            attributeFilter: ['style'] 
        });
    }

    // Watch for rank changes to show/hide papal name field and consecrations
    const rankSelect = document.getElementById('rank');
    if (rankSelect) {
        rankSelect.addEventListener('change', function() {
            const papalField = document.getElementById('papalNameField');
            const consecrationsField = document.getElementById('consecrationsField');
            const selectedOption = this.options[this.selectedIndex];
            const rankValue = this.value.toLowerCase();
            const isBishop = selectedOption.getAttribute('data-is-bishop') === 'true';
            
            console.log('Rank changed:', rankValue, 'is_bishop:', isBishop);
            
            // Handle papal name field (only for pope)
            if (rankValue === 'pope') {
                if (papalField) papalField.style.display = 'block';
            } else {
                if (papalField) papalField.style.display = 'none';
            }
            
            // Handle consecrations field (for any rank with is_bishop flag)
            if (isBishop) {
                if (consecrationsField) consecrationsField.style.display = 'block';
            } else {
                if (consecrationsField) consecrationsField.style.display = 'none';
            }
            
            // Layout will be automatically adjusted by the MutationObserver
        });
    }

    // Initial layout adjustment
    adjustGridLayout();

    // Auto-toggle "deceased" status based on date of death
    const dateOfDeathInput = document.getElementById('date_of_death');
    if (dateOfDeathInput) {
        // Function to find and toggle the deceased status checkbox
        function updateDeceasedStatus() {
            // Find the deceased status checkbox
            // We need to search through all status checkboxes to find the one for "deceased"
            const statusCheckboxes = document.querySelectorAll('input[name="status_ids[]"]');
            let deceasedCheckbox = null;
            
            statusCheckboxes.forEach(checkbox => {
                const label = document.querySelector(`label[for="${checkbox.id}"]`);
                if (label && label.textContent.trim().toLowerCase() === 'deceased') {
                    deceasedCheckbox = checkbox;
                }
            });
            
            if (deceasedCheckbox) {
                // If there's a date of death, check the deceased status
                // If there's no date of death, uncheck it
                if (dateOfDeathInput.value && dateOfDeathInput.value.trim() !== '') {
                    deceasedCheckbox.checked = true;
                    console.log('Auto-checked deceased status due to date of death:', dateOfDeathInput.value);
                } else {
                    deceasedCheckbox.checked = false;
                    console.log('Auto-unchecked deceased status (no date of death)');
                }
            } else {
                console.warn('Deceased status checkbox not found');
            }
        }
        
        // Listen for changes to the date of death field
        dateOfDeathInput.addEventListener('change', updateDeceasedStatus);
        dateOfDeathInput.addEventListener('input', updateDeceasedStatus);
        
        // Also check on page load
        updateDeceasedStatus();
    }

    // Ordination and Consecration management (for embedded template)
    let ordinationCount = 1; // Start at 1 since we have a sample entry
    let consecrationCount = 1; // Start at 1 since we have a sample entry
    let coConsecratorCount = 1; // Counter for co-consecrators
    
    // Undo stacks for removed entries
    let removedOrdinations = [];
    let removedConsecrations = [];
    
    // Maximum number of co-consecrators allowed
    const MAX_CO_CONSECRATORS = 10;

    // Add ordination functionality (for embedded template)
    function addOrdination() {
        const container = document.getElementById('ordinationsContainer');
        if (!container) return;

        const ordinationHtml = `
            <div class="ordination-entry">// style="border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 4px; background: rgba(255, 255, 255, 0.05); padding: 0.75em; margin-bottom: 0.75em;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em; margin-bottom: 0.5em;">
                    <div>
                        <label style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.8em;">Date</label>
                        <input type="date" name="ordinations[${ordinationCount}][date]" style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.8em;">Ordaining Bishop</label>
                        <div style="position: relative;">
                            <input type="text" name="ordinations[${ordinationCount}][ordaining_bishop_input]" placeholder="Search for bishop..." autocomplete="off" style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white;">
                            <input type="hidden" name="ordinations[${ordinationCount}][ordaining_bishop_id]">
                            <div class="autocomplete-dropdown" style="position: absolute; top: 100%; left: 0; width: 100%; z-index: 20; display: none; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; max-height: 200px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em; margin-bottom: 0.5em;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5em; font-weight: 400; color: white; font-size: 0.8em;">Status</label>
                        <div style="display: flex; flex-direction: column; gap: 0.5em;">
                            <div style="display: flex; align-items: center; gap: 0.5em;">
                                <input type="checkbox" name="ordinations[${ordinationCount}][is_sub_conditione]" id="sub_conditione_${ordinationCount}" style="margin: 0;">
                                <label for="sub_conditione_${ordinationCount}" style="color: white; font-size: 0.8em; margin: 0; cursor: pointer;">Sub Conditione</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5em;">
                                <input type="checkbox" name="ordinations[${ordinationCount}][is_doubtful_event]" id="doubtful_event_${ordinationCount}" style="margin: 0;">
                                <label for="doubtful_event_${ordinationCount}" style="color: white; font-size: 0.8em; margin: 0; cursor: pointer;">Doubtful Event</label>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5em; font-weight: 400; color: white; font-size: 0.8em;">Validity</label>
                        <select name="ordinations[${ordinationCount}][validity]" style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white;">
                            <option value="valid">Valid</option>
                            <option value="doubtfully_valid">Doubtfully Valid</option>
                            <option value="invalid">Invalid</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.8em;">Notes</label>
                    <textarea name="ordinations[${ordinationCount}][notes]" rows="2" placeholder="Additional notes..." style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white; resize: vertical;"></textarea>
                </div>
                <div style="margin-top: 0.5em; text-align: right; display: flex; gap: 0.5em; justify-content: flex-end;">
                    <button type="button" class="remove-ordination" style="padding: 0.25em 0.5em; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; border-radius: 3px; cursor: pointer; font-size: 0.75em;">
                        Remove
                    </button>
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', ordinationHtml);
        ordinationCount++;
        
        // Initialize autocomplete for the new ordination fields
        const newOrdinationEntry = container.lastElementChild;
        if (newOrdinationEntry) {
            const newInput = newOrdinationEntry.querySelector('input[name*="ordaining_bishop_input"]');
            if (newInput) {
                initializeSingleClergyAutocomplete(newInput);
            }
        }
    }

    // Add consecration functionality (for embedded template)
    function addConsecration() {
        const container = document.getElementById('consecrationsContainer');
        if (!container) return;

        const consecrationHtml = `
            <div class="consecration-entry"> // style="border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 4px; background: rgba(255, 255, 255, 0.05); padding: 0.75em; margin-bottom: 0.75em;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em; margin-bottom: 0.5em;">
                    <div>
                        <label style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.8em;">Date</label>
                        <input type="date" name="consecrations[${consecrationCount}][date]" style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.8em;">Consecrator</label>
                        <div style="position: relative;">
                            <input type="text" name="consecrations[${consecrationCount}][consecrator_input]" placeholder="Search for consecrator..." autocomplete="off" style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white;">
                            <input type="hidden" name="consecrations[${consecrationCount}][consecrator_id]">
                            <div class="autocomplete-dropdown" style="position: absolute; top: 100%; left: 0; width: 100%; z-index: 20; display: none; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; max-height: 200px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 0.5em;">
                    <label style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.8em;">Co-Consecrators</label>
                    <div style="display: flex; gap: 0.5em; margin-bottom: 0.5em;">
                        <div style="position: relative; flex: 1;">
                            <input type="text" name="consecrations[${consecrationCount}][co_consecrators][0][input]" placeholder="Search for co-consecrator..." autocomplete="off" style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white;">
                            <input type="hidden" name="consecrations[${consecrationCount}][co_consecrators][0][id]">
                            <div class="autocomplete-dropdown" style="position: absolute; top: 100%; left: 0; width: 100%; z-index: 20; display: none; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; max-height: 200px; overflow-y: auto;"></div>
                        </div>
                        <button type="button" class="add-co-consecrator" style="padding: 0.4em 0.6em; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; border-radius: 3px; cursor: pointer; font-size: 0.75em;">
                            Add
                        </button>
                    </div>
                    <div class="co-consecrators-list">
                        <!-- Additional co-consecrators will be added here -->
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em; margin-bottom: 0.5em;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5em; font-weight: 400; color: white; font-size: 0.8em;">Status</label>
                        <div style="display: flex; flex-direction: column; gap: 0.5em;">
                            <div style="display: flex; align-items: center; gap: 0.5em;">
                                <input type="checkbox" name="consecrations[${consecrationCount}][is_sub_conditione]" id="consec_sub_conditione_${consecrationCount}" style="margin: 0;">
                                <label for="consec_sub_conditione_${consecrationCount}" style="color: white; font-size: 0.8em; margin: 0; cursor: pointer;">Sub Conditione</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5em;">
                                <input type="checkbox" name="consecrations[${consecrationCount}][is_doubtful_event]" id="consec_doubtful_event_${consecrationCount}" style="margin: 0;">
                                <label for="consec_doubtful_event_${consecrationCount}" style="color: white; font-size: 0.8em; margin: 0; cursor: pointer;">Doubtful Event</label>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5em; font-weight: 400; color: white; font-size: 0.8em;">Validity</label>
                        <select name="consecrations[${consecrationCount}][validity]" style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white;">
                            <option value="valid">Valid</option>
                            <option value="doubtfully_valid">Doubtfully Valid</option>
                            <option value="invalid">Invalid</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25em; font-weight: 400; color: white; font-size: 0.8em;">Notes</label>
                    <textarea name="consecrations[${consecrationCount}][notes]" rows="2" placeholder="Additional notes..." style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white; resize: vertical;"></textarea>
                </div>
                <div style="margin-top: 0.5em; text-align: right; display: flex; gap: 0.5em; justify-content: flex-end;">
                    <button type="button" class="remove-consecration" style="padding: 0.25em 0.5em; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; border-radius: 3px; cursor: pointer; font-size: 0.75em;">
                        Remove
                    </button>
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', consecrationHtml);
        consecrationCount++;
        
        // Initialize button visibility for the new consecration entry
        const newEntry = container.lastElementChild;
        if (newEntry) {
            updateAddCoConsecratorButton(newEntry);
            
            // Initialize autocomplete for the new consecration fields
            const consecratorInput = newEntry.querySelector('input[name*="consecrator_input"]');
            if (consecratorInput) {
                initializeSingleClergyAutocomplete(consecratorInput);
            }
            
            const coConsecratorInput = newEntry.querySelector('input[name*="co_consecrators"][name*="input"]');
            if (coConsecratorInput) {
                initializeSingleClergyAutocomplete(coConsecratorInput);
            }
        }
    }

    // Add co-consecrator functionality
    function addCoConsecrator(button) {
        const consecrationEntry = button.closest('.consecration-entry');
        if (!consecrationEntry) return;
        
        const coConsecratorsList = consecrationEntry.querySelector('.co-consecrators-list');
        if (!coConsecratorsList) return;
        
        // Check if we've reached the maximum
        const existingCoConsecrators = coConsecratorsList.querySelectorAll('.co-consecrator-item');
        if (existingCoConsecrators.length >= MAX_CO_CONSECRATORS) {
            alert(`Maximum of ${MAX_CO_CONSECRATORS} co-consecrators allowed.`);
            return;
        }
        
        // Get the consecration index from the form name
        const consecrationInput = consecrationEntry.querySelector('input[name*="consecrations["][name*="][date]"]');
        if (!consecrationInput) return;
        
        const nameMatch = consecrationInput.name.match(/consecrations\[(\d+)\]/);
        if (!nameMatch) return;
        
        const consecrationIndex = nameMatch[1];
        
        const coConsecratorHtml = `
            <div class="co-consecrator-item" style="display: flex; gap: 0.5em; margin-bottom: 0.5em; align-items: center;">
                <div style="position: relative; flex: 1;">
                    <input type="text" name="consecrations[${consecrationIndex}][co_consecrators][${coConsecratorCount}][input]" placeholder="Search for co-consecrator..." autocomplete="off" style="width: 100%; padding: 0.4em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); font-size: 0.8em; color: white;">
                    <input type="hidden" name="consecrations[${consecrationIndex}][co_consecrators][${coConsecratorCount}][id]">
                    <div class="autocomplete-dropdown" style="position: absolute; top: 100%; left: 0; width: 100%; z-index: 20; display: none; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; max-height: 200px; overflow-y: auto;"></div>
                </div>
                <button type="button" class="remove-co-consecrator" style="padding: 0.4em 0.6em; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; border-radius: 3px; cursor: pointer; font-size: 0.75em;">
                    Remove
                </button>
            </div>
        `;
        
        coConsecratorsList.insertAdjacentHTML('beforeend', coConsecratorHtml);
        coConsecratorCount++;
        
        // Initialize autocomplete for the new co-consecrator field
        const newCoConsecratorItem = coConsecratorsList.lastElementChild;
        if (newCoConsecratorItem) {
            const newInput = newCoConsecratorItem.querySelector('input[name*="co_consecrators"][name*="input"]');
            if (newInput) {
                initializeSingleClergyAutocomplete(newInput);
            }
        }
        
        // Update the "Add" button visibility
        updateAddCoConsecratorButton(consecrationEntry);
    }
    
    function updateAddCoConsecratorButton(consecrationEntry) {
        const coConsecratorsList = consecrationEntry.querySelector('.co-consecrators-list');
        const addButton = consecrationEntry.querySelector('.add-co-consecrator');
        
        if (!coConsecratorsList || !addButton) return;
        
        const existingCoConsecrators = coConsecratorsList.querySelectorAll('.co-consecrator-item');
        
        if (existingCoConsecrators.length >= MAX_CO_CONSECRATORS) {
            addButton.style.display = 'none';
        } else {
            addButton.style.display = 'inline-block';
        }
    }

    // Undo functionality
    function undoOrdination() {
        if (removedOrdinations.length > 0) {
            const lastRemoved = removedOrdinations.pop();
            const container = document.getElementById('ordinationsContainer');
            if (container) {
                container.insertAdjacentHTML('beforeend', lastRemoved);
            }
        }
    }

    function undoConsecration() {
        if (removedConsecrations.length > 0) {
            const lastRemoved = removedConsecrations.pop();
            const container = document.getElementById('consecrationsContainer');
            if (container) {
                container.insertAdjacentHTML('beforeend', lastRemoved);
            }
        }
    }

    // Event listeners for add/remove/undo buttons (for embedded template elements)
    // Use a single global event listener with proper delegation to avoid duplicates
    if (!window.clergyFormEmbeddedEventListenersAttached) {
        document.addEventListener('click', function(e) {
            // Only handle clicks within clergy forms to avoid conflicts
            if (!e.target.closest('form[id*="clergyForm"]') && !e.target.closest('#clergyFormContainer')) return;
            
            // Handle embedded template button clicks
            if (e.target && e.target.id === 'addOrdinationBtn') {
                e.preventDefault();
                e.stopPropagation();
                addOrdination();
            }
            if (e.target && e.target.id === 'addConsecrationBtn') {
                e.preventDefault();
                e.stopPropagation();
                addConsecration();
            }
            if (e.target && e.target.classList.contains('remove-ordination')) {
                e.preventDefault();
                e.stopPropagation();
                const entry = e.target.closest('.ordination-entry');
                if (entry) {
                    // Store for undo before removing
                    removedOrdinations.push(entry.outerHTML);
                    entry.remove();
                }
            }
            if (e.target && e.target.classList.contains('remove-consecration')) {
                e.preventDefault();
                e.stopPropagation();
                const entry = e.target.closest('.consecration-entry');
                if (entry) {
                    // Store for undo before removing
                    removedConsecrations.push(entry.outerHTML);
                    entry.remove();
                }
            }
            if (e.target && e.target.classList.contains('add-co-consecrator')) {
                e.preventDefault();
                e.stopPropagation();
                addCoConsecrator(e.target);
            }
            if (e.target && e.target.classList.contains('remove-co-consecrator')) {
                e.preventDefault();
                e.stopPropagation();
                const coConsecratorItem = e.target.closest('.co-consecrator-item');
                if (coConsecratorItem) {
                    coConsecratorItem.remove();
                    // Update the "Add" button visibility
                    const consecrationEntry = coConsecratorItem.closest('.consecration-entry');
                    if (consecrationEntry) {
                        updateAddCoConsecratorButton(consecrationEntry);
                    }
                }
            }
        });
        
        // Mark that event listeners have been attached
        window.clergyFormEmbeddedEventListenersAttached = true;
    }

    // Add undo buttons to the sections
    function addUndoButtons() {
        // Add undo button to ordinations section
        const ordinationsSection = document.querySelector('#ordinationsField h5');
        if (ordinationsSection && !document.getElementById('undoOrdinationsBtn')) {
            const undoBtn = document.createElement('button');
            undoBtn.id = 'undoOrdinationsBtn';
            undoBtn.type = 'button';
            undoBtn.textContent = 'Undo Last Removal';
            undoBtn.style.cssText = 'margin-left: 0.5em; padding: 0.3em 0.6em; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; border-radius: 3px; cursor: pointer; font-size: 0.75em; opacity: 0.7;';
            undoBtn.addEventListener('click', undoOrdination);
            ordinationsSection.appendChild(undoBtn);
        }

        // Add undo button to consecrations section
        const consecrationsSection = document.querySelector('#consecrationsField h5');
        if (consecrationsSection && !document.getElementById('undoConsecrationsBtn')) {
            const undoBtn = document.createElement('button');
            undoBtn.id = 'undoConsecrationsBtn';
            undoBtn.type = 'button';
            undoBtn.textContent = 'Undo Last Removal';
            undoBtn.style.cssText = 'margin-left: 0.5em; padding: 0.3em 0.6em; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; border-radius: 3px; cursor: pointer; font-size: 0.75em; opacity: 0.7;';
            undoBtn.addEventListener('click', undoConsecration);
            consecrationsSection.appendChild(undoBtn);
        }
    }

    // Add undo buttons when page loads
    addUndoButtons();
    
    // Initialize co-consecrator button visibility for existing entries
    document.addEventListener('DOMContentLoaded', function() {
        const existingConsecrationEntries = document.querySelectorAll('.consecration-entry');
        existingConsecrationEntries.forEach(entry => {
            updateAddCoConsecratorButton(entry);
        });
        
        // Initialize autocomplete for all clergy search fields
        initializeClergyAutocomplete();
    });
    
    // Add focus styles for form inputs
    const formInputs = document.querySelectorAll('#addOrganizationModal input, #addOrganizationModal textarea');
    formInputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.style.borderColor = '#667eea';
            this.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.1)';
        });
        input.addEventListener('blur', function() {
            this.style.borderColor = 'rgba(0, 0, 0, 0.2)';
            this.style.boxShadow = 'none';
        });
    });
    
    // Initialize clergy autocomplete functionality
    function initializeClergyAutocomplete() {
        console.log('Initializing clergy autocomplete...');
        
        // Find all clergy search input fields
        const clergyInputs = document.querySelectorAll('input[name*="ordaining_bishop_input"], input[name*="consecrator_input"], input[name*="co_consecrators"][name*="input"]');
        console.log('Found clergy inputs:', clergyInputs.length);
        
        clergyInputs.forEach((input, index) => {
            console.log(`Initializing input ${index + 1}:`, input.name, input.placeholder);
            initializeSingleClergyAutocomplete(input);
        });
        
        // Set up observer for dynamically added fields
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) { // Element node
                        const newInputs = node.querySelectorAll ? node.querySelectorAll('input[name*="ordaining_bishop_input"], input[name*="consecrator_input"], input[name*="co_consecrators"][name*="input"]') : [];
                        newInputs.forEach(input => {
                            if (!input.hasAttribute('data-autocomplete-initialized')) {
                                initializeSingleClergyAutocomplete(input);
                            }
                        });
                    }
                });
            });
        });
        
        // Observe the form container for new inputs
        const formContainer = document.getElementById('clergyForm');
        if (formContainer) {
            observer.observe(formContainer, { childList: true, subtree: true });
        }
    }
    
    // Initialize autocomplete for a single input field
    function initializeSingleClergyAutocomplete(input) {
        if (input.hasAttribute('data-autocomplete-initialized')) {
            console.log('Input already initialized:', input.name);
            return; // Already initialized
        }
        
        const dropdown = input.parentElement.querySelector('.autocomplete-dropdown');
        if (!dropdown) {
            console.log('No dropdown found for input:', input.name, input.parentElement);
            return;
        }
        
        console.log('Initializing autocomplete for:', input.name, 'with dropdown:', !!dropdown);
        input.setAttribute('data-autocomplete-initialized', 'true');
        
        input.addEventListener('input', function() {
            const query = this.value.trim();
            console.log('Input event for', this.name, 'query:', query);
            
            if (query.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            // Use HTMX to search for bishops
            if (typeof htmx !== 'undefined') {
                htmx.ajax('GET', `/api/search_bishops?q=${encodeURIComponent(query)}`, {
                    target: dropdown,
                    swap: 'innerHTML'
                }).then(() => {
                    // Attach click handlers after HTMX loads the content
                    attachDropdownClickHandlers(input, dropdown);
                });
            } else {
                // Fallback to fetch if HTMX not available
                fetch(`/api/search_bishops?q=${encodeURIComponent(query)}`)
                    .then(response => response.text())
                    .then(html => {
                        dropdown.innerHTML = html;
                        dropdown.style.display = 'block';
                        attachDropdownClickHandlers(input, dropdown);
                    })
                    .catch(error => {
                        console.error('Error fetching bishops:', error);
                    });
            }
            
            dropdown.style.display = 'block';
        });
        
        input.addEventListener('blur', function() {
            setTimeout(() => {
                dropdown.style.display = 'none';
            }, 200);
        });
        
        input.addEventListener('focus', function() {
            if (this.value.trim().length >= 2) {
                this.dispatchEvent(new Event('input'));
            }
        });
    }
    
    // Attach click handlers to dropdown items
    function attachDropdownClickHandlers(input, dropdown) {
        const results = dropdown.querySelectorAll('.bishop-search-result');
        results.forEach(result => {
            result.addEventListener('click', function() {
                const bishopId = this.dataset.id;
                const bishopName = this.dataset.displayName || this.dataset.name;
                
                // Set the input value and hidden field
                input.value = bishopName;
                const hiddenInput = input.parentElement.querySelector('input[type="hidden"]');
                if (hiddenInput) {
                    hiddenInput.value = bishopId;
                }
                
                dropdown.style.display = 'none';
            });
        });
    }

    // Add organization function (placeholder)
    window.addOrganization = function() {
        const name = document.getElementById('new-organization-name').value;
        const abbreviation = document.getElementById('new-organization-abbreviation').value;
        const description = document.getElementById('new-organization-description').value;
        
        if (!name.trim()) {
            alert('Organization name is required');
            return;
        }
        
        // TODO: Implement actual organization creation
        console.log('Adding organization:', { name, abbreviation, description });
        alert('Organization added: ' + name);
        hideModal();
    };
}

// Make the functions globally available
window.initializeEmbeddedFormScript = initializeEmbeddedFormScript;
window.initializeClergyAutocomplete = initializeClergyAutocomplete;
window.initializeSingleClergyAutocomplete = initializeSingleClergyAutocomplete;
// Note: clearFormState is now in clergy-form-state.js

// Initialize on DOMContentLoaded as fallback
document.addEventListener('DOMContentLoaded', function() {
    console.log('Embedded form script DOMContentLoaded fired');
    initializeEmbeddedFormScript();
});
</script>


{% if edit_mode and clergy %}
{% endif %}

<!-- Clergy Form Submission Handler - Embedded for self-contained functionality -->
<script>
// Overlay and progress bar functions - Global scope for accessibility
window.showFormSubmissionOverlay = function() {
    const form = document.getElementById('clergyForm');
    if (!form) return;
    
    // Try to find overlay in editor panel first
    let overlay = document.getElementById('formSubmissionOverlay');
    
    // If not found, create a temporary overlay
    if (!overlay) {
        // Find the form's parent container (could be modal-body, clergyFormContainer, or direct parent)
        const formContainer = form.closest('.modal-body') || 
                             form.closest('#clergyFormContainer') || 
                             form.closest('div[style*="position"]') ||
                             form.parentElement;
        
        if (formContainer) {
            // Ensure container has relative positioning
            const currentPosition = window.getComputedStyle(formContainer).position;
            if (currentPosition === 'static') {
                formContainer.style.position = 'relative';
            }
            
            overlay = document.createElement('div');
            overlay.id = 'formSubmissionOverlay';
            overlay.className = 'form-submission-overlay';
            overlay.innerHTML = `
                <div class="overlay-content">
                    <div class="spinner"></div>
                    <div class="overlay-title">Saving clergy record...</div>
                    <div class="progress-container">
                        <div id="formSubmissionProgressBar" class="progress-bar"></div>
                    </div>
                    <div id="formSubmissionProgressText" class="progress-text">0%</div>
                </div>
            `;
            formContainer.appendChild(overlay);
        }
    }
    
    if (overlay) {
        overlay.classList.add('active');
        window.updateFormSubmissionProgress(10, 'Preparing form data...');
    }
};

window.hideFormSubmissionOverlay = function() {
    const overlay = document.getElementById('formSubmissionOverlay');
    if (overlay) {
        overlay.classList.remove('active');
        window.updateFormSubmissionProgress(0, '');
    }
};

window.updateFormSubmissionProgress = function(percent, text) {
    const progressBar = document.getElementById('formSubmissionProgressBar');
    const progressText = document.getElementById('formSubmissionProgressText');
    
    if (progressBar) {
        progressBar.style.width = `${percent}%`;
    }
    
    if (progressText) {
        progressText.textContent = text || `${percent}%`;
    }
};

(function() {
    'use strict';
    
    // Note: Form submission is now handled by clergy-form-submission.js
    // This IIFE only handles initialization specific to the embedded template
    console.log('Clergy form embedded script loaded');
    
    // Notify UI system that form is ready
    if (typeof window.setModalState === 'function') {
        console.log('Notifying UI system that form is ready');
        window.setModalState(true);
    }
    
    // Local helper functions (these are also available globally via clergy-form-submission.js)
    // Keeping for backward compatibility
    function collectBishopNames(form) {
        const bishopNames = new Set();
        
        console.log('Collecting bishop names...');
        
        // Collect ordaining bishops
        const ordainingBishopInputs = form.querySelectorAll('input[name*="ordaining_bishop_input"]');
        console.log('Found ordaining bishop inputs:', ordainingBishopInputs.length);
        ordainingBishopInputs.forEach(input => {
            const name = input.value.trim();
            const idInput = input.parentElement.querySelector('input[name*="ordaining_bishop_id"]');
            const id = idInput ? idInput.value : '';
            console.log(`Ordaining bishop: "${name}", ID: "${id}"`);
            if (name && !id) {
                bishopNames.add(name);
                console.log(`Added to bishop names: "${name}"`);
            }
        });
        
        // Collect consecrators
        const consecratorInputs = form.querySelectorAll('input[name*="consecrator_input"]');
        console.log('Found consecrator inputs:', consecratorInputs.length);
        consecratorInputs.forEach(input => {
            const name = input.value.trim();
            const idInput = input.parentElement.querySelector('input[name*="consecrator_id"]');
            const id = idInput ? idInput.value : '';
            console.log(`Consecrator: "${name}", ID: "${id}"`);
            if (name && !id) {
                bishopNames.add(name);
                console.log(`Added to bishop names: "${name}"`);
            }
        });
        
        // Collect co-consecrators
        const coConsecratorInputs = form.querySelectorAll('input[name*="co_consecrators"][name*="input"]');
        console.log('Found co-consecrator inputs:', coConsecratorInputs.length);
        coConsecratorInputs.forEach(input => {
            const name = input.value.trim();
            const idInput = input.parentElement.querySelector('input[name*="id"]');
            const id = idInput ? idInput.value : '';
            console.log(`Co-consecrator: "${name}", ID: "${id}"`);
            if (name && !id) {
                bishopNames.add(name);
                console.log(`Added to bishop names: "${name}"`);
            }
        });
        
        const result = Array.from(bishopNames);
        console.log('Final bishop names to check:', result);
        return result;
    }
    
    function checkAndCreateBishops(bishopNames) {
        console.log(' Creating missing bishops:', bishopNames);
        return new Promise((resolve, reject) => {
            // Send AJAX request to check and create bishops
            fetch('/api/check-and-create-bishops', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    bishop_names: bishopNames
                })
            })
            .then(response => {
                console.log(' Bishop creation response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(' Bishop creation response:', data);
                if (data.success) {
                    console.log(' Successfully created bishops, updating form with IDs');
                    // Update form with the created bishop IDs
                    updateFormWithBishopIds(data.bishop_mapping);
                    resolve();
                } else {
                    reject(new Error(data.message || 'Failed to create bishops'));
                }
            })
            .catch(error => {
                console.error(' Error creating bishops:', error);
                reject(error);
            });
        });
    }
    
    function updateFormWithBishopIds(bishopMapping) {
        const form = document.getElementById('clergyForm');
        if (!form) return;
        
        console.log(' Updating form with bishop IDs:', bishopMapping);
        
        // Update ordaining bishops
        const ordainingBishopInputs = form.querySelectorAll('input[name*="ordaining_bishop_input"]');
        ordainingBishopInputs.forEach(input => {
            const name = input.value.trim();
            if (bishopMapping[name]) {
                const idInput = input.parentElement.querySelector('input[name*="ordaining_bishop_id"]');
                if (idInput) {
                    idInput.value = bishopMapping[name];
                    console.log(` Updated ordaining bishop "${name}" with ID: ${bishopMapping[name]}`);
                } else {
                    console.warn(` No ID input found for ordaining bishop "${name}"`);
                }
            }
        });
        
        // Update consecrators
        const consecratorInputs = form.querySelectorAll('input[name*="consecrator_input"]');
        consecratorInputs.forEach(input => {
            const name = input.value.trim();
            if (bishopMapping[name]) {
                const idInput = input.parentElement.querySelector('input[name*="consecrator_id"]');
                if (idInput) {
                    idInput.value = bishopMapping[name];
                    console.log(` Updated consecrator "${name}" with ID: ${bishopMapping[name]}`);
                } else {
                    console.warn(` No ID input found for consecrator "${name}"`);
                }
            }
        });
        
        // Update co-consecrators
        const coConsecratorInputs = form.querySelectorAll('input[name*="co_consecrators"][name*="input"]');
        coConsecratorInputs.forEach(input => {
            const name = input.value.trim();
            if (bishopMapping[name]) {
                const idInput = input.parentElement.querySelector('input[name*="id"]');
                if (idInput) {
                    idInput.value = bishopMapping[name];
                    console.log(` Updated co-consecrator "${name}" with ID: ${bishopMapping[name]}`);
                } else {
                    console.warn(` No ID input found for co-consecrator "${name}"`);
                }
            }
        });
        
        console.log(' Form update with bishop IDs complete');
    }
    
    // Note: clearFormCompletely, submitForm, and resetSubmitButton are now in separate JS files
    // (clergy-form-state.js and clergy-form-submission.js)
    // They're available globally via window object

    // Initialize drag and drop functionality for photo upload
    if (!window.clergyFormEmbeddedDragDropInitialized) {
        function initEmbeddedDragDrop() {
            console.log('Initializing drag and drop for embedded clergy form...');
            const photoContainer = document.getElementById('photoContainer');
            const fileInput = document.getElementById('clergyImage');
            const uploadBtn = document.getElementById('uploadBtn');
            
            console.log('Embedded elements found:', { photoContainer, fileInput, uploadBtn });
            
            if (photoContainer && fileInput) {
                console.log('Setting up direct embedded drag and drop handlers...');
                
                // Direct drag and drop handlers
                photoContainer.addEventListener('dragenter', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Embedded direct dragenter');
                    this.classList.add('drag-over');
                }, true);
                
                photoContainer.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.dataTransfer.dropEffect = 'copy';
                    console.log('Embedded direct dragover');
                }, true);
                
                photoContainer.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Embedded direct dragleave');
                    this.classList.remove('drag-over');
                }, true);
                
                photoContainer.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Embedded direct drop event');
                    this.classList.remove('drag-over');
                    
                    const files = e.dataTransfer.files;
                    console.log('Embedded files dropped:', files.length);
                    
                    if (files.length > 0) {
                        const file = files[0];
                        console.log('Embedded processing file:', file.name, file.type, file.size);
                        
                        if (file.type.startsWith('image/')) {
                            // Store the file globally for form submission
                            window.droppedFile = file;
                            console.log('File stored globally:', file.name, file.size, file.type);
                            
                            // Try to set the file in the input element
                            try {
                                const dataTransfer = new DataTransfer();
                                dataTransfer.items.add(file);
                                fileInput.files = dataTransfer.files;
                                console.log('File set in input element using DataTransfer');
                            } catch (error) {
                                console.error('Error setting file in input:', error);
                                console.log('File will be handled manually during form submission');
                            }
                            
                            // Store the file globally for form submission
                            window.droppedFile = file;
                            console.log('Embedded file stored globally:', file.name, file.size, file.type);
                            
                            // Try to set the file in the input element
                            try {
                                const dataTransfer = new DataTransfer();
                                dataTransfer.items.add(file);
                                fileInput.files = dataTransfer.files;
                                console.log('Embedded file set in input element');
                                
                                // Trigger the image editor if available
                                if (window.imageEditor && typeof window.imageEditor.handleFormImageUpload === 'function') {
                                    console.log('Using image editor for embedded...');
                                    const syntheticEvent = {
                                        target: fileInput,
                                        preventDefault: function() {},
                                        stopPropagation: function() {}
                                    };
                                    window.imageEditor.handleFormImageUpload(syntheticEvent);
                                } else {
                                    console.log('Using fallback preview for embedded...');
                                    const reader = new FileReader();
                                    reader.onload = function(e) {
                                        const imagePreview = document.getElementById('imagePreview');
                                        if (imagePreview) {
                                            imagePreview.innerHTML = `
                                                <img src="${e.target.result}" alt="Preview" id="previewImage" 
                                                     style="max-width: 100px; max-height: 100px; border-radius: 4px; object-fit: cover;">
                                            `;
                                        }
                                    };
                                    reader.readAsDataURL(file);
                                }
                            } catch (error) {
                                console.error('Embedded error processing file:', error);
                            }
                        } else {
                            console.log('Embedded not an image file');
                            alert('Please select an image file.');
                        }
                    }
                }, true);
                
                console.log('Embedded direct drag and drop handlers set up successfully');
            } else {
                console.log('Embedded drag and drop initialization failed - missing elements');
            }
        }
        
        // Try to initialize immediately
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initEmbeddedDragDrop);
        } else {
            // Use setTimeout to ensure other scripts have loaded
            setTimeout(initEmbeddedDragDrop, 100);
        }
        
        // Mark that drag drop has been initialized
        window.clergyFormEmbeddedDragDropInitialized = true;
    }
})();
</script>

{% endmacro %}

<!-- Public API for pre-filling the form -->
<script>
// Make the pre-fill function globally available for external use
window.prefillClergyForm = function(clergyData) {
    if (window.ClergyForm && window.ClergyForm.prefillForm) {
        window.ClergyForm.prefillForm(clergyData);
    } else {
        console.warn('ClergyForm not yet initialized. Please wait for DOMContentLoaded.');
    }
};

// Also make it available on the ClergyForm namespace
window.ClergyForm.prefillFormPublic = window.prefillClergyForm;
</script>
