{% extends "base.html" %}

{% block title %}Add Clergy - Ecclesiastical Lineage{% endblock %}

{% block full_content %}
    <div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0">Add New Clergy</h1>
    </div>

    {% from '_clergy_form.html' import clergy_form %}
    {{ clergy_form({
        'ranks': ranks,
        'organizations': organizations,
        'cancel_url': url_for('clergy.clergy_list')
    }, edit_mode=False, user=None) }}

{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="/static/css/visualizer.css">
<link rel="stylesheet" href="/static/css/clergyForm.css">
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/fuzzySearch.js"></script>
<script>
    window.allClergy = {{ all_clergy_data | tojson | safe }};
    window.allBishops = {{ all_bishops_suggested | tojson | safe }};
</script>
<script src="/static/js/modalClergy.js"></script>
<script>
// Temporal filtering function for bishops
function filterBishopsByTemporalLogic(bishops, ordinationDate, consecrationDate) {
    return bishops.filter(bishop => {
        // Helper function to check if a bishop was valid on a given date
        function wasBishopOn(bishop, date) {
            if (!date) return true;
            
            // Parse the date
            const checkDate = new Date(date);
            
            // Check if they were alive on that date
            if (bishop.date_of_birth) {
                const birthDate = new Date(bishop.date_of_birth);
                if (checkDate < birthDate) return false;
            }
            
            if (bishop.date_of_death) {
                const deathDate = new Date(bishop.date_of_death);
                if (checkDate > deathDate) return false;
            }
            
            // Check if they were already a bishop on that date
            if (bishop.date_of_consecration) {
                const consecrationDate = new Date(bishop.date_of_consecration);
                if (checkDate < consecrationDate) return false;
            }
            
            return true;
        }
        
        // Check ordination date
        if (ordinationDate && !wasBishopOn(bishop, ordinationDate)) {
            return false;
        }
        
        // Check consecration date
        if (consecrationDate && !wasBishopOn(bishop, consecrationDate)) {
            return false;
        }
        
        return true;
    });
}

// Function to update bishop dropdowns when dates change
function updateBishopDropdowns() {
    const ordinationDate = document.getElementById('date_of_ordination').value;
    const consecrationDate = document.getElementById('date_of_consecration').value;
    
    // Filter bishops based on temporal logic
    const filteredBishops = filterBishopsByTemporalLogic(window.allBishops, ordinationDate, consecrationDate);
    
    // Update the autocomplete with filtered bishops
    const ordInput = document.getElementById('ordaining_bishop_search');
    const ordHidden = document.getElementById('ordaining_bishop_id');
    const ordDropdown = document.getElementById('ordainingBishopDropdown');
    
    if (ordInput && ordHidden && ordDropdown) {
        // Re-attach autocomplete with filtered data
        window.attachAutocomplete(
            ordInput,
            ordHidden,
            ordDropdown,
            filteredBishops,
            b => b.name,
            b => b.id
        );
    }
    
    const consInput = document.getElementById('consecrator_search');
    const consHidden = document.getElementById('consecrator_id');
    const consDropdown = document.getElementById('consecratorDropdown');
    
    if (consInput && consHidden && consDropdown) {
        // Re-attach autocomplete with filtered data
        window.attachAutocomplete(
            consInput,
            consHidden,
            consDropdown,
            filteredBishops,
            b => b.name,
            b => b.id
        );
    }
}

// Add event listeners for date changes
document.addEventListener('DOMContentLoaded', function() {
    const ordinationDateField = document.getElementById('date_of_ordination');
    const consecrationDateField = document.getElementById('date_of_consecration');
    
    if (ordinationDateField) {
        ordinationDateField.addEventListener('change', updateBishopDropdowns);
    }
    
    if (consecrationDateField) {
        consecrationDateField.addEventListener('change', updateBishopDropdowns);
    }
    
    // Initialize bishop dropdowns
    updateBishopDropdowns();
});

function openAddOrganizationModal() {
    const modal = new bootstrap.Modal(document.getElementById('addOrganizationModal'));
    modal.show();
}

function addOrganization() {
    const name = document.getElementById('new-organization-name').value.trim();
    const abbreviation = document.getElementById('new-organization-abbreviation').value.trim();
    const description = document.getElementById('new-organization-description').value.trim();
    
    if (!name) {
        alert('Please enter an organization name.');
        return;
    }
    
    fetch('/metadata/organization/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            name: name,
            abbreviation: abbreviation,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addOrganizationModal'));
            modal.hide();
            
            // Reset form
            document.getElementById('addOrganizationForm').reset();
            
            // Reload page to show new organization in dropdown
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while adding the organization.');
    });
}
</script>
{% endblock %} 