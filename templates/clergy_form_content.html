<!-- Clergy Form Content (Non-Macro Version) -->
{# Auto-generate form action if not provided #}
{% set form_action = fields.form_action if fields.form_action else (
    url_for('clergy.edit_clergy', clergy_id=clergy.id) if edit_mode and clergy else
    url_for('lineage_api.add_clergy_from_lineage') if context_type else
    url_for('clergy.add_clergy')
) %}

<div class="form-wrapper">
    <div class="form-header">
        <h2 class="form-title">{% if edit_mode %}Edit {{ clergy.name }}{% else %}Add New Clergy{% endif %}</h2>
    </div>
    <div class="form-content">
        <form id="clergyForm" method="POST" action="{{ form_action }}" enctype="multipart/form-data">
            
            <!-- Hidden fields to preserve context -->
            {% if context_type %}
            <input type="hidden" name="context_type" value="{{ context_type }}">
            {% endif %}
            {% if context_clergy_id %}
            <input type="hidden" name="context_clergy_id" value="{{ context_clergy_id }}">
            {% endif %}
            
            <!-- Dynamic Form Layout with Explicit Grid Positioning -->
            <div class="form-container">
                <!-- Main Form Grid: 2 columns, auto rows -->
                <div class="form-grid">
                    
                    <!-- Row 1: Name (spans 2 columns) -->
                    <div id="nameField" class="form-field full-width">
                        <label for="name" class="form-label required">Full Name</label>
                        <input type="text" id="name" name="name" 
                               value="{{ clergy.name if edit_mode and clergy else '' }}" required>
                    </div>

                    <!-- Row 2: Papal Name Field (conditional, spans 2 columns) -->
                    <div id="papalNameField" class="form-field full-width" style="display: none;">
                        <label for="papal_name" class="form-label">Papal Name</label>
                        <input type="text" id="papal_name" name="papal_name" 
                               value="{{ clergy.papal_name if edit_mode and clergy else '' }}" 
                               placeholder="e.g., Pope Francis, Pope Benedict XVI">
                    </div>

                    <!-- Row 3: Organization (spans 2 columns) -->
                    <div id="organizationField" class="form-field full-width">
                        <label for="organization" class="form-label">Organization</label>
                        <div class="organization-input-group">
                            <select id="organization" name="organization">
                                <option value="">Select Organization</option>
                                {% for org in fields.organizations %}
                                <option value="{{ org.name }}" {% if clergy and clergy.organization == org.name %}selected{% endif %}>
                                    {{ org.name }}{% if org.abbreviation %} ({{ org.abbreviation }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" onclick="showOrganizationModal()" class="btn-add">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                    </div>

                    <!-- Rows 4-6, Col 1: Photo Section (spans 3 rows) -->
                    <div id="photoField" class="photo-section">
                        <label class="form-label">Photo</label>
                        <div id="photoContainer" class="photo-container drag-drop-container">
                            <div id="imagePreview">
                                {% if edit_mode and clergy and clergy.image_data %}
                                    {% set image_data = clergy.image_data | from_json %}
                                    {% if image_data %}
                                        {# Always use detail for preview, but original for editing #}
                                        {% set preview_url = image_data.detail if image_data.detail else (image_data.lineage if image_data.lineage else image_data.original) %}
                                        {% set original_url = image_data.original if image_data.original else (clergy.image_url if clergy.image_url else '') %}
                                        <img src="{{ preview_url }}" alt="{{ clergy.name }}" id="previewImage"
                                             data-original-image="{{ original_url }}"
                                             data-clergy-id="{{ clergy.id }}"
                                             data-object-key="{{ image_data.metadata.object_key if image_data.metadata and image_data.metadata.object_key else '' }}">
                                    {% endif %}
                                {% elif clergy.image_url %}
                                    {# Fallback: use image_url as both preview and original #}
                                    <img src="{{ clergy.image_url }}" alt="{{ clergy.name }}" id="previewImage"
                                         data-original-image="{{ clergy.image_url }}"
                                         data-clergy-id="{{ clergy.id }}"
                                         data-object-key="">
                                {% elif edit_mode and clergy and clergy.image_url %}
                                    <img src="{{ clergy.image_url }}" alt="{{ clergy.name }}" id="previewImage"
                                         data-original-image="{{ clergy.image_url }}"
                                         data-clergy-id="{{ clergy.id }}"
                                         data-object-key="">
                                {% else %}
                                    <div id="noPhotoPlaceholder" class="image-placeholder">
                                        <i class="fas fa-user"></i>
                                    </div>
                                {% endif %}
                                
                                <!-- Overlay controls positioned at bottom of image -->
                                <div class="image-controls">
                                    <input type="file" id="clergyImage" name="clergy_image" accept="image/*" style="display: none;">
                                    <button type="button" class="btn btn-upload" id="uploadBtn" title="Upload Image">
                                        <i class="fas fa-upload"></i>
                                    </button>
                                    <button type="button" class="btn btn-crop" id="cropExistingBtn" title="Edit Image" style="display: none;">
                                        <i class="fas fa-crop"></i>
                                    </button>
                                    <button type="button" class="btn btn-remove" id="removeImageBtn" title="Remove Image" style="display: none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Row 4, Col 2: Rank -->
                    <div id="rankField" class="form-field">
                        <label for="rank" class="form-label">Rank *</label>
                        <select id="rank" name="rank" required>
                            <option value="">Select Rank</option>
                            {% for rank in fields.ranks %}
                            <!-- DEBUG: rank.name={{ rank.name }}, rank.is_bishop={{ rank.is_bishop }} -->
                            <option value="{{ rank.name }}" data-is-bishop="{{ 'true' if rank.is_bishop else 'false' }}" {% if edit_mode and clergy and clergy.rank == rank.name %}selected{% endif %}>
                                {{ rank.name }} ({{ 'Bishop' if rank.is_bishop else 'Not Bishop' }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Row 5, Col 2: Date of Birth -->
                    <div id="birthField" class="form-field">
                        <label for="date_of_birth" class="form-label">Date of Birth</label>
                        <input type="date" id="date_of_birth" name="date_of_birth" 
                               value="{{ clergy.date_of_birth.strftime('%Y-%m-%d') if edit_mode and clergy and clergy.date_of_birth else '' }}">
                    </div>

                    <!-- Row 6, Col 2: Date of Death -->
                    <div id="deathField" class="form-field">
                        <label for="date_of_death" class="form-label">Date of Death</label>
                        <input type="date" id="date_of_death" name="date_of_death" 
                               value="{{ clergy.date_of_death.strftime('%Y-%m-%d') if edit_mode and clergy and clergy.date_of_death else '' }}">
                    </div>

                    <!-- Row 7: Notes (spans 2 columns) -->
                    <div id="notesField" class="form-field">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea id="notes" name="notes" rows="3" 
                                  placeholder="Additional notes about this clergy member...">{{ clergy.notes if edit_mode and clergy else '' }}</textarea>
                    </div>

                    <!-- Row 8: Ordinations Section (spans 2 columns) -->
                    <div id="ordinationsField" class="form-section">
                        <h5>
                            <i class="fas fa-hands-praying"></i> Ordinations
                        </h5>
                        <div>
                            <div>
                                <button type="button" id="addOrdinationBtn">
                                    <i class="fas fa-plus"></i>Add Ordination
                                </button>
                            </div>
                            
                            <div id="ordinationsContainer">
                                <!-- Dynamic ordination sections will be added here -->
                            </div>
                        </div>
                    </div>

                    <!-- Row 9: Consecrations Section (spans 2 columns, conditional) -->
                    <div id="consecrationsField" class="form-section" {% if not (edit_mode and clergy and clergy.rank and clergy.rank.lower() in ['bishop', 'archbishop', 'cardinal', 'pope']) %}style="display: none;"{% endif %}>
                        <h5>
                            <i class="fas fa-crown"></i> Consecrations
                        </h5>
                        <div>
                            <div>
                                <button type="button" id="addConsecrationBtn">
                                    <i class="fas fa-plus"></i>Add Consecration
                                </button>
                            </div>
                            
                            <div id="consecrationsContainer">
                                <!-- Dynamic consecration sections will be added here -->
                            </div>
                        </div>
                    </div>

                    <!-- Row 10: Status Indicators Section (spans 2 columns) -->
                    {% if fields.statuses %}
                    <div id="statusField" class="form-section" style="grid-column: 1 / -1;">
                        <h5 style="margin: 0 0 0.75em 0; color: rgba(255, 255, 255, 0.9); font-size: 0.9em; font-weight: 500;">
                            <i class="fas fa-flag"></i> Status Indicators
                        </h5>
                        <div style="padding: 1em; border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 4px; background: rgba(255, 255, 255, 0.03);">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75em;">
                                {% for status in fields.statuses %}
                                <div class="status-toggle-item" style="display: flex; align-items: center; gap: 0.5em; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 4px; background: rgba(255, 255, 255, 0.03);">
                                    <input type="checkbox" 
                                           id="status_{{ status.id }}" 
                                           name="status_ids[]" 
                                           value="{{ status.id }}"
                                           {% if edit_mode and clergy and status in clergy.statuses %}checked{% endif %}
                                           style="margin: 0; cursor: pointer;">
                                    <label for="status_{{ status.id }}" style="margin: 0; cursor: pointer; display: flex; align-items: center; gap: 0.4em; flex: 1; color: rgba(255, 255, 255, 0.9); font-size: 0.85em;">
                                        <i class="fas {{ status.icon }}" style="color: {{ status.color }}; font-size: 0.9em;"></i>
                                        <span>{{ status.name|title }}</span>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            <small style="display: block; margin-top: 0.75em; font-size: 0.75em; color: rgba(255, 255, 255, 0.6);">
                                <i class="fas fa-info-circle"></i> Select any applicable status indicators for this clergy member. Multiple statuses can be selected.
                            </small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Admin Controls -->
            {% if edit_mode and clergy and user and user.can_edit_clergy() %}
            <div class="admin-controls" style="margin-top: 1.5em; padding: 1em 0; border-top: 1px solid rgba(255, 255, 255, 0.15);">
                <h6 style="margin: 0 0 0.75em 0; color: rgba(255, 255, 255, 0.8); font-size: 0.9em; font-weight: 500; display: flex; align-items: center; gap: 0.5em;">
                    <i class="fas fa-cog" style="opacity: 0.7;"></i> Administrative Controls
                </h6>
                <div style="margin-bottom: 0.5em;">
                    <label style="display: flex; align-items: center; gap: 0.5em; cursor: pointer; color: rgba(255, 255, 255, 0.8); font-size: 0.85em;">
                        <input type="checkbox" id="mark_deleted" name="mark_deleted" value="1" 
                               {% if clergy.is_deleted %}checked{% endif %}
                               style="margin: 0;">
                        <span>Mark this record as deleted</span>
                    </label>
                </div>
                <small style="color: rgba(255, 255, 255, 0.6); font-size: 0.75em; display: block; margin-bottom: 0.5em; line-height: 1.4;">
                    This will hide the record from normal views but keep it in the database for audit purposes. 
                    You can uncheck this to restore the record.
                </small>
                {% if clergy.is_deleted %}
                <div style="margin-top: 0.75em; padding: 0.75em; background: rgba(255, 100, 100, 0.08); border-left: 3px solid rgba(255, 100, 100, 0.4);">
                    <small style="color: rgba(255, 150, 150, 0.9); font-size: 0.75em;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 0.5em;"></i> 
                        Record was marked as deleted on: {{ clergy.deleted_at.strftime('%Y-%m-%d %H:%M:%S') if clergy.deleted_at else 'Unknown date' }}
                    </small>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Form Actions -->
            <div class="form-actions" style="display: flex; gap: 0.75em; justify-content: flex-end; margin-top: 1.5em; padding-top: 1em; border-top: 1px solid rgba(255, 255, 255, 0.15);">
                <a href="{{ url_for('clergy.clergy_list') }}" id="cancel-btn"
                   style="padding: 0.6em 1.2em; border: 1px solid rgba(255, 255, 255, 0.25); background: rgba(255, 255, 255, 0.08); border-radius: 4px; cursor: pointer; font-weight: 400; color: rgba(255, 255, 255, 0.8); text-decoration: none; display: inline-block; font-size: 0.85em;">
                    <i class="fas fa-times" style="margin-right: 0.5em;"></i>Cancel
                </a>
                <button type="submit"
                        style="padding: 0.6em 1.2em; border: 1px solid rgba(76, 175, 80, 0.4); background: rgba(76, 175, 80, 0.15); color: white; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 0.85em;">
                    <i class="fas fa-save" style="margin-right: 0.5em;"></i>{% if edit_mode %}Save Changes{% else %}Save Clergy Record{% endif %}
                </button>
            </div>
    </form>
</div>

<!-- Image Editor Modal -->
{% include '_image_editor_modal.html' %}
</div>

<!-- JavaScript for form functionality -->
<script>
console.log('ðŸŽ¯ CONTENT TEMPLATE LOADED: clergy_form_content.html');

// Immediate execution for HTMX loaded content
console.log('ðŸŽ¯ CONTENT TEMPLATE: Running immediate initialization');
adjustFormLayout();
initializeFormFromRank();
initializeClergyAutocomplete();
attachRankChangeListener(); // Attach rank change listener for HTMX-loaded content

// Additional check to ensure consecration field is shown for bishops
setTimeout(() => {
    console.log('ðŸ” IMMEDIATE CHECK: Starting immediate consecration field check');
    const rankSelect = document.getElementById('rank');
    const consecrationsField = document.getElementById('consecrationsField');
    
    console.log('ðŸ” IMMEDIATE CHECK: rankSelect found =', !!rankSelect);
    console.log('ðŸ” IMMEDIATE CHECK: consecrationsField found =', !!consecrationsField);
    
    if (rankSelect && consecrationsField) {
        const selectedOption = rankSelect.options[rankSelect.selectedIndex];
        const isBishop = selectedOption && selectedOption.getAttribute('data-is-bishop') === 'true';
        
        console.log('ðŸ” IMMEDIATE CHECK: Checking bishop status:', {
            rankValue: rankSelect.value,
            isBishop: isBishop,
            consecrationsField: !!consecrationsField,
            selectedOption: selectedOption ? selectedOption.textContent : 'none',
            dataAttribute: selectedOption ? selectedOption.getAttribute('data-is-bishop') : 'none'
        });
        
        if (isBishop) {
            consecrationsField.style.display = 'block';
            console.log('ðŸ” IMMEDIATE CHECK: âœ… Showing consecrations field for bishop rank');
            
            // Also try to populate consecrations immediately
            {% if edit_mode and clergy %}
            console.log('ðŸ” IMMEDIATE CHECK: About to call populateExistingConsecrations() from immediate check');
            populateExistingConsecrations();
            {% endif %}
        } else {
            console.log('ðŸ” IMMEDIATE CHECK: âŒ Not a bishop rank, not showing consecrations field');
        }
    } else {
        console.log('ðŸ” IMMEDIATE CHECK: âŒ Missing required elements - rankSelect:', !!rankSelect, 'consecrationsField:', !!consecrationsField);
    }
}, 50);

console.log('ðŸŽ¯ CONTENT TEMPLATE: Immediate initialization completed');

// Fallback: If consecrations field is already visible (server-side), populate consecrations immediately
{% if edit_mode and clergy %}
setTimeout(() => {
    const consecrationsField = document.getElementById('consecrationsField');
    if (consecrationsField && consecrationsField.style.display !== 'none' && consecrationsField.style.display !== '') {
        console.log('ðŸ” FALLBACK: Consecrations field is already visible, populating consecrations');
        populateExistingConsecrations();
    }
}, 200);
{% endif %}

// Also listen for DOMContentLoaded (in case it's not HTMX loaded)
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸŽ¯ CONTENT TEMPLATE: DOMContentLoaded event fired');
    console.log('ðŸŽ¯ CONTENT TEMPLATE: About to call initializeFormFromRank');
    // Immediate initialization - no delays needed
    adjustFormLayout();
    initializeFormFromRank();
    initializeClergyAutocomplete();
    attachRankChangeListener(); // Attach rank change listener for DOM-loaded content
    
    // Additional check to ensure consecration field is shown for bishops
    setTimeout(() => {
        const rankSelect = document.getElementById('rank');
        const consecrationsField = document.getElementById('consecrationsField');
        
        if (rankSelect && consecrationsField) {
            const selectedOption = rankSelect.options[rankSelect.selectedIndex];
            const isBishop = selectedOption && selectedOption.getAttribute('data-is-bishop') === 'true';
            
            console.log('Content template timeout: Checking bishop status:', {
                rankValue: rankSelect.value,
                isBishop: isBishop,
                consecrationsField: !!consecrationsField
            });
            
            if (isBishop) {
                consecrationsField.style.display = 'block';
                console.log('Content template timeout: âœ… Showing consecrations field for bishop rank');
            }
        }
    }, 50);
    
    console.log('ðŸŽ¯ CONTENT TEMPLATE: initializeFormFromRank completed');
});

// Reset population flags when form is cleared or clergy changes
function resetPopulationFlags() {
    const ordinationsContainer = document.getElementById('ordinationsContainer');
    const consecrationsContainer = document.getElementById('consecrationsContainer');
    
    if (ordinationsContainer) {
        ordinationsContainer.removeAttribute('data-ordinations-populated');
    }
    if (consecrationsContainer) {
        consecrationsContainer.removeAttribute('data-consecrations-populated');
    }
}

// Check if we're switching to a different clergy record
function isClergySwitching() {
    // Use currentSelectedClergyId as single source of truth
    if (typeof window.currentSelectedClergyId === 'undefined') {
        window.currentSelectedClergyId = null;
    }
    
    {% if edit_mode and clergy %}
    const newClergyId = {{ clergy.id }};
    const oldClergyId = window.currentSelectedClergyId;
    const isSwitching = window.currentSelectedClergyId !== newClergyId;
    if (isSwitching) {
        window.currentSelectedClergyId = newClergyId;
        return true;
    }
    return false;
    {% else %}
    // For new clergy (not edit mode), always reset
    const oldClergyId = window.currentSelectedClergyId;
    const isSwitching = window.currentSelectedClergyId !== null;
    if (isSwitching) {
        window.currentSelectedClergyId = null;
        return true;
    }
    return false;
    {% endif %}
}

// Initialize form fields based on existing rank data
function initializeFormFromRank() {
    console.log('ðŸ”§ INIT: initializeFormFromRank called');
    
    // Only reset population flags if we're switching to a different clergy record
    const switching = isClergySwitching();
    if (switching) {
        console.log('ðŸ”§ INIT: Switching clergy, resetting population flags');
        resetPopulationFlags();
    }
    
    const rankSelect = document.getElementById('rank');
    console.log('ðŸ”§ INIT: rankSelect found:', !!rankSelect);
    
    if (!rankSelect || !rankSelect.value) {
        console.log('ðŸ”§ INIT: No rank select or no value, returning');
        return;
    }
    
    console.log('ðŸ”§ INIT: rankSelect.value:', rankSelect.value);
    const selectedOption = rankSelect.options[rankSelect.selectedIndex];
    const rankValue = rankSelect.value.toLowerCase();
    const isBishop = selectedOption.getAttribute('data-is-bishop') === 'true';
    
    console.log('ðŸ”§ INIT: rankValue:', rankValue, 'isBishop:', isBishop);
    console.log('ðŸ”§ INIT: selectedOption:', selectedOption);
    console.log('ðŸ”§ INIT: data-is-bishop attribute:', selectedOption.getAttribute('data-is-bishop'));
    console.log('ðŸ”§ INIT: All rank options:');
    for (let i = 0; i < rankSelect.options.length; i++) {
        const option = rankSelect.options[i];
        console.log(`  Option ${i}: value="${option.value}", data-is-bishop="${option.getAttribute('data-is-bishop')}", text="${option.textContent}"`);
    }
    
    // Debug: Log the actual HTML of the select element
    console.log('ðŸ”§ INIT: Select element HTML:', rankSelect.outerHTML);
    
    const papalField = document.getElementById('papalNameField');
    const consecrationsField = document.getElementById('consecrationsField');
    
    console.log('ðŸ”§ INIT: papalField found:', !!papalField);
    console.log('ðŸ”§ INIT: consecrationsField found:', !!consecrationsField);
    
    // Show papal name field if rank is Pope
    if (rankValue === 'pope' && papalField) {
        papalField.style.display = 'block';
        console.log('âœ… Showing papal name field for Pope rank');
    }
    
    // Show consecrations field if rank is Bishop
    console.log('ðŸ” CONSECRATION FIELD DEBUG: Checking if should show consecrations field');
    console.log('ðŸ” CONSECRATION FIELD DEBUG: isBishop =', isBishop);
    console.log('ðŸ” CONSECRATION FIELD DEBUG: consecrationsField exists =', !!consecrationsField);
    console.log('ðŸ” CONSECRATION FIELD DEBUG: edit_mode = {{ edit_mode|lower }}');
    console.log('ðŸ” CONSECRATION FIELD DEBUG: clergy exists = {{ (clergy is defined and clergy)|lower }}');
    
    if (isBishop && consecrationsField) {
        consecrationsField.style.display = 'block';
        console.log('âœ… Showing consecrations field for bishop rank');
        
        // If in edit mode, populate existing consecrations
        {% if edit_mode and clergy %}
        console.log('ðŸ” CONSECRATION FIELD DEBUG: About to call populateExistingConsecrations()');
        populateExistingConsecrations();
        {% endif %}
    } else {
        console.log('âŒ CONSECRATION FIELD DEBUG: Not showing consecrations field');
        console.log('âŒ CONSECRATION FIELD DEBUG: isBishop =', isBishop, 'consecrationsField =', !!consecrationsField);
    }
    
    // If in edit mode and has existing ordinations, populate them
    {% if edit_mode and clergy %}
    populateExistingOrdinations();
    {% endif %}
    
    // Adjust layout after showing fields
    adjustFormLayout();
    console.log('ðŸ”§ INIT: initializeFormFromRank completed');
}

// Populate existing ordinations for edit mode
function populateExistingOrdinations() {
    {% if edit_mode and clergy %}
    const container = document.getElementById('ordinationsContainer');
    if (!container) return;
    
    // Check if ordinations have already been populated to prevent duplicates
    if (container.hasAttribute('data-ordinations-populated')) {
        console.log('Ordinations already populated, skipping...');
        return;
    }
    
    const ordinations = [
        {% for ordination in clergy.get_all_ordinations() %}
        {
            id: {{ ordination.id }},
            date: {{ ordination.date.strftime('%Y-%m-%d')|tojson if ordination.date else 'null' }},
            is_sub_conditione: {{ ordination.is_sub_conditione|lower }},
            is_doubtfully_valid: {{ ordination.is_doubtfully_valid|lower }},
            is_doubtful_event: {{ ordination.is_doubtful_event|lower }},
            is_invalid: {{ ordination.is_invalid|lower }},
            notes: {{ ordination.notes|tojson if ordination.notes else 'null' }},
            ordaining_bishop: {% if ordination.ordaining_bishop %}{
                id: {{ ordination.ordaining_bishop.id }},
                name: {{ ordination.ordaining_bishop.name|tojson }}
            }{% else %}null{% endif %}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    console.log('Populating', ordinations.length, 'existing ordinations...');
    
    // Mark as populated before adding entries
    container.setAttribute('data-ordinations-populated', 'true');
    
    // Populate ordinations using JavaScript
    ordinations.forEach((ordination, index) => {
        addOrdination();
        const ordinationEntry = container.lastElementChild;
        if (ordinationEntry) {
            // Populate date
            const dateInput = ordinationEntry.querySelector('input[name*="[date]"]');
            if (dateInput && ordination.date) {
                dateInput.value = ordination.date;
            }
            
            // Populate ordaining bishop
            const bishopInput = ordinationEntry.querySelector('input[name*="[ordaining_bishop_input]"]');
            const bishopIdInput = ordinationEntry.querySelector('input[name*="[ordaining_bishop_id]"]');
            if (ordination.ordaining_bishop) {
                if (bishopInput) bishopInput.value = ordination.ordaining_bishop.name;
                if (bishopIdInput) bishopIdInput.value = ordination.ordaining_bishop.id;
            }
            
            // Populate checkboxes
            const subConditioneInput = ordinationEntry.querySelector('input[name*="[is_sub_conditione]"]');
            const doubtfulEventInput = ordinationEntry.querySelector('input[name*="[is_doubtful_event]"]');
            const validitySelect = ordinationEntry.querySelector('select[name*="[validity]"]');
            
            if (subConditioneInput) subConditioneInput.checked = ordination.is_sub_conditione;
            if (doubtfulEventInput) doubtfulEventInput.checked = ordination.is_doubtful_event;
            
            // Set validity dropdown based on is_doubtfully_valid and is_invalid
            if (validitySelect) {
                if (ordination.is_invalid) {
                    validitySelect.value = 'invalid';
                } else if (ordination.is_doubtfully_valid) {
                    validitySelect.value = 'doubtfully_valid';
                } else {
                    validitySelect.value = 'valid';
                }
            }
            
            // Populate notes
            const notesTextarea = ordinationEntry.querySelector('textarea[name*="[notes]"]');
            if (notesTextarea && ordination.notes) {
                notesTextarea.value = ordination.notes;
            }
        }
    });
    {% else %}
    console.log('No ordinations to populate or not in edit mode');
    {% endif %}
}

// Populate existing consecrations for edit mode
function populateExistingConsecrations() {
    console.log('ðŸ” CONSECRATION DEBUG: Starting populateExistingConsecrations function');
    console.log('ðŸ” CONSECRATION DEBUG: edit_mode = {{ edit_mode|lower }}');
    console.log('ðŸ” CONSECRATION DEBUG: clergy exists = {{ (clergy is defined and clergy)|lower }}');
    
    {% if edit_mode and clergy %}
    console.log('ðŸ” CONSECRATION DEBUG: In edit mode with clergy, proceeding...');
    console.log('ðŸ” CONSECRATION DEBUG: clergy.get_all_consecrations() = {{ clergy.get_all_consecrations()|length }} consecrations');
    
    const container = document.getElementById('consecrationsContainer');
    console.log('ðŸ” CONSECRATION DEBUG: consecrationsContainer found =', !!container);
    if (!container) {
        console.error('âŒ CONSECRATION DEBUG: consecrationsContainer not found!');
        return;
    }
    
    // Check if consecrations have already been populated to prevent duplicates
    if (container.hasAttribute('data-consecrations-populated')) {
        console.log('ðŸ” CONSECRATION DEBUG: Consecrations already populated, skipping...');
        return;
    }
    
    console.log('ðŸ” CONSECRATION DEBUG: Building consecrations array...');
    const consecrations = [
        {% for consecration in clergy.get_all_consecrations() %}
        {
            id: {{ consecration.id }},
            date: {{ consecration.date.strftime('%Y-%m-%d')|tojson if consecration.date else 'null' }},
            is_sub_conditione: {{ consecration.is_sub_conditione|lower }},
            is_doubtfully_valid: {{ consecration.is_doubtfully_valid|lower }},
            is_doubtful_event: {{ consecration.is_doubtful_event|lower }},
            is_invalid: {{ consecration.is_invalid|lower }},
            notes: {{ consecration.notes|tojson if consecration.notes else 'null' }},
            consecrator: {% if consecration.consecrator %}{
                id: {{ consecration.consecrator.id }},
                name: {{ consecration.consecrator.name|tojson }}
            }{% else %}null{% endif %},
            co_consecrators: [
                {% for co_consecrator in consecration.co_consecrators %}
                {
                    id: {{ co_consecrator.id }},
                    name: {{ co_consecrator.name|tojson }}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ]
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    console.log('ðŸ” CONSECRATION DEBUG: Built consecrations array:', consecrations);
    console.log('ðŸ” CONSECRATION DEBUG: Populating', consecrations.length, 'existing consecrations...');
    
    // Mark as populated before adding entries
    container.setAttribute('data-consecrations-populated', 'true');
    
    // Populate consecrations using JavaScript
    consecrations.forEach((consecration, index) => {
        addConsecration();
        const consecrationEntry = container.lastElementChild;
        if (consecrationEntry) {
            // Populate date
            const dateInput = consecrationEntry.querySelector('input[name*="[date]"]');
            if (dateInput && consecration.date) {
                dateInput.value = consecration.date;
            }
            
            // Populate consecrator
            const consecratorInput = consecrationEntry.querySelector('input[name*="[consecrator_input]"]');
            const consecratorIdInput = consecrationEntry.querySelector('input[name*="[consecrator_id]"]');
            if (consecration.consecrator) {
                if (consecratorInput) consecratorInput.value = consecration.consecrator.name;
                if (consecratorIdInput) consecratorIdInput.value = consecration.consecrator.id;
            }
            
            // Populate co-consecrators
            if (consecration.co_consecrators && consecration.co_consecrators.length > 0) {
                const coConsecratorInput = consecrationEntry.querySelector('input[name*="[co_consecrators][0][input]"]');
                const coConsecratorIdInput = consecrationEntry.querySelector('input[name*="[co_consecrators][0][id]"]');
                const firstCoConsecrator = consecration.co_consecrators[0];
                if (coConsecratorInput) coConsecratorInput.value = firstCoConsecrator.name;
                if (coConsecratorIdInput) coConsecratorIdInput.value = firstCoConsecrator.id;
                
                // Add additional co-consecrators if they exist
                const coConsecratorsList = consecrationEntry.querySelector('.co-consecrators-list');
                if (coConsecratorsList && consecration.co_consecrators.length > 1) {
                    consecration.co_consecrators.slice(1).forEach((coConsecrator, coIndex) => {
                        const additionalCoConsecratorHtml = `
                            <div class="co-consecrator-item" style="display: flex; gap: 0.5em; margin-bottom: 0.5em; align-items: center;">
                                <input type="text" name="consecrations[${index}][co_consecrators][${coIndex + 1}][input]" value="${coConsecrator.name}" style="flex: 1; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 4px; background: rgba(255, 255, 255, 0.08); font-size: 0.85em; color: white;">
                                <input type="hidden" name="consecrations[${index}][co_consecrators][${coIndex + 1}][id]" value="${coConsecrator.id}">
                                <button type="button" class="remove-co-consecrator" style="padding: 0.4em 0.6em; border: 1px solid rgba(255, 100, 100, 0.4); background: rgba(255, 100, 100, 0.08); color: rgba(255, 150, 150, 0.9); border-radius: 4px; cursor: pointer; font-size: 0.75em;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        coConsecratorsList.insertAdjacentHTML('beforeend', additionalCoConsecratorHtml);
                    });
                }
            }
            
            // Populate checkboxes
            const subConditioneInput = consecrationEntry.querySelector('input[name*="[is_sub_conditione]"]');
            const doubtfulEventInput = consecrationEntry.querySelector('input[name*="[is_doubtful_event]"]');
            const validitySelect = consecrationEntry.querySelector('select[name*="[validity]"]');
            
            if (subConditioneInput) subConditioneInput.checked = consecration.is_sub_conditione;
            if (doubtfulEventInput) doubtfulEventInput.checked = consecration.is_doubtful_event;
            
            // Set validity dropdown based on is_doubtfully_valid and is_invalid
            if (validitySelect) {
                if (consecration.is_invalid) {
                    validitySelect.value = 'invalid';
                } else if (consecration.is_doubtfully_valid) {
                    validitySelect.value = 'doubtfully_valid';
                } else {
                    validitySelect.value = 'valid';
                }
            }
            
            // Populate notes
            const notesTextarea = consecrationEntry.querySelector('textarea[name*="[notes]"]');
            if (notesTextarea && consecration.notes) {
                notesTextarea.value = consecration.notes;
            }
        }
    });
    {% else %}
    console.log('No ordinations to populate or not in edit mode');
    {% endif %}
}


// Dynamic grid layout adjustment for conditional fields
function adjustFormLayout() {
    const papalField = document.getElementById('papalNameField');
    const organizationField = document.getElementById('organizationField');
    const photoField = document.getElementById('photoField');
    const rankField = document.getElementById('rankField');
    const birthField = document.getElementById('birthField');
    const deathField = document.getElementById('deathField');
    const notesField = document.getElementById('notesField');
    const ordinationsField = document.getElementById('ordinationsField');
    const consecrationsField = document.getElementById('consecrationsField');
    
    const papalVisible = papalField && papalField.style.display !== 'none';
    const consecrationsVisible = consecrationsField && consecrationsField.style.display !== 'none';
    
    console.log('Adjusting grid layout. Papal visible:', papalVisible, 'Consecrations visible:', consecrationsVisible);
    
    // Calculate row positions dynamically
    let currentRow = 1;
    
    // Row 1: Name (always row 1, spans 2 columns) - no change needed
    currentRow = 2;
    
    // Row 2: Papal Name (conditional, spans 2 columns)
    if (papalVisible && papalField) {
        papalField.style.gridRow = currentRow.toString();
        currentRow++;
    }
    
    // Row 3 (or 2 if papal hidden): Organization (spans 2 columns)
    if (organizationField) {
        organizationField.style.gridRow = currentRow.toString();
        currentRow++;
    }
    
    // Photo section starts at current row (spans 3 rows)
    const photoStartRow = currentRow;
    if (photoField) {
        photoField.style.gridRow = `${photoStartRow} / ${photoStartRow + 3}`;
    }
    
    // Right column fields align with photo rows
    if (rankField) {
        rankField.style.gridRow = photoStartRow.toString();
    }
    if (birthField) {
        birthField.style.gridRow = (photoStartRow + 1).toString();
    }
    if (deathField) {
        deathField.style.gridRow = (photoStartRow + 2).toString();
    }
    
    // After photo section
    currentRow = photoStartRow + 3;
    
    // Notes (spans 2 columns)
    if (notesField) {
        notesField.style.gridRow = currentRow.toString();
        currentRow++;
    }
    
    // Ordinations (always visible, spans 2 columns)
    if (ordinationsField) {
        ordinationsField.style.gridRow = currentRow.toString();
        currentRow++;
    }
    
    // Consecrations (conditional, spans 2 columns)
    if (consecrationsField) {
        if (consecrationsVisible) {
            consecrationsField.style.gridRow = currentRow.toString();
        }
    }
    
    console.log('Layout adjusted. Photo rows:', `${photoStartRow}-${photoStartRow + 2}`, 'Ordinations row:', currentRow - 1);
}

// Function to attach rank change event listener
function attachRankChangeListener() {
    const rankSelect = document.getElementById('rank');
    if (rankSelect && !rankSelect.hasAttribute('data-change-listener-attached')) {
        rankSelect.setAttribute('data-change-listener-attached', 'true');
        rankSelect.addEventListener('change', function() {
            console.log('ðŸ”„ RANK CHANGE: Event triggered');
            const papalField = document.getElementById('papalNameField');
            const consecrationsField = document.getElementById('consecrationsField');
            const selectedOption = this.options[this.selectedIndex];
            const rankValue = this.value.toLowerCase();
            const isBishop = selectedOption.getAttribute('data-is-bishop') === 'true';
            
            console.log('ðŸ”„ RANK CHANGE: Details:', {
                rankValue: rankValue,
                isBishop: isBishop,
                dataAttribute: selectedOption.getAttribute('data-is-bishop'),
                papalField: !!papalField,
                consecrationsField: !!consecrationsField
            });
            
            // Handle papal name field (only for pope)
            if (rankValue === 'pope') {
                if (papalField) {
                    papalField.style.display = 'block';
                }
            } else {
                if (papalField) {
                    papalField.style.display = 'none';
                }
            }
            
            // Handle consecrations field (for any rank with is_bishop flag)
            if (isBishop) {
                if (consecrationsField) {
                    consecrationsField.style.display = 'block';
                    console.log('ðŸ”„ RANK CHANGE: âœ… Showing consecrations field for bishop rank');
                } else {
                    console.log('ðŸ”„ RANK CHANGE: âŒ consecrationsField not found');
                }
            } else {
                if (consecrationsField) {
                    consecrationsField.style.display = 'none';
                    console.log('ðŸ”„ RANK CHANGE: Hiding consecrations field - not bishop rank');
                }
            }
            
            // Update form layout
            adjustFormLayout();
        });
        console.log('âœ… Rank change listener attached');
    }
}

// Attach rank change listener immediately
attachRankChangeListener();

// Auto-toggle "deceased" status based on date of death
(function() {
    const dateOfDeathInput = document.getElementById('date_of_death');
    if (dateOfDeathInput) {
        // Function to find and toggle the deceased status checkbox
        function updateDeceasedStatus() {
            // Find the deceased status checkbox
            // We need to search through all status checkboxes to find the one for "deceased"
            const statusCheckboxes = document.querySelectorAll('input[name="status_ids[]"]');
            let deceasedCheckbox = null;
            
            statusCheckboxes.forEach(checkbox => {
                const label = document.querySelector(`label[for="${checkbox.id}"]`);
                if (label && label.textContent.trim().toLowerCase() === 'deceased') {
                    deceasedCheckbox = checkbox;
                }
            });
            
            if (deceasedCheckbox) {
                // If there's a date of death, check the deceased status
                // If there's no date of death, uncheck it
                if (dateOfDeathInput.value && dateOfDeathInput.value.trim() !== '') {
                    deceasedCheckbox.checked = true;
                    console.log('Auto-checked deceased status due to date of death:', dateOfDeathInput.value);
                } else {
                    deceasedCheckbox.checked = false;
                    console.log('Auto-unchecked deceased status (no date of death)');
                }
            }
            // Silently skip if checkbox not found - it may not exist in all forms
        }
        
        // Listen for changes to the date of death field
        dateOfDeathInput.addEventListener('change', updateDeceasedStatus);
        dateOfDeathInput.addEventListener('input', updateDeceasedStatus);
        
        // Also check on page load
        setTimeout(updateDeceasedStatus, 100);
        
        console.log('âœ… Auto-deceased status listener attached');
    }
})();

// Initial layout adjustment
document.addEventListener('DOMContentLoaded', function() {
    adjustFormLayout();
});

// Ordination and Consecration management
(function() {
    let ordinationCount = 0;
    let consecrationCount = 0;
    let coConsecratorCount = 1;

// Add ordination functionality
function addOrdination() {
    const container = document.getElementById('ordinationsContainer');
    if (!container) return;

    const ordinationHtml = `
        <div class="ordination-entry" style="border-left: 3px solid rgba(255, 255, 255, 0.15); background: rgba(255, 255, 255, 0.03); padding: 1em; margin-bottom: 1em; border-radius: 0 4px 4px 0;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75em; margin-bottom: 0.75em;">
                <div>
                    <label style="display: block; margin-bottom: 0.25em; font-weight: 500; color: rgba(255, 255, 255, 0.8); font-size: 0.8em;">Date</label>
                    <input type="date" name="ordinations[${ordinationCount}][date]" style="width: 100%; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 4px; background: rgba(255, 255, 255, 0.08); font-size: 0.85em; color: white;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25em; font-weight: 500; color: rgba(255, 255, 255, 0.8); font-size: 0.8em;">Ordaining Bishop</label>
                    <div style="position: relative;">
                        <input type="text" name="ordinations[${ordinationCount}][ordaining_bishop_input]" placeholder="Search for bishop..." autocomplete="off" style="width: 100%; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 4px; background: rgba(255, 255, 255, 0.08); font-size: 0.85em; color: white;">
                        <input type="hidden" name="ordinations[${ordinationCount}][ordaining_bishop_id]">
                        <div class="autocomplete-dropdown" style="position: absolute; top: 100%; left: 0; width: 100%; z-index: 20; display: none; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75em; margin-bottom: 0.75em;">
                <div>
                    <label style="display: block; margin-bottom: 0.5em; font-weight: 500; color: rgba(255, 255, 255, 0.8); font-size: 0.8em;">Status</label>
                    <div style="display: flex; flex-direction: column; gap: 0.5em;">
                        <div style="display: flex; align-items: center; gap: 0.5em;">
                            <input type="checkbox" name="ordinations[${ordinationCount}][is_sub_conditione]" id="sub_conditione_${ordinationCount}" style="margin: 0;">
                            <label for="sub_conditione_${ordinationCount}" style="color: rgba(255, 255, 255, 0.8); font-size: 0.8em; margin: 0; cursor: pointer;">Sub Conditione</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5em;">
                            <input type="checkbox" name="ordinations[${ordinationCount}][is_doubtful_event]" id="doubtful_event_${ordinationCount}" style="margin: 0;">
                            <label for="doubtful_event_${ordinationCount}" style="color: rgba(255, 255, 255, 0.8); font-size: 0.8em; margin: 0; cursor: pointer;">Doubtful Event</label>
                        </div>
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5em; font-weight: 500; color: rgba(255, 255, 255, 0.8); font-size: 0.8em;">Validity</label>
                    <select name="ordinations[${ordinationCount}][validity]" style="width: 100%; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 4px; background: rgba(255, 255, 255, 0.08); font-size: 0.85em; color: white;">
                        <option value="valid">Valid</option>
                        <option value="doubtfully_valid">Doubtfully Valid</option>
                        <option value="invalid">Invalid</option>
                    </select>
                </div>
            </div>
            <div style="margin-bottom: 0.75em;">
                <label style="display: block; margin-bottom: 0.25em; font-weight: 500; color: rgba(255, 255, 255, 0.8); font-size: 0.8em;">Notes</label>
                <textarea name="ordinations[${ordinationCount}][notes]" rows="2" placeholder="Additional notes..." style="width: 100%; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 4px; background: rgba(255, 255, 255, 0.08); font-size: 0.85em; color: white; resize: vertical;"></textarea>
            </div>
            <div style="text-align: right;">
                <button type="button" class="remove-ordination" style="padding: 0.4em 0.8em; border: 1px solid rgba(255, 100, 100, 0.4); background: rgba(255, 100, 100, 0.08); color: rgba(255, 150, 150, 0.9); border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                    <i class="fas fa-trash" style="margin-right: 0.5em;"></i>Remove
                </button>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', ordinationHtml);
    ordinationCount++;
    
    // Initialize autocomplete for the new ordination field
    const newOrdinationEntry = container.lastElementChild;
    if (newOrdinationEntry) {
        const newInput = newOrdinationEntry.querySelector('input[name*="ordaining_bishop_input"]');
        if (newInput) {
            initializeSingleClergyAutocomplete(newInput);
        }
    }
}

// Add consecration functionality
function addConsecration() {
    const container = document.getElementById('consecrationsContainer');
    if (!container) return;

    const consecrationHtml = `
        <div class="consecration-entry" style="border-left: 3px solid rgba(46, 175, 80, 0.3); background: rgba(46, 175, 80, 0.03); padding: 1em; margin-bottom: 1em; border-radius: 0 4px 4px 0;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75em; margin-bottom: 0.75em;">
                <div>
                    <label style="display: block; margin-bottom: 0.25em; font-weight: 500; color: rgba(255, 255, 255, 0.8); font-size: 0.8em;">Date</label>
                    <input type="date" name="consecrations[${consecrationCount}][date]" style="width: 100%; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 4px; background: rgba(255, 255, 255, 0.08); font-size: 0.85em; color: white;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25em; font-weight: 500; color: rgba(255, 255, 255, 0.8); font-size: 0.8em;">Consecrator</label>
                    <div style="position: relative;">
                        <input type="text" name="consecrations[${consecrationCount}][consecrator_input]" placeholder="Search for consecrator..." autocomplete="off" style="width: 100%; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 4px; background: rgba(255, 255, 255, 0.08); font-size: 0.85em; color: white;">
                        <input type="hidden" name="consecrations[${consecrationCount}][consecrator_id]">
                        <div class="autocomplete-dropdown" style="position: absolute; top: 100%; left: 0; width: 100%; z-index: 20; display: none; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
            <div style="margin-bottom: 0.75em;">
                <label style="display: block; margin-bottom: 0.25em; font-weight: 500; color: rgba(255, 255, 255, 0.8); font-size: 0.8em;">Co-Consecrators</label>
                <div style="display: flex; gap: 0.5em; margin-bottom: 0.5em;">
                    <div style="position: relative; flex: 1;">
                        <input type="text" name="consecrations[${consecrationCount}][co_consecrators][0][input]" placeholder="Search for co-consecrator..." autocomplete="off" style="width: 100%; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 4px; background: rgba(255, 255, 255, 0.08); font-size: 0.85em; color: white;">
                        <input type="hidden" name="consecrations[${consecrationCount}][co_consecrators][0][id]">
                        <div class="autocomplete-dropdown" style="position: absolute; top: 100%; left: 0; width: 100%; z-index: 20; display: none; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    <button type="button" class="add-co-consecrator" style="padding: 0.5em 0.75em; border: 1px solid rgba(255, 255, 255, 0.25); background: rgba(255, 255, 255, 0.08); color: rgba(255, 255, 255, 0.9); border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                        <i class="fas fa-plus" style="margin-right: 0.25em;"></i>Add
                    </button>
                </div>
                <div class="co-consecrators-list">
                    <!-- Additional co-consecrators will be added here -->
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75em; margin-bottom: 0.75em;">
                <div>
                    <label style="display: block; margin-bottom: 0.5em; font-weight: 500; color: rgba(255, 255, 255, 0.8); font-size: 0.8em;">Status</label>
                    <div style="display: flex; flex-direction: column; gap: 0.5em;">
                        <div style="display: flex; align-items: center; gap: 0.5em;">
                            <input type="checkbox" name="consecrations[${consecrationCount}][is_sub_conditione]" id="consec_sub_conditione_${consecrationCount}" style="margin: 0;">
                            <label for="consec_sub_conditione_${consecrationCount}" style="color: rgba(255, 255, 255, 0.8); font-size: 0.8em; margin: 0; cursor: pointer;">Sub Conditione</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5em;">
                            <input type="checkbox" name="consecrations[${consecrationCount}][is_doubtful_event]" id="consec_doubtful_event_${consecrationCount}" style="margin: 0;">
                            <label for="consec_doubtful_event_${consecrationCount}" style="color: rgba(255, 255, 255, 0.8); font-size: 0.8em; margin: 0; cursor: pointer;">Doubtful Event</label>
                        </div>
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5em; font-weight: 500; color: rgba(255, 255, 255, 0.8); font-size: 0.8em;">Validity</label>
                    <select name="consecrations[${consecrationCount}][validity]" style="width: 100%; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 4px; background: rgba(255, 255, 255, 0.08); font-size: 0.85em; color: white;">
                        <option value="valid">Valid</option>
                        <option value="doubtfully_valid">Doubtfully Valid</option>
                        <option value="invalid">Invalid</option>
                    </select>
                </div>
            </div>
            <div style="margin-bottom: 0.75em;">
                <label style="display: block; margin-bottom: 0.25em; font-weight: 500; color: rgba(255, 255, 255, 0.8); font-size: 0.8em;">Notes</label>
                <textarea name="consecrations[${consecrationCount}][notes]" rows="2" placeholder="Additional notes..." style="width: 100%; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 4px; background: rgba(255, 255, 255, 0.08); font-size: 0.85em; color: white; resize: vertical;"></textarea>
            </div>
            <div style="text-align: right;">
                <button type="button" class="remove-consecration" style="padding: 0.4em 0.8em; border: 1px solid rgba(255, 100, 100, 0.4); background: rgba(255, 100, 100, 0.08); color: rgba(255, 150, 150, 0.9); border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                    <i class="fas fa-trash" style="margin-right: 0.5em;"></i>Remove
                </button>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', consecrationHtml);
    consecrationCount++;
    
    // Initialize autocomplete for the new consecration fields
    const newConsecrationEntry = container.lastElementChild;
    if (newConsecrationEntry) {
        const consecratorInput = newConsecrationEntry.querySelector('input[name*="consecrator_input"]');
        const coConsecratorInput = newConsecrationEntry.querySelector('input[name*="co_consecrators"][name*="input"]');
        
        if (consecratorInput) {
            initializeSingleClergyAutocomplete(consecratorInput);
        }
        if (coConsecratorInput) {
            initializeSingleClergyAutocomplete(coConsecratorInput);
        }
    }
}

// Add co-consecrator functionality
function addCoConsecrator(button) {
    const consecrationEntry = button.closest('.consecration-entry');
    if (!consecrationEntry) return;
    
    const coConsecratorsList = consecrationEntry.querySelector('.co-consecrators-list');
    if (!coConsecratorsList) return;
    
    // Get the current consecration index from the form name
    const consecrationIndex = consecrationEntry.querySelector('input[name*="[date]"]').name.match(/consecrations\[(\d+)\]/);
    if (!consecrationIndex) return;
    
    const index = consecrationIndex[1];
    const coConsecratorCount = coConsecratorsList.children.length + 1;
    
    const coConsecratorHtml = `
        <div class="co-consecrator-item" style="display: flex; gap: 0.5em; margin-bottom: 0.5em; align-items: center;">
            <div style="position: relative; flex: 1;">
                <input type="text" name="consecrations[${index}][co_consecrators][${coConsecratorCount}][input]" placeholder="Search for co-consecrator..." autocomplete="off" style="width: 100%; padding: 0.5em; border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 4px; background: rgba(255, 255, 255, 0.08); font-size: 0.85em; color: white;">
                <input type="hidden" name="consecrations[${index}][co_consecrators][${coConsecratorCount}][id]">
                <div class="autocomplete-dropdown" style="position: absolute; top: 100%; left: 0; width: 100%; z-index: 20; display: none; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; max-height: 200px; overflow-y: auto;"></div>
            </div>
            <button type="button" class="remove-co-consecrator" style="padding: 0.4em 0.6em; border: 1px solid rgba(255, 100, 100, 0.4); background: rgba(255, 100, 100, 0.08); color: rgba(255, 150, 150, 0.9); border-radius: 4px; cursor: pointer; font-size: 0.75em;">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    coConsecratorsList.insertAdjacentHTML('beforeend', coConsecratorHtml);
    
    // Initialize autocomplete for the new co-consecrator field
    const newCoConsecratorItem = coConsecratorsList.lastElementChild;
    if (newCoConsecratorItem) {
        const coConsecratorInput = newCoConsecratorItem.querySelector('input[name*="co_consecrators"][name*="input"]');
        if (coConsecratorInput) {
            initializeSingleClergyAutocomplete(coConsecratorInput);
        }
    }
}

// Event listeners for add/remove buttons and image upload
// Use a single global event listener with proper delegation to avoid duplicates
if (!window.clergyFormEventListenersAttached) {
    document.addEventListener('click', function(e) {
        console.log('Click event detected:', e.target.id, e.target.className, e.target.tagName);
        // Only handle clicks within the clergy form to avoid conflicts
        if (!e.target.closest('#clergyForm')) return;
        
        if (e.target && e.target.id === 'addOrdinationBtn') {
            e.preventDefault();
            e.stopPropagation();
            addOrdination();
        }
        if (e.target && e.target.id === 'addConsecrationBtn') {
            e.preventDefault();
            e.stopPropagation();
            addConsecration();
        }
        if (e.target && e.target.classList.contains('add-co-consecrator')) {
            e.preventDefault();
            e.stopPropagation();
            addCoConsecrator(e.target);
        }
        if (e.target && e.target.classList.contains('remove-co-consecrator')) {
            e.preventDefault();
            e.stopPropagation();
            const coConsecratorItem = e.target.closest('.co-consecrator-item');
            if (coConsecratorItem) {
                coConsecratorItem.remove();
            }
        }
        if (e.target && e.target.classList.contains('remove-ordination')) {
            e.preventDefault();
            e.stopPropagation();
            const entry = e.target.closest('.ordination-entry');
            if (entry) {
                entry.remove();
            }
        }
        if (e.target && e.target.classList.contains('remove-consecration')) {
            e.preventDefault();
            e.stopPropagation();
            const entry = e.target.closest('.consecration-entry');
            if (entry) {
                entry.remove();
            }
        }
        
        // Image upload functionality
        if (e.target && e.target.id === 'uploadBtn') {
            e.preventDefault();
            e.stopPropagation();
            console.log('Upload button clicked');
            const fileInput = document.getElementById('clergyImage');
            if (fileInput) {
                console.log('File input found, clicking...');
                fileInput.click();
            } else {
                console.error('File input not found');
            }
        }
        
        // Image edit functionality
        if (e.target && e.target.id === 'cropExistingBtn') {
            e.preventDefault();
            e.stopPropagation();
            console.log('Edit button clicked');
            const previewImage = document.getElementById('previewImage');
            if (previewImage) {
                // Get the image source (either from data attribute or src)
                const imageSrc = previewImage.dataset.fullImage || previewImage.src;
                if (imageSrc) {
                    // Open the image editor modal with the current image
                    openImageEditor(imageSrc);
                } else {
                    console.error('No image source found for editing');
                    showNotification('No image found to edit', 'error');
                }
            } else {
                console.error('Preview image not found');
                showNotification('No image found to edit', 'error');
            }
        }
        
        // Image remove functionality
        if (e.target && e.target.id === 'removeImageBtn') {
            e.preventDefault();
            e.stopPropagation();
            console.log('Remove button clicked');
            const imagePreview = document.getElementById('imagePreview');
            const fileInput = document.getElementById('clergyImage');
            if (imagePreview && fileInput) {
                imagePreview.innerHTML = `
                    <div style="color: rgba(255, 255, 255, 0.5); font-size: 0.9em; padding: 2em; border: 1px dashed rgba(255, 255, 255, 0.2); border-radius: 4px;">
                        <i class="fas fa-user" style="font-size: 2em; margin-bottom: 0.5em; display: block; opacity: 0.6;"></i>
                        No Photo
                    </div>
                `;
                fileInput.value = '';
                // Clear any globally stored dropped file
                if (window.droppedFile) {
                    delete window.droppedFile;
                }
                showNotification('Photo removed', 'info');
            }
        }
    });
    
    // Mark that event listeners have been attached
    window.clergyFormEventListenersAttached = true;
}

    // File input change handler for image preview - use event delegation to avoid duplicates
    if (!window.clergyFormFileHandlerAttached) {
        document.addEventListener('change', function(e) {
            if (e.target && e.target.id === 'clergyImage') {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imagePreview = document.getElementById('imagePreview');
                        if (imagePreview) {
                            imagePreview.innerHTML = `
                                <img src="${e.target.result}" alt="Preview" id="previewImage" 
                                     style="max-width: 150px; max-height: 150px; border-radius: 4px; object-fit: cover;">
                            `;
                        }
                    };
                    reader.readAsDataURL(file);
                }
            }
        });
        
        // Mark that file handler has been attached
        window.clergyFormFileHandlerAttached = true;
    }

    // Initialize drag and drop functionality for photo upload
    if (!window.clergyFormDragDropInitialized) {
        function initDragDrop() {
            console.log('Initializing drag and drop for clergy form...');
            const photoContainer = document.getElementById('photoContainer');
            const fileInput = document.getElementById('clergyImage');
            const uploadBtn = document.getElementById('uploadBtn');
            
            console.log('Elements found:', { photoContainer, fileInput, uploadBtn });
            
            if (photoContainer && fileInput) {
                console.log('Setting up direct drag and drop handlers...');
                
                // Direct drag and drop handlers
                photoContainer.addEventListener('dragenter', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Direct dragenter');
                    this.classList.add('drag-over');
                }, true);
                
                photoContainer.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.dataTransfer.dropEffect = 'copy';
                    console.log('Direct dragover');
                }, true);
                
                photoContainer.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Direct dragleave');
                    this.classList.remove('drag-over');
                }, true);
                
                photoContainer.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Direct drop event');
                    this.classList.remove('drag-over');
                    
                    const files = e.dataTransfer.files;
                    console.log('Files dropped:', files.length);
                    
                    if (files.length > 0) {
                        const file = files[0];
                        console.log('Processing file:', file.name, file.type, file.size);
                        
                        if (file.type.startsWith('image/')) {
                            // Store the file globally for form submission
                            window.droppedFile = file;
                            console.log('File stored globally:', file.name, file.size, file.type);
                            
                            // Try to set the file in the input element
                            try {
                                // Try the modern DataTransfer approach first
                                if (typeof DataTransfer !== 'undefined' && DataTransfer.prototype.items) {
                                    const dataTransfer = new DataTransfer();
                                    dataTransfer.items.add(file);
                                    fileInput.files = dataTransfer.files;
                                    console.log('File set in input element using DataTransfer');
                                } else {
                                    console.log('DataTransfer not supported, file stored globally for manual handling');
                                }
                                
                                // Trigger the image editor if available
                                if (window.imageEditor && typeof window.imageEditor.handleFormImageUpload === 'function') {
                                    console.log('Using image editor...');
                                    const syntheticEvent = {
                                        target: fileInput,
                                        preventDefault: function() {},
                                        stopPropagation: function() {}
                                    };
                                    window.imageEditor.handleFormImageUpload(syntheticEvent);
                                } else {
                                    console.log('Using fallback preview...');
                                    const reader = new FileReader();
                                    reader.onload = function(e) {
                                        const imagePreview = document.getElementById('imagePreview');
                                        if (imagePreview) {
                                            imagePreview.innerHTML = `
                                                <img src="${e.target.result}" alt="Preview" id="previewImage" 
                                                     style="max-width: 150px; max-height: 150px; border-radius: 4px; object-fit: cover;">
                                            `;
                                        }
                                    };
                                    reader.readAsDataURL(file);
                                }
                            } catch (error) {
                                console.error('Error setting file in input:', error);
                                console.log('File will be handled manually during form submission');
                            }
                            
                            // Debug: Check if file is properly set in input
                            console.log('File input after setting:', fileInput.files);
                            console.log('File input files length:', fileInput.files.length);
                            if (fileInput.files.length > 0) {
                                console.log('First file:', fileInput.files[0]);
                                console.log('File name:', fileInput.files[0].name);
                                console.log('File size:', fileInput.files[0].size);
                                console.log('File type:', fileInput.files[0].type);
                            }
                        } else {
                            console.log('Not an image file');
                            alert('Please select an image file.');
                        }
                    }
                }, true);
                
                console.log('Direct drag and drop handlers set up successfully');
            } else {
                console.log('Drag and drop initialization failed - missing elements');
            }
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDragDrop);
        } else {
            setTimeout(initDragDrop, 100);
        }
        
        // Mark that drag drop has been initialized
        window.clergyFormDragDropInitialized = true;
    }

    // Make functions globally available
    window.addOrdination = addOrdination;
    window.addConsecration = addConsecration;
    window.addCoConsecrator = addCoConsecrator;
    
    // Make initialization function globally available
    window.initializeFormFromRank = initializeFormFromRank;
    window.populateExistingOrdinations = populateExistingOrdinations;
    window.populateExistingConsecrations = populateExistingConsecrations;
    window.resetPopulationFlags = resetPopulationFlags;
    window.isClergySwitching = isClergySwitching;
    
    // Debug function to manually test initialization
    window.debugFormInit = function() {
        console.log('ðŸ”§ DEBUG: Manual form initialization test');
        initializeFormFromRank();
    };
})();

// Placeholder for organization modal
function showOrganizationModal() {
    alert('Organization management coming soon...');
}

// Initialize clergy autocomplete functionality
function initializeClergyAutocomplete() {
    console.log('ðŸŽ¯ CONTENT: Initializing clergy autocomplete...');
    
    // Find all clergy search input fields
    const clergyInputs = document.querySelectorAll('input[name*="ordaining_bishop_input"], input[name*="consecrator_input"], input[name*="co_consecrators"][name*="input"]');
    console.log('ðŸŽ¯ CONTENT: Found clergy inputs:', clergyInputs.length);
    
    clergyInputs.forEach((input, index) => {
        console.log(`ðŸŽ¯ CONTENT: Initializing input ${index + 1}:`, input.name, input.placeholder);
        initializeSingleClergyAutocomplete(input);
    });
}

// Initialize autocomplete for a single input field
function initializeSingleClergyAutocomplete(input) {
    if (input.hasAttribute('data-autocomplete-initialized')) {
        console.log('ðŸŽ¯ CONTENT: Input already initialized:', input.name);
        return; // Already initialized
    }
    
    const dropdown = input.parentElement.querySelector('.autocomplete-dropdown');
    if (!dropdown) {
        console.log('ðŸŽ¯ CONTENT: No dropdown found for input:', input.name, input.parentElement);
        return;
    }
    
    console.log('ðŸŽ¯ CONTENT: Initializing autocomplete for:', input.name, 'with dropdown:', !!dropdown);
    input.setAttribute('data-autocomplete-initialized', 'true');
    
    input.addEventListener('input', function() {
        const query = this.value.trim();
        console.log('ðŸŽ¯ CONTENT: Input event for', this.name, 'query:', query);
        
        if (query.length < 2) {
            dropdown.style.display = 'none';
            return;
        }
        
        // Use fetch to search for bishops
        fetch(`/api/search_bishops?q=${encodeURIComponent(query)}`)
            .then(response => response.text())
            .then(html => {
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
                
                // Attach click handlers
                const results = dropdown.querySelectorAll('.bishop-search-result');
                results.forEach(result => {
                    result.addEventListener('click', function() {
                        const bishopId = this.dataset.id;
                        const bishopName = this.dataset.displayName || this.dataset.name;
                        
                        input.value = bishopName;
                        const hiddenInput = input.parentElement.querySelector('input[type="hidden"]');
                        if (hiddenInput) {
                            hiddenInput.value = bishopId;
                        }
                        
                        dropdown.style.display = 'none';
                    });
                });
            })
            .catch(error => {
                console.error('ðŸŽ¯ CONTENT: Error fetching bishops:', error);
            });
    });
    
    input.addEventListener('blur', function() {
        setTimeout(() => {
            dropdown.style.display = 'none';
        }, 200);
    });
    
    input.addEventListener('focus', function() {
        if (this.value.trim().length >= 2) {
            this.dispatchEvent(new Event('input'));
        }
    });
}

// Image editor functionality - NEW WORKFLOW
function openImageEditor(imageSrc) {
    console.log('Opening image editor with source (NEW WORKFLOW):', imageSrc);
    
    // Get the preview image to extract metadata
    const previewImage = document.getElementById('previewImage');
    if (!previewImage) {
        console.error('Preview image not found');
        showNotification('Image not found for editing', 'error');
        return;
    }
    
    // Extract metadata from the preview image
    const originalImageUrl = previewImage.getAttribute('data-original-image') || imageSrc;
    let clergyId = previewImage.getAttribute('data-clergy-id');
    const objectKey = previewImage.getAttribute('data-object-key');
    
    // Fallback: Extract clergy ID from URL if not found in data attributes
    if (!clergyId) {
        console.log('Clergy ID not found in data attributes, extracting from URL...');
        console.log('Current URL:', window.location.pathname);
        
        // Try multiple URL patterns
        let urlMatch = window.location.pathname.match(/\/editor\/clergy-form-content\/(\d+)/);
        if (urlMatch) {
            clergyId = urlMatch[1];
            console.log('Extracted clergy ID from URL:', clergyId);
        } else {
            // Try other patterns
            urlMatch = window.location.pathname.match(/\/editor\/clergy-form\/(\d+)/);
            if (urlMatch) {
                clergyId = urlMatch[1];
                console.log('Extracted clergy ID from clergy-form URL:', clergyId);
            } else {
                // Try to get from the form action URL
                const form = document.getElementById('clergyForm');
                if (form && form.action) {
                    console.log('Form action:', form.action);
                    const actionMatch = form.action.match(/\/clergy\/(\d+)/);
                    if (actionMatch) {
                        clergyId = actionMatch[1];
                        console.log('Extracted clergy ID from form action:', clergyId);
                    }
                }
            }
        }
        
        // If still no clergy ID found, try to extract from any URL parameter
        if (!clergyId) {
            const urlParams = new URLSearchParams(window.location.search);
            const clergyIdParam = urlParams.get('clergy_id') || urlParams.get('id');
            if (clergyIdParam) {
                clergyId = clergyIdParam;
                console.log('Extracted clergy ID from URL parameter:', clergyId);
            }
        }
    }
    
    console.log('Image editor metadata:', {
        originalImageUrl,
        clergyId,
        objectKey
    });
    
    // Debug: Check all data attributes
    console.log('All data attributes:', {
        'data-original-image': previewImage.getAttribute('data-original-image'),
        'data-clergy-id': previewImage.getAttribute('data-clergy-id'),
        'data-object-key': previewImage.getAttribute('data-object-key')
    });
    
    // Validate that we have a clergy ID
    if (!clergyId) {
        console.error('No clergy ID found for image editing');
        showNotification('Cannot edit image: clergy ID not found', 'error');
        return;
    }
    
    // Check if image editor modal exists
    const modal = document.getElementById('imageEditorModal');
    if (!modal) {
        console.error('Image editor modal not found');
        showNotification('Image editor not available', 'error');
        return;
    }
    
    // Set the image source to the ORIGINAL image (via proxy to avoid CORS)
    const editorImage = document.getElementById('editorImage');
    if (editorImage) {
        // Use proxy URL to avoid CORS issues
        const proxyUrl = `/proxy-image?url=${encodeURIComponent(originalImageUrl)}`;
        editorImage.src = proxyUrl;
        
        // Show the modal
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
        
        // Initialize the image editor after modal is shown
        modal.addEventListener('shown.bs.modal', async function() {
            if (window.imageEditor) {
                // Load the original image for editing
                await window.imageEditor.loadOriginalImageForEditing(originalImageUrl, clergyId);
                // Store the object key for deletion of previous edits
                window.imageEditor.originalObjectKey = objectKey;
            } else {
                console.error('Image editor not available');
                showNotification('Image editor not initialized', 'error');
            }
        }, { once: true });
        
    } else {
        console.error('Editor image element not found');
        showNotification('Image editor not properly configured', 'error');
    }
}

function updatePreviewImage(imageData) {
    const imagePreview = document.getElementById('imagePreview');
    const fileInput = document.getElementById('clergyImage');
    
    if (imagePreview) {
        // Parse the image data if it's a JSON string
        let imageSrc;
        let originalImageUrl = '';
        let clergyId = '';
        let objectKey = '';
        
        if (typeof imageData === 'string') {
            try {
                const parsed = JSON.parse(imageData);
                imageSrc = parsed.detail || parsed.original || imageData;
                originalImageUrl = parsed.original || imageSrc;
                clergyId = parsed.metadata?.clergy_id || '';
                objectKey = parsed.metadata?.object_key || '';
            } catch (e) {
                imageSrc = imageData;
                originalImageUrl = imageData;
            }
        } else {
            imageSrc = imageData.detail || imageData.original || imageData;
            originalImageUrl = imageData.original || imageSrc;
            clergyId = imageData.metadata?.clergy_id || '';
            objectKey = imageData.metadata?.object_key || '';
        }
        
        imagePreview.innerHTML = `
            <img src="${imageSrc}" alt="Preview" id="previewImage" 
                 style="max-width: 150px; max-height: 150px; border-radius: 4px; object-fit: cover;"
                 data-original-image="${originalImageUrl}"
                 data-clergy-id="${clergyId}"
                 data-object-key="${objectKey}">
        `;
        
        // Store the processed image data globally for form submission
        window.processedImageData = imageData;
        
        // Clear the file input since we're using processed data
        if (fileInput) {
            fileInput.value = '';
        }
    }
}

// Simple instant notification system
function showNotification(message, type = 'info') {
    // Optionally show a very brief, instant alert that auto-closes
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? 'rgba(46, 160, 67, 0.9)' : type === 'error' ? 'rgba(231, 76, 60, 0.9)' : 'rgba(52, 152, 219, 0.9)'};
        color: white;
        padding: 0.5em 1em;
        border-radius: 4px;
        z-index: 9999;
        font-size: 0.8em;
        opacity: 1;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Auto remove quickly
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 1500);
}
</script>
