{% extends "base.html" %}

{% block title %}Clergy Records - Ecclesiastical Lineage{% endblock %}

{% block full_content %}
    <div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0">Clergy Records</h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('lineage_visualization') }}" class="btn btn-success">
                <i class="fas fa-chart-line me-2"></i>View Lineage
            </a>
            <a href="{{ url_for('metadata') }}" class="btn btn-info">
                <i class="fas fa-cogs me-2"></i>Metadata
            </a>
            <a href="{{ url_for('add_clergy') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Add New Clergy
            </a>
        </div>
    </div>

    <!-- Filter and Search Row -->
    <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
        <!-- Filter Dropdown -->
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle filter-btn" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-filter me-1"></i> Filters
            </button>
            <div class="dropdown-menu p-3 filter-dropdown-menu" aria-labelledby="filterDropdown">
                <form method="get" id="filterForm" autocomplete="off"
                      hx-get="/clergy/filter_partial" hx-target="#clergyTableBody" hx-push-url="true" hx-include="#filterForm" hx-trigger="change">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="excludePriests" name="exclude_priests" value="1" {% if exclude_priests %}checked{% endif %}>
                        <label class="form-check-label" for="excludePriests">Exclude Priests</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="excludeCoconsecrators" name="exclude_coconsecrators" value="1" {% if exclude_coconsecrators %}checked{% endif %}>
                        <label class="form-check-label" for="excludeCoconsecrators">Exclude Co-consecrators</label>
                    </div>
                    <div class="mb-2">
                        <label class="form-label mb-1">Exclude Organizations</label>
                        <select class="form-select" name="exclude_organizations" id="excludeOrganizations" multiple size="5">
                            {% for org in organizations %}
                                <option value="{{ org.name }}" {% if org.name in exclude_organizations %}selected{% endif %}>
                                    {{ org.abbreviation or org.name }}{% if org.abbreviation %} - {{ org.name }}{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Hold Ctrl (Cmd on Mac) to select multiple.</small>
                    </div>
                    <div class="d-flex justify-content-end mt-2">
                        <a href="{{ url_for('clergy_list') }}" class="btn btn-outline-secondary btn-sm">Reset</a>
                    </div>
                </form>
            </div>
        </div>
        <!-- Search Bar -->
        <form class="d-flex align-items-center ms-2 position-relative" id="searchForm" autocomplete="off" onsubmit="return false;">
            <input type="text" class="form-control search-input-wide" name="search" id="clergySearchInput" placeholder="Search clergy by name..." value="{{ search }}" autocomplete="off">
            <button type="button" id="clearSearchBtn" class="btn btn-outline-secondary ms-2 clear-search-btn" style="display:none; position:absolute; right:8px; top:50%; transform:translateY(-50%); padding:0 8px; z-index:2;" tabindex="-1">&times;</button>
        </form>
    </div>

    {% if clergy_list %}
        <div class="sticky-table-outer-card">
            <!-- Table header (not scrollable) -->
            <table class="table mb-0 sticky-table sticky-table-header">
                <thead class="table-dark">
                    <tr>
                        <th class="table-header-small name-col">Name</th>
                        <th class="table-header-small org-col">Org.</th>
                        <th class="table-header-small">Ordination</th>
                        <th class="table-header-small">Consecration</th>
                        <!-- Removed Actions column header -->
                    </tr>
                </thead>
            </table>
            <!-- Scrollable table body -->
            <div class="sticky-table-container">
                <table class="table mb-0 sticky-table sticky-table-body">
                    <tbody id="clergyTableBody">
                        {% for clergy in clergy_list %}
                        <tr>
                            <td class="name-col">
                                <strong>{{ clergy.display_name }}</strong>
                            </td>
                            <td class="org-col">
                                {% if clergy.organization %}
                                    {% if org_abbreviation_map.get(clergy.organization) %}
                                        <span class="badge bg-info">{{ org_abbreviation_map.get(clergy.organization) }}</span>
                                    {% else %}
                                        {{ clergy.organization }}
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ clergy.date_of_ordination.strftime('%Y-%m-%d') if clergy.date_of_ordination else '-' }}</td>
                            <td>{{ clergy.date_of_consecration.strftime('%Y-%m-%d') if clergy.date_of_consecration else '-' }}</td>
                            <td>
                                <div class="clergy-action-group">
                                    <a href="{{ url_for('view_clergy', clergy_id=clergy.id) }}" class="clergy-action-btn view">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ url_for('edit_clergy', clergy_id=clergy.id) }}" class="clergy-action-btn edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <form action="{{ url_for('delete_clergy', clergy_id=clergy.id) }}" method="post" style="display:inline;" class="action-form-inline">
                                        <button type="submit" class="clergy-action-btn delete" onclick="return confirm('Are you sure you want to delete this clergy record?');">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="text-muted">
                    <i class="fas fa-users empty-state-icon"></i>
                    <h4 class="mt-3">No Clergy Records Found</h4>
                    <p class="mb-4">Start by adding your first clergy record.</p>
                    <a href="{{ url_for('add_clergy') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Add First Clergy Record
                    </a>
                </div>
            </div>
        </div>
    {% endif %}
    </div>
{% endblock %}

{% block extra_styles %}
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/fuzzySearch.js"></script>
<script>
// Remove static variables and make functions dynamic
const input = document.getElementById('clergySearchInput');
const clearBtn = document.getElementById('clearSearchBtn');

// Function to get current clergy names from the DOM
function getCurrentClergyNames() {
    const rows = document.querySelectorAll('#clergyTableBody tr');
    return Array.from(rows).map(row => {
        const nameElement = row.querySelector('td.name-col strong');
        return nameElement ? nameElement.textContent : '';
    }).filter(name => name.length > 0);
}

// Function to get current clergy rows from the DOM
function getCurrentClergyRows() {
    return Array.from(document.querySelectorAll('#clergyTableBody tr'));
}

function filterTable(query) {
    if (!query || query.trim().length < 1) {
        const rows = getCurrentClergyRows();
        rows.forEach(row => row.style.display = '');
        return;
    }
    
    const clergyNames = getCurrentClergyNames();
    const clergyRows = getCurrentClergyRows();
    
    if (clergyNames.length === 0) return;
    
    const results = window.fuzzySearch(clergyNames, query).slice(0, Math.max(8, Math.ceil(clergyRows.length * 0.5)));
    const matches = new Set(results.map(r => r.item));
    
    clergyRows.forEach(row => {
        const name = row.querySelector('td.name-col strong').textContent;
        row.style.display = matches.has(name) ? '' : 'none';
    });
}

input.addEventListener('input', function() {
    const query = input.value.trim();
    filterTable(query);
    clearBtn.style.display = query.length > 0 ? '' : 'none';
});

input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        input.blur();
    }
});

// Dynamically set the width of the name column to fit the longest name
function setNameColumnWidth() {
    const nameCells = document.querySelectorAll('td.name-col strong');
    let maxWidth = 0;
    nameCells.forEach(cell => {
        // Create a temporary span to measure width
        const span = document.createElement('span');
        span.style.visibility = 'hidden';
        span.style.position = 'absolute';
        span.style.whiteSpace = 'nowrap';
        span.style.font = window.getComputedStyle(cell).font;
        span.textContent = cell.textContent;
        document.body.appendChild(span);
        maxWidth = Math.max(maxWidth, span.offsetWidth);
        document.body.removeChild(span);
    });
    // Add some padding
    maxWidth += 32;
    // Set the width for all name-col cells and header
    document.querySelectorAll('th.name-col, td.name-col').forEach(el => {
        el.style.width = maxWidth + 'px';
        el.style.maxWidth = maxWidth + 'px';
    });
}

window.addEventListener('DOMContentLoaded', setNameColumnWidth);
window.addEventListener('resize', setNameColumnWidth);
document.addEventListener('htmx:afterSwap', function(event) {
    if (event.target.id === 'clergyTableBody') {
        setNameColumnWidth();
    }
});
// If using HTMX or AJAX to update table, call setNameColumnWidth() after update

</script>
{% endblock %} 