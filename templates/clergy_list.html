{% extends "base.html" %}

{% block title %}Clergy Records - Episcopal Lineage{% endblock %}

{% block full_content %}
    <div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0">Clergy Records</h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('main.lineage_visualization') }}" class="btn btn-success">
                <i class="fas fa-chart-line me-2"></i>View Lineage
            </a>
            {% if user and user.can_manage_metadata() %}
            <a href="{{ url_for('settings.metadata') }}" class="btn btn-info">
                <i class="fas fa-cogs me-2"></i>Metadata
            </a>
            {% endif %}
            {% if user and user.can_edit_clergy() %}
            <a href="#" id="addClergyBtn" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Add New Clergy
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Filter and Search Row -->
    <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
        <!-- Filter Dropdown -->
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle filter-btn" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-filter me-1"></i> Filters
            </button>
            <div class="dropdown-menu p-3 filter-dropdown-menu" aria-labelledby="filterDropdown">
                <form method="get" id="filterForm" autocomplete="off"
                      hx-get="/clergy/filter_partial" hx-target="#clergyTableBody" hx-push-url="true" hx-include="#filterForm" hx-trigger="change">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="excludePriests" name="exclude_priests" value="1" {% if exclude_priests %}checked{% endif %}>
                        <label class="form-check-label" for="excludePriests">Exclude Priests</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="excludeCoconsecrators" name="exclude_coconsecrators" value="1" {% if exclude_coconsecrators %}checked{% endif %}>
                        <label class="form-check-label" for="excludeCoconsecrators">Exclude Co-consecrators</label>
                    </div>
                    <div class="mb-2">
                        <label class="form-label mb-1">Exclude Organizations</label>
                        <select class="form-select" name="exclude_organizations" id="excludeOrganizations" multiple size="5">
                            {% for org in organizations %}
                                <option value="{{ org.name }}" {% if org.name in exclude_organizations %}selected{% endif %}>
                                    {{ org.abbreviation or org.name }}{% if org.abbreviation %} - {{ org.name }}{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Hold Ctrl (Cmd on Mac) to select multiple.</small>
                    </div>
                    <div class="d-flex justify-content-end mt-2">
                        <a href="{{ url_for('clergy.clergy_list') }}" class="btn btn-outline-secondary btn-sm">Reset</a>
                    </div>
                </form>
            </div>
        </div>
        <!-- Search Bar -->
        <form class="d-flex align-items-center ms-2 position-relative" id="searchForm" autocomplete="off" onsubmit="return false;">
            <input type="text" class="form-control search-input-wide" name="search" id="clergySearchInput" placeholder="Search clergy by name..." value="{{ search }}" autocomplete="off">
            <button type="button" id="clearSearchBtn" class="btn btn-outline-secondary ms-2 clear-search-btn" style="display:none; position:absolute; right:8px; top:50%; transform:translateY(-50%); padding:0 8px; z-index:2;" tabindex="-1">&times;</button>
        </form>
    </div>

    {% if clergy_list %}
        <div class="sticky-table-outer-card">
            {# Table header #}
            <table class="table mb-0 sticky-table sticky-table-header">
                <thead class="table-dark">
                    <tr>
                        <th class="table-header-small name-col">Name</th>
                        <th class="table-header-small">Ordinations</th>
                        <th class="table-header-small">Consecrations</th>
                    </tr>
                </thead>
            </table>
            {# Table body #}
            <div class="sticky-table-container">
                <table class="table mb-0 sticky-table sticky-table-body">
                    <tbody id="clergyTableBody">
                        {% for clergy in clergy_list %}
                        <tr class="clergy-row{% if clergy.is_deleted %} deleted-record{% endif %}" data-clergy-id="{{ clergy.id }}" data-can-edit="{{ 'true' if user and user.can_edit_clergy() else 'false' }}" {% if user and user.can_edit_clergy() %}style="cursor: pointer;"{% endif %}>
                            <td class="name-col">
                                <div class="d-flex align-items-center">
                                    <!-- Clergy Picture -->
                                    <div class="clergy-picture-container me-2">
                                        {% if clergy.image_url %}
                                            <img src="{{ clergy.image_url }}" alt="{{ clergy.display_name }}" class="clergy-picture" />
                                        {% else %}
                                            <div class="clergy-picture-placeholder">
                                                <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <circle cx="16" cy="16" r="16" fill="#e9ecef"/>
                                                    <circle cx="16" cy="12" r="4" fill="#6c757d"/>
                                                    <path d="M8 24c0-4.4 3.6-8 8-8s8 3.6 8 8" fill="#6c757d"/>
                                                </svg>
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Name and Tags -->
                                    <div class="flex-grow-1">
                                        <strong>{{ clergy.display_name }}</strong>
                                        
                                        <!-- Missing Data Tags -->
                                        {% if not clergy.ordinations %}
                                            <span class="badge bg-warning ms-1" title="Missing ordination date">No Ord Date</span>
                                        {% endif %}
                                        {% if clergy.ordinations and not clergy.ordinations[0].ordaining_bishop %}
                                            <span class="badge bg-warning ms-1" title="Missing ordaining bishop">No Ordainer</span>
                                        {% endif %}
                                        {% if clergy.rank and clergy.rank.lower() in ['bishop', 'pope', 'archbishop', 'cardinal', 'patriarch'] and not clergy.consecrations %}
                                            <span class="badge bg-warning ms-1" title="Missing consecration date">No Cons Date</span>
                                        {% endif %}
                                        {% if clergy.rank and clergy.rank.lower() in ['bishop', 'pope', 'archbishop', 'cardinal', 'patriarch'] and clergy.consecrations and not clergy.consecrations[0].consecrator %}
                                            <span class="badge bg-warning ms-1" title="Missing consecrator">No Consecrator</span>
                                        {% endif %}
                                        
                                        <!-- Special Status Flags -->
                                        {% for ordination in clergy.ordinations %}
                                            {% if ordination.is_sub_conditione %}
                                                <span class="badge bg-info ms-1" title="Ordination sub conditione">Sub Cond</span>
                                            {% endif %}
                                            {% if ordination.is_doubtful %}
                                                <span class="badge bg-warning ms-1" title="Doubtful ordination">Doubtful</span>
                                            {% endif %}
                                            {% if ordination.is_invalid %}
                                                <span class="badge bg-danger ms-1" title="Invalid ordination">Invalid</span>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        {% for consecration in clergy.consecrations %}
                                            {% if consecration.is_sub_conditione %}
                                                <span class="badge bg-info ms-1" title="Consecration sub conditione">Sub Cond</span>
                                            {% endif %}
                                            {% if consecration.is_doubtful %}
                                                <span class="badge bg-warning ms-1" title="Doubtful consecration">Doubtful</span>
                                            {% endif %}
                                            {% if consecration.is_invalid %}
                                                <span class="badge bg-danger ms-1" title="Invalid consecration">Invalid</span>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        <!-- Deleted Record Indicator -->
                                        {% if clergy.is_deleted %}
                                            <span class="badge bg-danger ms-1" title="This record has been marked as deleted">
                                                <i class="fas fa-trash"></i> Deleted
                                            </span>
                                        {% endif %}
                                        
                                        <!-- Organization Badge -->
                                        {% if clergy.organization and org_abbreviation_map.get(clergy.organization) %}
                                            {% set org_color = org_color_map.get(clergy.organization, '#27ae60') %}
                                            {% set text_color = 'white' if getContrastColor(org_color) == 'white' else 'black' %}
                                            {% set border_style = getBorderStyle(org_color) %}
                                            <span class="badge ms-2" style="background-color: {{ org_color }}; color: {{ text_color }}; {{ border_style }}; font-size: 0.85em; vertical-align: middle;">{{ org_abbreviation_map.get(clergy.organization) }}</span>
                                        {% endif %}
                                        
                                        <!-- Comments Badge -->
                                        {% if user and user.can_comment() %}
                                            {% set unresolved_count = 0 %}
                                            {% for comment in clergy.comments %}
                                                {% if not comment.is_resolved %}
                                                    {% set unresolved_count = unresolved_count + 1 %}
                                                {% endif %}
                                            {% endfor %}
                                            {% if unresolved_count > 0 %}
                                                <span class="badge bg-info ms-1" title="Has unresolved comments">
                                                    <i class="fas fa-comment"></i> {{ unresolved_count }}
                                                </span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if clergy.ordinations %}
                                    {% for ordination in clergy.ordinations %}
                                        {{ ordination.date.strftime('%Y-%m-%d') }}{% if ordination.ordaining_bishop %} - {{ ordination.ordaining_bishop.name }}{% endif %}{% if not loop.last %}<br>{% endif %}
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if clergy.consecrations %}
                                    {% for consecration in clergy.consecrations %}
                                        {{ consecration.date.strftime('%Y-%m-%d') }}{% if consecration.consecrator %} - {{ consecration.consecrator.name }}{% endif %}{% if not loop.last %}<br>{% endif %}
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="text-muted">
                    <i class="fas fa-users empty-state-icon"></i>
                    <h4 class="mt-3">No Clergy Records Found</h4>
                    <p class="mb-4">Start by adding your first clergy record.</p>
                    {% if user and user.can_edit_clergy() %}
                    <a href="#" id="addFirstClergyBtn" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Add First Clergy Record
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
    </div>

    <!-- Modal placeholder -->
    <div id="clergyModalContainer"></div>
{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="/static/css/visualizer.css">
<style>
{% if user and user.can_edit_clergy() %}
.clergy-row:hover {
    background-color: rgba(52, 152, 219, 0.08);
    transition: background-color 0.2s ease;
}

.clergy-row.selected {
    background-color: rgba(52, 152, 219, 0.2) !important;
}
{% endif %}

/* Styling for deleted records */
.deleted-record {
    opacity: 0.6;
    background-color: rgba(231, 76, 60, 0.05) !important;
}

.deleted-record:hover {
    background-color: rgba(231, 76, 60, 0.1) !important;
}

.deleted-record .name-col strong {
    text-decoration: line-through;
    color: #7f8c8d;
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
window.allClergyData = {{ all_clergy_json | safe }};
window.canComment = {{ 'true' if user and user.can_comment() else 'false' }};
</script>
<script src="/static/js/fuzzySearch.js"></script>
<script src="{{ url_for('static', filename='js/clergyList.js') }}"></script>
{% endblock %} 