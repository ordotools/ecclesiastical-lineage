<!-- Clergy Form Panel Content with HTMX Loading -->
<div id="clergyFormContainer">
    {% if clergy and edit_mode %}
        <!-- Load form content via HTMX for edit mode -->
        <div hx-get="{{ url_for('editor.clergy_form_content', clergy_id=clergy.id) }}" 
             hx-trigger="load" 
             hx-swap="innerHTML"
             class="form-content-loader">
            <!-- Minimal loading state -->
            <div id="formLoadingIndicatorEdit" style="padding: 1em; text-align: center; color: rgba(255, 255, 255, 0.5); font-size: 0.8em;">
                Loading form for {{ clergy.name }}...
            </div>
        </div>
        <script>
        console.log('ðŸ”„ HTMX: Should load form content for clergy ID {{ clergy.id }}');
        console.log('ðŸ”„ HTMX: URL: {{ url_for("editor.clergy_form_content", clergy_id=clergy.id) }}');
        
        // Test if HTMX is working at all
        setTimeout(() => {
            const loader = document.querySelector('.form-content-loader');
            if (loader) {
                console.log('ðŸ”„ HTMX: Form loader element found:', loader);
                console.log('ðŸ”„ HTMX: Has hx-get attribute:', loader.hasAttribute('hx-get'));
                console.log('ðŸ”„ HTMX: hx-get value:', loader.getAttribute('hx-get'));
            } else {
                console.log('ðŸ”„ HTMX: Form loader element NOT found');
            }
        }, 1000);
        
        // Immediate initialization test
        console.log('ðŸ”„ HTMX: Immediate initialization test...');
        if (typeof window.debugFormInit === 'function') {
            console.log('ðŸ”„ HTMX: Calling debugFormInit()');
            window.debugFormInit();
        }
        </script>
    {% elif not edit_mode %}
        <!-- Load form content via HTMX for add mode -->
        <div hx-get="{{ url_for('editor.clergy_form_content') }}" 
             hx-trigger="load" 
             hx-swap="innerHTML"
             class="form-content-loader">
            <!-- Minimal loading state -->
            <div id="formLoadingIndicatorAdd" style="padding: 1em; text-align: center; color: rgba(255, 255, 255, 0.5); font-size: 0.8em;">
                Loading new clergy form...
            </div>
        </div>
        <script>
        console.log('ðŸ”„ HTMX: Should load form content for new clergy');
        console.log('ðŸ”„ HTMX: URL: {{ url_for("editor.clergy_form_content") }}');
        </script>
    {% else %}
        <!-- Default state - no clergy selected -->
        <div style="padding: 2em; text-align: center; color: rgba(255, 255, 255, 0.6);">
            <div style="margin-bottom: 1em;">
                <i class="fas fa-edit" style="font-size: 3em; opacity: 0.3;"></i>
            </div>
            <h3 style="margin: 0 0 0.5em 0; font-weight: 500; color: rgba(255, 255, 255, 0.8);">No Clergy Selected</h3>
            <p style="margin: 0; font-size: 0.9em;">Select a clergy member from the list to edit, or click "Add New Clergy" to create a new record.</p>
        </div>
    {% endif %}
</div>

<!-- Enhanced form styles for editor panel with HTMX -->
<style>
/* Loading animation */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* No animations - instant updates like clergy list */

/* Form container optimization for HTMX content */
.right-panel .panel-content #clergyFormContainer {
    width: 100%;
    height: 100%;
    position: relative;
}

/* Smooth content loading */
.right-panel .form-content-loader {
    width: 100%;
    min-height: 400px;
    transition: opacity 0.3s ease, transform 0.3s ease;
}

/* Loading placeholder styling */
.right-panel .loading-placeholder {
    padding: 3em 2em;
    text-align: center;
    color: rgba(255, 255, 255, 0.6);
    position: relative;
    opacity: 1;
    transition: opacity 0.3s ease;
}

.right-panel .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid rgba(255, 255, 255, 0.2);
    border-top: 3px solid rgba(255, 255, 255, 0.7);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1em;
}

.right-panel .loading-spinner-small {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-top: 2px solid rgba(255, 255, 255, 0.6);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 1em auto;
}

/* Instant loading - no animations or transitions */
.right-panel .form-container {
    opacity: 1;
}

/* Simple focus styles without animation */
.right-panel input:focus,
.right-panel select:focus,
.right-panel textarea:focus {
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2) !important;
}

/* Make the form completely seamless with the panel */
.right-panel .panel-content > div > div {
    background: transparent !important;
    backdrop-filter: none !important;
    border: none !important;
    box-shadow: none !important;
    max-width: none !important;
    margin: 0 !important;
    padding: 0 !important;
    width: 100% !important;
}

/* Ensure full width for form container */
.right-panel .panel-content #clergyFormContainer {
    width: 100% !important;
    padding: 1em !important;
}

/* Form Container Optimizations for new grid layout */
.right-panel .form-container {
    width: 100%;
}

.right-panel .form-grid {
    grid-template-columns: 1fr 1fr !important;
    gap: 0.75em !important;
    grid-auto-rows: min-content;
}

/* Photo Section Styling */
.right-panel .photo-section {
    min-height: 280px;
}

.right-panel .photo-container {
    min-height: 220px !important;
    padding: 0.75em !important;
}

.right-panel .photo-controls button {
    padding: 0.4em 0.6em !important;
    font-size: 0.75em !important;
}

/* Form Fields Styling */
.right-panel .form-field {
    margin-bottom: 0;
}

.right-panel .form-field label {
    font-size: 0.8em !important;
    margin-bottom: 0.2em !important;
    font-weight: 500 !important;
}

/* Input and control styling */
.right-panel .form-field input,
.right-panel .form-field select,
.right-panel .form-field textarea {
    font-size: 0.85em !important;
    padding: 0.4em !important;
    border-radius: 3px !important;
}

.right-panel .form-field textarea {
    min-height: 60px !important;
}

/* Section headers */
.right-panel .form-section h5 {
    font-size: 0.9em !important;
    margin-bottom: 0.4em !important;
}

/* Section containers */
.right-panel .form-section > div {
    padding: 0.75em !important;
}

/* Dynamic entry styling */
.right-panel .ordination-entry,
.right-panel .consecration-entry {
    padding: 0.6em !important;
    margin-bottom: 0.6em !important;
}

.right-panel .ordination-entry input,
.right-panel .ordination-entry textarea,
.right-panel .ordination-entry select,
.right-panel .consecration-entry input,
.right-panel .consecration-entry textarea,
.right-panel .consecration-entry select {
    font-size: 0.75em !important;
    padding: 0.3em !important;
}

.right-panel .ordination-entry label,
.right-panel .consecration-entry label {
    font-size: 0.75em !important;
    margin-bottom: 0.2em !important;
}

/* Button styling - no animations */
.right-panel button {
    font-size: 0.8em !important;
}

.right-panel button:hover {
    background: rgba(255, 255, 255, 0.15) !important;
}

/* Admin controls styling */
.right-panel .admin-controls {
    margin-top: 1em;
    padding: 0.75em;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.05);
}

/* Submit buttons area */
.right-panel .form-actions {
    margin-top: 1em !important;
    padding-top: 0.75em !important;
    border-top: 1px solid rgba(255, 255, 255, 0.2) !important;
}

.right-panel .form-actions button,
.right-panel .form-actions a {
    font-size: 0.85em !important;
    padding: 0.5em 1em !important;
}


/* Responsive adjustments for smaller panels */
@media (max-width: 1200px) {
    .right-panel .form-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 0.6em !important;
    }
    
    .right-panel .photo-section {
        min-height: 240px;
    }
    
    .right-panel .photo-container {
        min-height: 180px !important;
    }
}
</style>

<script>
// Simple form handling - instant updates like clergy list
document.addEventListener('DOMContentLoaded', function() {
    console.log('Editor clergy form panel initialized');
});

// Use event delegation for HTMX-loaded form content
// Prevent duplicate event listeners
if (!window.clergyFormHandlerAttached) {
    window.clergyFormHandlerAttached = true;
    console.log('Attaching form submit event listener to document.body');
    document.body.addEventListener('submit', function(e) {
        console.log('Form submit event detected:', e.target);
        // Check if this is our clergy form (loaded via HTMX)
        if (e.target && e.target.id === 'clergyForm') {
            e.preventDefault();
            console.log('HTMX-loaded clergy form submitted - preventing default');
        
            const form = e.target;
            console.log('Form action URL:', form.action);
            console.log('Form method:', form.method);
            const formData = new FormData(form);
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            // Show loading state
            submitBtn.textContent = 'Saving...';
            submitBtn.disabled = true;
            
            // Collect all bishop names that need to be checked
            const bishopNames = collectBishopNames(form);
            
            if (bishopNames.length > 0) {
                console.log('ðŸ”„ Found bishops to create:', bishopNames);
                // Show user feedback about bishop creation
                submitBtn.textContent = `Creating ${bishopNames.length} bishop record${bishopNames.length > 1 ? 's' : ''}...`;
                
                // Check and create missing bishops
                checkAndCreateBishops(bishopNames)
                    .then(() => {
                        console.log('ðŸ”„ Bishop creation successful, proceeding with form submission');
                        // Update button text for final submission
                        submitBtn.textContent = 'Submitting form...';
                        // Submit the form after bishops are created
                        submitFormWithData(form, formData, submitBtn, originalText);
                    })
                    .catch(error => {
                        console.error('ðŸ”„ Error creating bishops:', error);
                        showNotification(`Error creating missing bishops: ${error.message}`, 'error');
                        resetSubmitButton(submitBtn, originalText);
                    });
            } else {
                console.log('ðŸ”„ No bishops to create, submitting form directly');
                // No bishops to check, submit directly
                submitFormWithData(form, formData, submitBtn, originalText);
            }
        }
    });
}

// Bishop creation functions for editor form
function collectBishopNames(form) {
    const bishopNames = new Set();
    
    console.log('Collecting bishop names...');
    
    // Collect ordaining bishops
    const ordainingBishopInputs = form.querySelectorAll('input[name*="ordaining_bishop_input"]');
    console.log('Found ordaining bishop inputs:', ordainingBishopInputs.length);
    ordainingBishopInputs.forEach(input => {
        const name = input.value.trim();
        const idInput = input.parentElement.querySelector('input[name*="ordaining_bishop_id"]');
        const id = idInput ? idInput.value : '';
        console.log(`Ordaining bishop: "${name}", ID: "${id}"`);
        if (name && !id) {
            bishopNames.add(name);
            console.log(`Added to bishop names: "${name}"`);
        }
    });
    
    // Collect consecrators
    const consecratorInputs = form.querySelectorAll('input[name*="consecrator_input"]');
    console.log('Found consecrator inputs:', consecratorInputs.length);
    consecratorInputs.forEach(input => {
        const name = input.value.trim();
        const idInput = input.parentElement.querySelector('input[name*="consecrator_id"]');
        const id = idInput ? idInput.value : '';
        console.log(`Consecrator: "${name}", ID: "${id}"`);
        if (name && !id) {
            bishopNames.add(name);
            console.log(`Added to bishop names: "${name}"`);
        }
    });
    
    // Collect co-consecrators
    const coConsecratorInputs = form.querySelectorAll('input[name*="co_consecrators"][name*="input"]');
    console.log('Found co-consecrator inputs:', coConsecratorInputs.length);
    coConsecratorInputs.forEach(input => {
        const name = input.value.trim();
        const idInput = input.parentElement.querySelector('input[name*="id"]');
        const id = idInput ? idInput.value : '';
        console.log(`Co-consecrator: "${name}", ID: "${id}"`);
        if (name && !id) {
            bishopNames.add(name);
            console.log(`Added to bishop names: "${name}"`);
        }
    });
    
    const result = Array.from(bishopNames);
    console.log('Final bishop names to check:', result);
    return result;
}

function checkAndCreateBishops(bishopNames) {
    console.log('ðŸ”„ Creating missing bishops:', bishopNames);
    return new Promise((resolve, reject) => {
        // Send AJAX request to check and create bishops
        fetch('/api/check-and-create-bishops', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                bishop_names: bishopNames
            })
        })
        .then(response => {
            console.log('ðŸ”„ Bishop creation response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('ðŸ”„ Bishop creation response:', data);
            if (data.success) {
                console.log('ðŸ”„ Successfully created bishops, updating form with IDs');
                // Update form with the created bishop IDs
                updateFormWithBishopIds(data.bishop_mapping);
                resolve();
            } else {
                reject(new Error(data.message || 'Failed to create bishops'));
            }
        })
        .catch(error => {
            console.error('ðŸ”„ Error creating bishops:', error);
            reject(error);
        });
    });
}

function updateFormWithBishopIds(bishopMapping) {
    const form = document.getElementById('clergyForm');
    if (!form) return;
    
    console.log('ðŸ”„ Updating form with bishop IDs:', bishopMapping);
    
    // Update ordaining bishops
    const ordainingBishopInputs = form.querySelectorAll('input[name*="ordaining_bishop_input"]');
    ordainingBishopInputs.forEach(input => {
        const name = input.value.trim();
        if (bishopMapping[name]) {
            const idInput = input.parentElement.querySelector('input[name*="ordaining_bishop_id"]');
            if (idInput) {
                idInput.value = bishopMapping[name];
                console.log(`ðŸ”„ Updated ordaining bishop "${name}" with ID: ${bishopMapping[name]}`);
            } else {
                console.warn(`ðŸ”„ No ID input found for ordaining bishop "${name}"`);
            }
        }
    });
    
    // Update consecrators
    const consecratorInputs = form.querySelectorAll('input[name*="consecrator_input"]');
    consecratorInputs.forEach(input => {
        const name = input.value.trim();
        if (bishopMapping[name]) {
            const idInput = input.parentElement.querySelector('input[name*="consecrator_id"]');
            if (idInput) {
                idInput.value = bishopMapping[name];
                console.log(`ðŸ”„ Updated consecrator "${name}" with ID: ${bishopMapping[name]}`);
            } else {
                console.warn(`ðŸ”„ No ID input found for consecrator "${name}"`);
            }
        }
    });
    
    // Update co-consecrators
    const coConsecratorInputs = form.querySelectorAll('input[name*="co_consecrators"][name*="input"]');
    coConsecratorInputs.forEach(input => {
        const name = input.value.trim();
        if (bishopMapping[name]) {
            const idInput = input.parentElement.querySelector('input[name*="id"]');
            if (idInput) {
                idInput.value = bishopMapping[name];
                console.log(`ðŸ”„ Updated co-consecrator "${name}" with ID: ${bishopMapping[name]}`);
            } else {
                console.warn(`ðŸ”„ No ID input found for co-consecrator "${name}"`);
            }
        }
    });
    
    console.log('ðŸ”„ Form update with bishop IDs complete');
}

function resetSubmitButton(button, originalText) {
    button.textContent = originalText;
    button.disabled = false;
}

function submitFormWithData(form, formData, submitBtn, originalText) {
    // Submit via fetch
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => {
            console.log('Raw response status:', response.status);
            console.log('Raw response headers:', response.headers);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Form save response:', data);
            if (data.success) {
                // Success - refresh panels smoothly
                console.log('Form saved successfully');
                
                // Instant refresh - no transitions like clergy list
                htmx.ajax('GET', '/editor/clergy-list', {
                    target: '.left-panel .panel-content',
                    swap: 'innerHTML'
                });
                
                // Instant visualization refresh (will be done after specific actions)
                console.log('Refreshing visualization after form save...');
                console.log('HTMX available:', typeof htmx !== 'undefined');
                const visualizationTarget = document.getElementById('visualization-panel-content');
                console.log('Visualization target found:', !!visualizationTarget);
                if (visualizationTarget && typeof htmx !== 'undefined') {
                    // Use the specific visualization panel ID
                    const specificTarget = document.getElementById('visualization-panel-content');
                    if (specificTarget) {
                        htmx.ajax('GET', '/editor/visualization', {
                            target: specificTarget,
                            swap: 'innerHTML'
                        }).then(() => {
                            console.log('Visualization refresh completed');
                        }).catch(error => {
                            console.error('Visualization refresh failed:', error);
                        });
                    }
                } else {
                    console.error('Visualization target not found or HTMX not available!', {
                        target: !!visualizationTarget,
                        htmx: typeof htmx !== 'undefined'
                    });
                }
                
                // Check if the record was marked for deletion
                const markDeletedCheckbox = form.querySelector('input[name="mark_deleted"]');
                const wasMarkedDeleted = markDeletedCheckbox && markDeletedCheckbox.checked;
                console.log('Deletion checkbox found:', !!markDeletedCheckbox);
                console.log('Deletion checkbox checked:', wasMarkedDeleted);
                console.log('Response clergy_id:', data.clergy_id);
                
                if (wasMarkedDeleted) {
                    // Record was marked for deletion - clear form and switch to add mode
                    console.log('Record was marked for deletion, clearing form for new entry');
                    clearFormForNewEntry();
                    
                    // Additional visualization refresh specifically for deletion
                    console.log('Additional visualization refresh for deletion...');
                    setTimeout(() => {
                        const visualizationTarget = document.getElementById('visualization-panel-content');
                        console.log('Deletion visualization target found:', !!visualizationTarget);
                        console.log('HTMX available for deletion refresh:', typeof htmx !== 'undefined');
                        if (visualizationTarget && typeof htmx !== 'undefined') {
                            // Use the specific visualization panel ID
                            const specificTarget = document.getElementById('visualization-panel-content');
                            if (specificTarget) {
                                htmx.ajax('GET', '/editor/visualization', {
                                    target: specificTarget,
                                    swap: 'innerHTML'
                                }).then(() => {
                                    console.log('Deletion visualization refresh completed');
                                }).catch(error => {
                                    console.error('Deletion visualization refresh failed:', error);
                                });
                            }
                        } else {
                            console.error('Deletion visualization target not found or HTMX not available!', {
                                target: !!visualizationTarget,
                                htmx: typeof htmx !== 'undefined'
                            });
                        }
                    }, 500); // Small delay to ensure the deletion is processed
                    
                    showNotification('Record marked for deletion. Form cleared for new entry.', 'info');
                } else                 if (data.clergy_id) {
                    // Normal save - switch to edit mode and refresh the form
                    console.log('Switching to edit mode for clergy ID:', data.clergy_id);
                    switchToEditMode(data.clergy_id);
                    showNotification('Clergy record saved successfully!', 'success');
                    
                    // Dispatch custom event for clergy update
                    document.body.dispatchEvent(new CustomEvent('clergyUpdated', {
                        detail: { 
                            clergyId: data.clergy_id,
                            action: 'updated'
                        }
                    }));
                } else {
                    // Fallback - just show success message
                    console.log('No clergy_id in response, showing generic success message');
                    showNotification('Clergy record saved successfully!', 'success');
                    
                    // Dispatch custom event for clergy creation
                    document.body.dispatchEvent(new CustomEvent('clergyUpdated', {
                        detail: { 
                            action: 'created'
                        }
                    }));
                }
                
            } else {
                throw new Error(data.message || 'Failed to save clergy record');
            }
        })
        .catch(error => {
            console.error('Form submission error:', error);
            if (error instanceof SyntaxError) {
                console.error('JSON parsing error - response was not valid JSON');
                showNotification('Error: Server returned invalid response', 'error');
            } else {
                showNotification('Error saving record: ' + error.message, 'error');
            }
        })
        .finally(() => {
            // Reset button - check if submitBtn exists
            if (submitBtn) {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
}

// HTMX event handling with form initialization
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.target.closest('#clergyFormContainer')) {
        console.log('ðŸ”„ HTMX: Clergy form content loaded instantly');
        
        // Initialize the form after HTMX loads it - immediate execution
        console.log('ðŸ”„ HTMX: Checking for initialization function...');
        
        // Check if we have initialization functions available
        if (typeof window.initializeFormFromRank === 'function') {
            console.log('ðŸ”„ HTMX: Calling window.initializeFormFromRank()');
            window.initializeFormFromRank();
        } else {
            console.log('ðŸ”„ HTMX: initializeFormFromRank not available, triggering rank change event');
            // Initialize directly if the functions are in the loaded content
            const rankSelect = document.getElementById('rank');
            if (rankSelect && rankSelect.value) {
                console.log('ðŸ”„ HTMX: Triggering change event on rank select');
                rankSelect.dispatchEvent(new Event('change'));
            }
        }
        
        // Initialize clergy autocomplete for HTMX-loaded content
        console.log('ðŸ”„ HTMX: Initializing clergy autocomplete...');
        
        // Wait a bit for the embedded form script to load
        setTimeout(() => {
            console.log('ðŸ”„ HTMX: Checking for autocomplete functions after delay...');
            console.log('ðŸ”„ HTMX: initializeClergyAutocomplete available:', typeof window.initializeClergyAutocomplete);
            console.log('ðŸ”„ HTMX: initializeSingleClergyAutocomplete available:', typeof window.initializeSingleClergyAutocomplete);
            
            if (typeof window.initializeClergyAutocomplete === 'function') {
                console.log('ðŸ”„ HTMX: Calling window.initializeClergyAutocomplete()');
                window.initializeClergyAutocomplete();
            } else if (typeof window.initializeSingleClergyAutocomplete === 'function') {
                console.log('ðŸ”„ HTMX: Using fallback with initializeSingleClergyAutocomplete');
                const clergyInputs = document.querySelectorAll('input[name*="ordaining_bishop_input"], input[name*="consecrator_input"], input[name*="co_consecrators"][name*="input"]');
                console.log('ðŸ”„ HTMX: Found clergy inputs:', clergyInputs.length);
                clergyInputs.forEach(input => {
                    if (!input.hasAttribute('data-autocomplete-initialized')) {
                        console.log('ðŸ”„ HTMX: Initializing input:', input.name);
                        window.initializeSingleClergyAutocomplete(input);
                    }
                });
            } else {
                console.log('ðŸ”„ HTMX: No autocomplete functions available, trying direct initialization');
                // Direct initialization as last resort
                const clergyInputs = document.querySelectorAll('input[name*="ordaining_bishop_input"], input[name*="consecrator_input"], input[name*="co_consecrators"][name*="input"]');
                console.log('ðŸ”„ HTMX: Found clergy inputs for direct init:', clergyInputs.length);
                clergyInputs.forEach(input => {
                    if (!input.hasAttribute('data-autocomplete-initialized')) {
                        console.log('ðŸ”„ HTMX: Direct initializing input:', input.name);
                        // Direct initialization logic here
                        initializeClergyAutocompleteDirect(input);
                    }
                });
            }
        }, 200);
    }
});

// Switch form to edit mode after saving a new clergy record
function switchToEditMode(clergyId) {
    console.log('ðŸ”„ switchToEditMode called with clergy ID:', clergyId);
    
    // Use the same mechanism as selecting a clergy member for editing
    // This will trigger the proper HTMX request to load the edit form
    if (typeof selectClergy === 'function') {
        selectClergy(clergyId);
    } else {
        console.error('ðŸ”„ selectClergy function not found, falling back to manual approach');
        // Fallback: manually trigger the HTMX request
        htmx.ajax('GET', `/editor/clergy-form/${clergyId}`, {
            target: '.right-panel .panel-content',
            swap: 'innerHTML'
        });
    }
}

// Clear form and switch to add mode after deletion
function clearFormForNewEntry() {
    console.log('ðŸ”„ clearFormForNewEntry called - triggering selectClergy(null)');
    
    // Use the same mechanism as the "Add New Clergy" button
    // This will trigger the proper HTMX request to load the empty form
    if (typeof selectClergy === 'function') {
        selectClergy(null);
    } else {
        console.error('ðŸ”„ selectClergy function not found, falling back to manual approach');
        // Fallback: manually trigger the HTMX request
        htmx.ajax('GET', '/editor/clergy-form', {
            target: '.right-panel .panel-content',
            swap: 'innerHTML'
        });
    }
}

// Simple instant refresh function
function refreshClergyForm(clergyId = null) {
    const container = document.querySelector('#clergyFormContainer .form-content-loader');
    if (!container) return;
    
    const url = clergyId ? 
        `/editor/clergy-form-content/${clergyId}` : 
        '/editor/clergy-form-content';
    
    // Instant HTMX load - no transitions
    htmx.ajax('GET', url, {
        target: container,
        swap: 'innerHTML'
    });
}

// Make functions globally available
window.refreshClergyFormSmooth = refreshClergyForm;
window.switchToEditMode = switchToEditMode;
window.clearFormForNewEntry = clearFormForNewEntry;

// Add test functions for debugging
window.testSwitchToEditMode = function() {
    console.log('Testing switchToEditMode with ID 1');
    switchToEditMode(1);
};

window.testClearFormForNewEntry = function() {
    console.log('Testing clearFormForNewEntry');
    clearFormForNewEntry();
};

window.testVisualizationRefresh = function() {
    console.log('Testing visualization refresh...');
    console.log('HTMX available:', typeof htmx !== 'undefined');
    const visualizationTarget = document.getElementById('visualization-panel-content');
    console.log('Visualization target found:', !!visualizationTarget);
    if (visualizationTarget && typeof htmx !== 'undefined') {
        // Use the specific visualization panel ID
        const specificTarget = document.getElementById('visualization-panel-content');
        if (specificTarget) {
            htmx.ajax('GET', '/editor/visualization', {
                target: specificTarget,
                swap: 'innerHTML'
            }).then(() => {
                console.log('Test visualization refresh completed');
            }).catch(error => {
                console.error('Test visualization refresh failed:', error);
            });
        }
    } else {
        console.error('Test visualization target not found or HTMX not available!', {
            target: !!visualizationTarget,
            htmx: typeof htmx !== 'undefined'
        });
    }
};

console.log('Form functions available:', {
    refreshClergyFormSmooth: typeof window.refreshClergyFormSmooth,
    switchToEditMode: typeof window.switchToEditMode,
    clearFormForNewEntry: typeof window.clearFormForNewEntry
});

// Direct autocomplete initialization as fallback
function initializeClergyAutocompleteDirect(input) {
    if (input.hasAttribute('data-autocomplete-initialized')) {
        return;
    }
    
    const dropdown = input.parentElement.querySelector('.autocomplete-dropdown');
    if (!dropdown) {
        console.log('No dropdown found for direct init:', input.name);
        return;
    }
    
    console.log('Direct initializing autocomplete for:', input.name);
    input.setAttribute('data-autocomplete-initialized', 'true');
    
    input.addEventListener('input', function() {
        const query = this.value.trim();
        console.log('Direct input event for', this.name, 'query:', query);
        
        if (query.length < 2) {
            dropdown.style.display = 'none';
            return;
        }
        
        // Use fetch for direct initialization
        fetch(`/api/search_bishops?q=${encodeURIComponent(query)}`)
            .then(response => response.text())
            .then(html => {
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
                
                // Attach click handlers
                const results = dropdown.querySelectorAll('.bishop-search-result');
                results.forEach(result => {
                    result.addEventListener('click', function() {
                        const bishopId = this.dataset.id;
                        const bishopName = this.dataset.displayName || this.dataset.name;
                        
                        input.value = bishopName;
                        const hiddenInput = input.parentElement.querySelector('input[type="hidden"]');
                        if (hiddenInput) {
                            hiddenInput.value = bishopId;
                        }
                        
                        dropdown.style.display = 'none';
                    });
                });
            })
            .catch(error => {
                console.error('Error fetching bishops:', error);
            });
    });
    
    input.addEventListener('blur', function() {
        setTimeout(() => {
            dropdown.style.display = 'none';
        }, 200);
    });
    
    input.addEventListener('focus', function() {
        if (this.value.trim().length >= 2) {
            this.dispatchEvent(new Event('input'));
        }
    });
}

// Simple instant notification system
function showNotification(message, type = 'info') {
    // Just log to console - no visual distraction
    console.log(`${type.toUpperCase()}: ${message}`);
    
    // Optionally show a very brief, instant alert that auto-closes
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? 'rgba(46, 160, 67, 0.9)' : 'rgba(231, 76, 60, 0.9)'};
        color: white;
        padding: 0.5em 1em;
        border-radius: 4px;
        z-index: 9999;
        font-size: 0.8em;
        opacity: 1;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Auto remove quickly
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 1500);
}
</script>