<!-- Clergy List Panel Content -->
<div style="padding: 1em;">
    <!-- Search and Filter -->
    <div style="margin-bottom: 1em;">
        <div style="margin-bottom: 0.75em;">
            <div style="position: relative;">
                <input type="text" id="clergySearchInput" value="{{ search or '' }}" 
                       placeholder="Search clergy..." 
                       style="width: 100%; padding: 0.5em 2em 0.5em 0.75em; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; font-size: 0.9em;">
                <button type="button" id="clearSearchBtn" style="position: absolute; right: 0.5em; top: 50%; transform: translateY(-50%); background: none; border: none; color: rgba(255, 255, 255, 0.6); cursor: pointer; display: none;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Quick Filters -->
            <div style="margin-top: 0.5em; font-size: 0.8em;">
                <label style="display: inline-flex; align-items: center; margin-right: 1em; color: rgba(255, 255, 255, 0.8);">
                    <input type="checkbox" id="excludePriests" 
                           style="margin-right: 0.25em;" onchange="applyFilters()">
                    Hide Priests
                </label>
                <label style="display: inline-flex; align-items: center; margin-right: 1em; color: rgba(255, 255, 255, 0.8);">
                    <input type="checkbox" id="showDeleted" 
                           style="margin-right: 0.25em;" onchange="applyFilters()">
                    Show Deleted
                </label>
            </div>
        </div>
    </div>

    <!-- Bulk Actions (shown when showing deleted records) -->
    <div id="bulk-actions" style="margin-bottom: 1em; padding: 0.5em; background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3); border-radius: 4px; display: none;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 0.75em;">
                <label style="display: flex; align-items: center; color: rgba(255, 255, 255, 0.9); font-size: 0.8em;">
                    <input type="checkbox" id="select-all" onchange="toggleSelectAll()" style="margin-right: 0.4em;">
                    Select All
                </label>
                <span id="selected-count" style="color: rgba(255, 255, 255, 0.7); font-size: 0.75em;">0 selected</span>
            </div>
            <div style="display: flex; gap: 0.5em;">
                <button onclick="permanentlyDeleteSelected()" 
                        style="padding: 0.3em 0.6em; background: rgba(255, 0, 0, 0.3); border: 1px solid rgba(255, 0, 0, 0.5); border-radius: 3px; color: rgba(255, 255, 255, 0.9); cursor: pointer; font-size: 0.75em; white-space: nowrap;"
                        onmouseover="this.style.background='rgba(255, 0, 0, 0.5)'"
                        onmouseout="this.style.background='rgba(255, 0, 0, 0.3)'">
                    <i class="fas fa-trash" style="margin-right: 0.25em;"></i>Delete Selected
                </button>
                <button onclick="clearSelection()" 
                        style="padding: 0.3em 0.6em; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 3px; color: rgba(255, 255, 255, 0.9); cursor: pointer; font-size: 0.75em; white-space: nowrap;">
                    Clear
                </button>
            </div>
        </div>
    </div>

    <!-- Clergy List -->
    <div id="clergyListContainer" style="max-height: calc(100vh - 200px); overflow-y: auto;">
        {% for clergy in clergy_list %}
        <div class="clergy-item" 
             data-clergy-id="{{ clergy.id }}"
             data-name="{{ clergy.name }}"
             data-rank="{{ clergy.rank }}"
             data-organization="{{ clergy.organization or '' }}"
             data-is-deleted="{{ clergy.is_deleted|lower }}"
             data-has-ordinations="{{ (clergy.ordinations|length > 0)|lower }}"
             data-has-consecrations="{{ (clergy.consecrations|length > 0)|lower }}"
             onclick="selectClergy({{ clergy.id }})"
             style="display: flex; align-items: center; padding: 0.75em; margin-bottom: 0.5em; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; {% if clergy.is_deleted %}opacity: 0.6; border-left: 4px solid rgba(255, 0, 0, 0.5);{% endif %}"
             onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'"
             onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'">
            
            <!-- Selection Checkbox (only for deleted records) -->
            {% if show_deleted and clergy.is_deleted %}
            <div style="margin-right: 0.75em; flex-shrink: 0;" onclick="event.stopPropagation();">
                <input type="checkbox" class="clergy-select" data-clergy-id="{{ clergy.id }}" 
                       onchange="updateSelection()" style="transform: scale(1.2); cursor: pointer;">
            </div>
            {% endif %}
            
            <!-- Clergy Photo -->
            <div style="margin-right: 0.75em; flex-shrink: 0;">
                {% if clergy.image_url %}
                    <img src="{{ clergy.image_url }}" alt="{{ clergy.name }}" 
                         style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255, 255, 255, 0.2);">
                {% else %}
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); display: flex; align-items: center; justify-content: center; border: 2px solid rgba(255, 255, 255, 0.2);">
                        <i class="fas fa-user" style="color: rgba(255, 255, 255, 0.5); font-size: 0.9em;"></i>
                    </div>
                {% endif %}
            </div>
            
            <!-- Clergy Info -->
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 500; color: rgba(255, 255, 255, 0.95); font-size: 0.9em; margin-bottom: 0.25em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    {{ clergy.name }}
                    {% if clergy.is_deleted %}
                    <span style="color: rgba(255, 0, 0, 0.8); font-size: 0.8em; margin-left: 0.5em;">[DELETED]</span>
                    {% endif %}
                </div>
                <div style="font-size: 0.75em; color: rgba(255, 255, 255, 0.6);">
                    {{ clergy.rank }}{% if clergy.organization %} Â· {{ clergy.organization }}{% endif %}
                </div>
                {% if clergy.date_of_birth or clergy.date_of_death %}
                <div style="font-size: 0.7em; color: rgba(255, 255, 255, 0.5); margin-top: 0.25em;">
                    {% if clergy.date_of_birth %}{{ clergy.date_of_birth.strftime('%Y') }}{% endif %}{% if clergy.date_of_death %} - {{ clergy.date_of_death.strftime('%Y') }}{% endif %}
                </div>
                {% endif %}
                {% if clergy.is_deleted and clergy.deleted_at %}
                <div style="font-size: 0.7em; color: rgba(255, 0, 0, 0.7); margin-top: 0.25em;">
                    Deleted: {{ clergy.deleted_at.strftime('%Y-%m-%d %H:%M') }}
                </div>
                {% endif %}
            </div>
            
            <!-- Status Indicators -->
            <div style="margin-left: 0.5em; display: flex; flex-direction: column; gap: 0.25em;">
                {% if clergy.ordinations %}
                <div style="width: 8px; height: 8px; background: #000000; border-radius: 50%;" title="Has Ordinations"></div>
                {% endif %}
                {% if clergy.consecrations %}
                <div style="width: 8px; height: 8px; background: #27ae60; border-radius: 50%;" title="Has Consecrations"></div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        
        {% if not clergy_list %}
        <div id="noResultsMessage" style="text-align: center; padding: 2em; color: rgba(255, 255, 255, 0.6);">
            {% if show_deleted %}
            <i class="fas fa-trash" style="font-size: 2em; margin-bottom: 0.5em; opacity: 0.5;"></i>
            <div>No deleted clergy records found</div>
            <small style="color: rgba(255, 255, 255, 0.4);">All clergy records are currently active</small>
            {% else %}
            <i class="fas fa-search" style="font-size: 2em; margin-bottom: 0.5em; opacity: 0.5;"></i>
            <div>No clergy found</div>
            {% if search %}
            <small style="color: rgba(255, 255, 255, 0.4);">Try a different search term</small>
            {% endif %}
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Add New Button -->
    {% if user and user.can_edit_clergy() %}
    <div style="padding: 1em 0; border-top: 1px solid rgba(255, 255, 255, 0.1); margin-top: 1em;">
        <button onclick="selectClergy(null)" 
                style="width: 100%; padding: 0.75em; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 6px; color: rgba(255, 255, 255, 0.9); cursor: pointer; font-size: 0.9em; transition: all 0.2s ease;"
                onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'"
                onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">
            <i class="fas fa-plus" style="margin-right: 0.5em;"></i>Add New Clergy
        </button>
    </div>
    {% endif %}
</div>

<script>
// Store all clergy data for client-side filtering
let allClergyData = [];

// Initialize clergy data from DOM
function initializeClergyData() {
    allClergyData = Array.from(document.querySelectorAll('.clergy-item')).map(item => ({
        id: parseInt(item.dataset.clergyId),
        name: item.dataset.name,
        rank: item.dataset.rank,
        organization: item.dataset.organization,
        isDeleted: item.dataset.isDeleted === 'true',
        hasOrdinations: item.dataset.hasOrdinations === 'true',
        hasConsecrations: item.dataset.hasConsecrations === 'true',
        element: item
    }));
}

// Fuzzy search and filter function
function applyFilters() {
    const searchTerm = document.getElementById('clergySearchInput').value.trim();
    const excludePriests = document.getElementById('excludePriests').checked;
    const showDeleted = document.getElementById('showDeleted').checked;
    const clearBtn = document.getElementById('clearSearchBtn');
    const noResultsMessage = document.getElementById('noResultsMessage');
    const bulkActions = document.getElementById('bulk-actions');
    
    // Show/hide clear button
    if (searchTerm.length > 0) {
        clearBtn.style.display = 'block';
    } else {
        clearBtn.style.display = 'none';
    }
    
    // Show/hide bulk actions based on show deleted filter
    if (bulkActions) {
        bulkActions.style.display = showDeleted ? 'block' : 'none';
    }
    
    let filteredData = allClergyData;
    
    // Apply deleted filter
    if (!showDeleted) {
        filteredData = filteredData.filter(clergy => !clergy.isDeleted);
    } else {
        filteredData = filteredData.filter(clergy => clergy.isDeleted);
    }
    
    // Apply priest filter
    if (excludePriests) {
        filteredData = filteredData.filter(clergy => clergy.rank !== 'Priest');
    }
    
    // Apply fuzzy search
    if (searchTerm) {
        console.log('Applying search for:', searchTerm, 'on', filteredData.length, 'items');
        if (typeof window.fuzzySearch === 'function') {
            console.log('Using fuzzy search');
            const searchResults = window.fuzzySearch(filteredData, searchTerm, clergy => clergy.name);
            console.log('Fuzzy search results:', searchResults.length);
            filteredData = searchResults.map(result => result.item);
        } else {
            console.log('Using fallback search');
            // Fallback to simple substring search if fuzzy search not available
            const normalizedSearch = searchTerm.toLowerCase();
            filteredData = filteredData.filter(clergy => 
                clergy.name.toLowerCase().includes(normalizedSearch) ||
                (clergy.organization && clergy.organization.toLowerCase().includes(normalizedSearch))
            );
        }
        console.log('Final filtered results:', filteredData.length);
    }
    
    // Update visibility of clergy items
    allClergyData.forEach(clergy => {
        const isVisible = filteredData.includes(clergy);
        clergy.element.style.display = isVisible ? 'flex' : 'none';
    });
    
    // Show/hide no results message
    const visibleCount = filteredData.length;
    if (noResultsMessage) {
        if (visibleCount === 0) {
            noResultsMessage.style.display = 'block';
            if (searchTerm) {
                noResultsMessage.innerHTML = `
                    <i class="fas fa-search" style="font-size: 2em; margin-bottom: 0.5em; opacity: 0.5;"></i>
                    <div>No clergy found</div>
                    <small style="color: rgba(255, 255, 255, 0.4);">Try a different search term</small>
                `;
            } else if (showDeleted) {
                noResultsMessage.innerHTML = `
                    <i class="fas fa-trash" style="font-size: 2em; margin-bottom: 0.5em; opacity: 0.5;"></i>
                    <div>No deleted clergy records found</div>
                    <small style="color: rgba(255, 255, 255, 0.4);">All clergy records are currently active</small>
                `;
            }
        } else {
            noResultsMessage.style.display = 'none';
        }
    }
}

// Override the global selectClergy function to include HTMX updates
function selectClergy(clergyId) {
    console.log('Clergy selected:', clergyId);
    
    // Update visual selection
    document.querySelectorAll('.clergy-item').forEach(item => {
        item.style.background = 'rgba(255, 255, 255, 0.05)';
        item.style.borderColor = 'rgba(255, 255, 255, 0.1)';
    });
    
    if (clergyId) {
        const selectedItem = document.querySelector(`[onclick="selectClergy(${clergyId})"]`);
        if (selectedItem) {
            selectedItem.style.background = 'rgba(255, 255, 255, 0.15)';
            selectedItem.style.borderColor = 'rgba(255, 255, 255, 0.3)';
        }
        
        // Load clergy form for editing instantly
        htmx.ajax('GET', `/editor/clergy-form/${clergyId}`, {
            target: '.right-panel .panel-content',
            swap: 'innerHTML'
        });
    } else {
        // Load empty form for adding new clergy instantly
        htmx.ajax('GET', '/editor/clergy-form', {
            target: '.right-panel .panel-content',
            swap: 'innerHTML'
        });
    }
    
    // Refresh visualization to highlight selected clergy
    // You could add visualization update logic here
}

// Bulk selection functions
function updateSelection() {
    const checkboxes = document.querySelectorAll('.clergy-select:checked');
    const count = checkboxes.length;
    const bulkActions = document.getElementById('bulk-actions');
    const selectedCount = document.getElementById('selected-count');
    
    if (selectedCount) {
        selectedCount.textContent = `${count} selected`;
    }
    
    if (bulkActions) {
        bulkActions.style.display = count > 0 ? 'block' : 'none';
    }
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.clergy-select');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateSelection();
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.clergy-select');
    const selectAllCheckbox = document.getElementById('select-all');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
    }
    
    updateSelection();
}

function permanentlyDeleteSelected() {
    const checkboxes = document.querySelectorAll('.clergy-select:checked');
    const clergyIds = Array.from(checkboxes).map(cb => cb.dataset.clergyId);
    
    if (clergyIds.length === 0) {
        alert('Please select at least one record to delete.');
        return;
    }
    
    // Get the names of the records being deleted for confirmation
    const selectedItems = Array.from(checkboxes).map(cb => {
        const item = cb.closest('.clergy-item');
        const nameElement = item.querySelector('div[style*=\"font-weight: 500\"]');
        return nameElement ? nameElement.textContent.trim() : 'Unknown';
    });
    
    const confirmMessage = `Are you sure you want to permanently delete these ${clergyIds.length} record(s)?\n\n${selectedItems.join(', ')}\n\nThis action cannot be undone.`;
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // Show loading state
    const deleteButton = event.target;
    const originalText = deleteButton.innerHTML;
    deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.25em;"></i>Deleting...';
    deleteButton.disabled = true;
    
    // Send delete request
    fetch('/editor/permanently-delete-clergy', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ clergy_ids: clergyIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove deleted items from the list
            clergyIds.forEach(id => {
                const item = document.querySelector(`[data-clergy-id="${id}"]`);
                if (item) {
                    item.remove();
                }
            });
            
            // Reinitialize data after deletion
            initializeClergyData();
            
            // Update selection
            updateSelection();
            
            // Show success message
            alert(`Successfully deleted ${data.deleted_count} record(s).`);
        } else {
            alert('Error: ' + (data.message || 'Failed to delete records.'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting records. Please try again.');
    })
    .finally(() => {
        // Restore button state
        deleteButton.innerHTML = originalText;
        deleteButton.disabled = false;
    });
}

// Initialize when DOM is loaded
function initializeClergyList() {
    console.log('Initializing clergy list...');
    
    // Initialize clergy data
    initializeClergyData();
    console.log('Clergy data initialized:', allClergyData.length, 'items');
    
    // Set up search input event listener
    const searchInput = document.getElementById('clergySearchInput');
    const clearBtn = document.getElementById('clearSearchBtn');
    
    if (searchInput) {
        console.log('Setting up search input listener');
        searchInput.addEventListener('input', applyFilters);
        
        // Clear search functionality
        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                applyFilters();
            });
        }
    } else {
        console.error('Search input not found!');
    }
    
    // Apply initial filters to set correct state
    applyFilters();
    
    // Initialize bulk actions visibility
    updateSelection();
    
    console.log('Clergy list initialization complete');
}

// Try multiple initialization approaches
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeClergyList);
} else {
    // DOM already loaded
    initializeClergyList();
}

// Also try after a short delay in case HTMX is still loading content
setTimeout(initializeClergyList, 100);
</script>