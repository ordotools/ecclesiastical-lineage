<!-- Clergy List Panel Content with Internal Grid -->
<div class="clergy-panel-container">
    <!-- Top Section: Clergy List -->
    <div class="clergy-list-section">
        <div class="panel-padding" style="height: 100%;">
    <!-- Search and Filter -->
    <div class="editor-margin-bottom-l">
        <div class="editor-margin-bottom-m">
            <div class="editor-search-wrapper">
                <input type="text" id="clergySearchInput" value="{{ search or '' }}" 
                       placeholder="Search clergy..." 
                       class="editor-search-input">
                <button type="button" id="clearSearchBtn" class="editor-search-clear">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Quick Filters and Add Button -->
            <div class="editor-filter-controls editor-margin-top-s">
                <div>
                    <label class="editor-filter-checkbox">
                        <input type="checkbox" id="excludePriests" onchange="applyFilters()">
                        Hide Priests
                    </label>
                    <label class="editor-filter-checkbox">
                        <input type="checkbox" id="showDeleted" onchange="applyFilters()">
                        Show Deleted
                    </label>
                </div>
                {% if user and user.can_edit_clergy() %}
                <button onclick="selectClergyFromList(null)" class="btn-panel btn-small">
                    <i class="fas fa-plus"></i>Add New
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Bulk Actions (shown when showing deleted records) -->
    <div id="bulk-actions" class="bulk-actions">
        <div class="bulk-actions-content">
            <div class="bulk-actions-left">
                <label class="bulk-actions-label">
                    <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                    Select All
                </label>
                <span id="selected-count" class="bulk-actions-count">0 selected</span>
            </div>
            <div class="bulk-actions-right">
                <button onclick="permanentlyDeleteSelected()" class="btn-bulk-danger">
                    <i class="fas fa-trash"></i>Delete Selected
                </button>
                <button onclick="clearSelection()" class="btn-section btn-small">
                    Clear
                </button>
            </div>
        </div>
    </div>

    <!-- Clergy List -->
    <div id="clergyListContainer" class="clergy-list-container">
        {% for clergy in clergy_list %}
        <div class="clergy-item clergy-item-card {% if clergy.is_deleted %}clergy-item-deleted{% endif %}" 
             data-clergy-id="{{ clergy.id }}"
             data-name="{{ clergy.name }}"
             data-rank="{{ clergy.rank }}"
             data-organization="{{ clergy.organization or '' }}"
             data-is-deleted="{{ clergy.is_deleted|lower }}"
             data-has-ordinations="{{ (clergy.ordinations|length > 0)|lower }}"
             data-has-consecrations="{{ (clergy.consecrations|length > 0)|lower }}"
             onclick="selectClergyFromList({{ clergy.id }}); return false;">
            
            <!-- Selection Checkbox (only for deleted records) -->
            {% if show_deleted and clergy.is_deleted %}
            <div class="clergy-item-photo" onclick="event.stopPropagation();">
                <input type="checkbox" class="clergy-select" data-clergy-id="{{ clergy.id }}" 
                       onchange="updateSelection()" style="transform: scale(1.2); cursor: pointer;">
            </div>
            {% endif %}
            
            <!-- Clergy Photo -->
            <div class="clergy-item-photo">
                {% if sprite_sheet_data and sprite_sheet_data.mapping.get(clergy.id) %}
                    {% set position = sprite_sheet_data.mapping[clergy.id] %}
                    {% set x_pos = position[0] %}
                    {% set y_pos = position[1] %}
                    {% set thumb_size = sprite_sheet_data.thumbnail_size %}
                    <div class="clergy-item-photo-sprite" 
                         style="background-image: url('{{ sprite_sheet_data.url }}'); 
                                background-position: -{{ x_pos }}px -{{ y_pos }}px; 
                                background-size: {{ sprite_sheet_data.sprite_width }}px {{ sprite_sheet_data.sprite_height }}px;
                                width: {{ thumb_size }}px; 
                                height: {{ thumb_size }}px;
                                border-radius: 50%;
                                background-repeat: no-repeat;">
                    </div>
                {% elif clergy.image_url %}
                    <img src="{{ clergy.image_url }}" alt="{{ clergy.name }}">
                {% else %}
                    <div class="clergy-item-photo-placeholder">
                        <i class="fas fa-user"></i>
                    </div>
                {% endif %}
            </div>
            
            <!-- Clergy Info -->
            <div class="clergy-item-info">
                <div class="clergy-item-name">
                    {{ clergy.name }}
                    {% if clergy.is_deleted %}
                    <span style="color: rgba(255, 0, 0, 0.8); font-size: 0.8em; margin-left: 0.5em;">[DELETED]</span>
                    {% endif %}
                </div>
                <div class="clergy-item-details">
                    {{ clergy.rank }}{% if clergy.organization %} ¬∑ {{ clergy.organization }}{% endif %}
                </div>
                {% if clergy.date_of_birth or clergy.date_of_death %}
                <div class="clergy-item-meta">
                    {% if clergy.date_of_birth %}{{ clergy.date_of_birth.strftime('%Y') }}{% endif %}{% if clergy.date_of_death %} - {{ clergy.date_of_death.strftime('%Y') }}{% endif %}
                </div>
                {% endif %}
                {% if clergy.is_deleted and clergy.deleted_at %}
                <div class="clergy-item-meta" style="color: rgba(255, 0, 0, 0.7);">
                    Deleted: {{ clergy.deleted_at.strftime('%Y-%m-%d %H:%M') }}
                </div>
                {% endif %}
            </div>
            
            <!-- Status Indicators -->
            <div class="clergy-item-status">
                <!-- Ordination/Consecration indicators -->
                <div class="editor-flex-column editor-gap-xs">
                    {% if clergy.ordinations %}
                    <div class="clergy-status-indicator ordinations" title="Has Ordinations"></div>
                    {% endif %}
                    {% if clergy.consecrations %}
                    <div class="clergy-status-indicator consecrations" title="Has Consecrations"></div>
                    {% endif %}
                </div>
                <!-- Clergy Status Badges -->
                {% if clergy.statuses %}
                <div class="clergy-status-badges">
                    {% for status in clergy.statuses[:3] %}
                    <div class="clergy-status-badge" style="background: {{ status.color }};" title="{{ status.name }}: {{ status.description }}">
                        <i class="fas {{ status.icon }}"></i>
                    </div>
                    {% endfor %}
                    {% if clergy.statuses|length > 3 %}
                    <span class="clergy-status-more" title="{{ clergy.statuses|length - 3 }} more status(es)">+{{ clergy.statuses|length - 3 }}</span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        
        {% if not clergy_list %}
        <div id="noResultsMessage" class="clergy-list-empty">
            {% if show_deleted %}
            <i class="fas fa-trash"></i>
            <div class="clergy-list-empty-message">No deleted clergy records found</div>
            <small class="clergy-list-empty-hint">All clergy records are currently active</small>
            {% else %}
            <i class="fas fa-search"></i>
            <div class="clergy-list-empty-message">No clergy found</div>
            {% if search %}
            <small class="clergy-list-empty-hint">Try a different search term</small>
            {% endif %}
            {% endif %}
        </div>
        {% endif %}
    </div>

        </div>
    </div>
    
    <!-- Internal Resize Handle -->
    <div class="internal-resize-handle" id="clergy-internal-resizer"></div>
    
    <!-- Bottom Section: Tabs -->
    <div class="clergy-tabs-section" style="background: #2B2E32;">
        <div class="clergy-tabs">
            <button class="clergy-tab active" data-tab="audit-logs">
                <i class="fas fa-history"></i>
                Audit Logs
            </button>
            <button class="clergy-tab" data-tab="comments">
                <i class="fas fa-comments"></i>
                Comments
            </button>
        </div>
        
        <div class="clergy-tab-content active" id="clergy-audit-logs-content">
            <div class="loading-placeholder">
                <div class="loading-spinner"></div>
                Loading audit logs...
            </div>
        </div>
        
        <div class="clergy-tab-content" id="clergy-comments-content"
             hx-get="/editor/comments"
             hx-trigger="revealed"
             hx-target="this"
             hx-swap="innerHTML">
            <div class="loading-placeholder">
                <div class="loading-spinner"></div>
                Loading comments...
            </div>
        </div>
    </div>
</div>

<script type="application/json" id="clergy-list-data-json">{{ clergy_list_data_json|safe }}</script>
<script type="application/json" id="bishop-validity-map-json">{{ bishop_validity_map_json|safe }}</script>

<script>
// Store all clergy data for client-side filtering
if (typeof allClergyData === 'undefined') {
    var allClergyData = [];
}

let clergyListData = [];
let bishopValidityMap = {};
try {
    const clergyDataEl = document.getElementById('clergy-list-data-json');
    const bishopDataEl = document.getElementById('bishop-validity-map-json');
    if (clergyDataEl) {
        clergyListData = JSON.parse(clergyDataEl.textContent || '[]');
    }
    if (bishopDataEl) {
        bishopValidityMap = JSON.parse(bishopDataEl.textContent || '{}');
    }
} catch (error) {
    console.warn('Failed to parse status inheritance data', error);
}

// Initialize clergy data from DOM
function initializeClergyData() {
    allClergyData = Array.from(document.querySelectorAll('.clergy-item')).map(item => ({
        id: parseInt(item.dataset.clergyId),
        name: item.dataset.name,
        rank: item.dataset.rank,
        organization: item.dataset.organization,
        isDeleted: item.dataset.isDeleted === 'true',
        hasOrdinations: item.dataset.hasOrdinations === 'true',
        hasConsecrations: item.dataset.hasConsecrations === 'true',
        element: item
    }));
}

// Fuzzy search and filter function
function applyFilters() {
    const searchTerm = document.getElementById('clergySearchInput').value.trim();
    const excludePriests = document.getElementById('excludePriests').checked;
    const showDeleted = document.getElementById('showDeleted').checked;
    const clearBtn = document.getElementById('clearSearchBtn');
    const noResultsMessage = document.getElementById('noResultsMessage');
    const bulkActions = document.getElementById('bulk-actions');
    
    // Show/hide clear button
    if (searchTerm.length > 0) {
        clearBtn.classList.add('visible');
    } else {
        clearBtn.classList.remove('visible');
    }
    
    // Show/hide bulk actions based on show deleted filter
    if (bulkActions) {
        if (showDeleted) {
            bulkActions.classList.add('visible');
        } else {
            bulkActions.classList.remove('visible');
        }
    }
    
    let filteredData = allClergyData;
    
    // Apply deleted filter
    if (!showDeleted) {
        filteredData = filteredData.filter(clergy => !clergy.isDeleted);
    } else {
        filteredData = filteredData.filter(clergy => clergy.isDeleted);
    }
    
    // Apply priest filter
    if (excludePriests) {
        filteredData = filteredData.filter(clergy => clergy.rank !== 'Priest');
    }
    
    // Apply fuzzy search
    if (searchTerm) {
        console.log('Applying search for:', searchTerm, 'on', filteredData.length, 'items');
        if (typeof window.fuzzySearch === 'function') {
            console.log('Using fuzzy search');
            const searchResults = window.fuzzySearch(filteredData, searchTerm, clergy => clergy.name);
            console.log('Fuzzy search results:', searchResults.length);
            filteredData = searchResults.map(result => result.item);
        } else {
            console.log('Using fallback search');
            // Fallback to simple substring search if fuzzy search not available
            const normalizedSearch = searchTerm.toLowerCase();
            filteredData = filteredData.filter(clergy => 
                clergy.name.toLowerCase().includes(normalizedSearch) ||
                (clergy.organization && clergy.organization.toLowerCase().includes(normalizedSearch))
            );
        }
        console.log('Final filtered results:', filteredData.length);
    }
    
    // Update visibility of clergy items
    allClergyData.forEach(clergy => {
        const isVisible = filteredData.includes(clergy);
        clergy.element.style.display = isVisible ? 'flex' : 'none';
    });
    
    // Show/hide no results message
    const visibleCount = filteredData.length;
    if (noResultsMessage) {
        if (visibleCount === 0) {
            noResultsMessage.style.display = 'block';
            if (searchTerm) {
                noResultsMessage.innerHTML = `
                    <i class="fas fa-search"></i>
                    <div class="clergy-list-empty-message">No clergy found</div>
                    <small class="clergy-list-empty-hint">Try a different search term</small>
                `;
            } else if (showDeleted) {
                noResultsMessage.innerHTML = `
                    <i class="fas fa-trash"></i>
                    <div class="clergy-list-empty-message">No deleted clergy records found</div>
                    <small class="clergy-list-empty-hint">All clergy records are currently active</small>
                `;
            }
        } else {
            noResultsMessage.style.display = 'none';
        }
    }
}

// Clergy list specific selection function
function selectClergyFromList(clergyId) {
    console.log('Clergy selected from list:', clergyId);
    
    // Call the global selectClergy function to handle the form loading and highlighting
    if (typeof window.selectClergy === 'function') {
        window.selectClergy(clergyId);
    } else {
        console.warn('window.selectClergy not available, using fallback');
        // Fallback: load form content directly (skip intermediate template)
        // Clear form state first
        if (typeof window.clearGlobalFormState === 'function') {
            window.clearGlobalFormState();
        }
        
        // Update selected clergy ID
        window.currentSelectedClergyId = clergyId;
        
        if (clergyId) {
            htmx.ajax('GET', `/editor/clergy-form-content/${clergyId}`, {
                target: '.right-panel .panel-content',
                swap: 'innerHTML'
            }).then(() => {
                // Clear form state again after load
                if (typeof window.clearGlobalFormState === 'function') {
                    window.clearGlobalFormState();
                }
                // Highlight in list
                if (typeof window.highlightClergyInList === 'function') {
                    window.highlightClergyInList(clergyId);
                }
            });
        } else {
            htmx.ajax('GET', '/editor/clergy-form-content', {
                target: '.right-panel .panel-content',
                swap: 'innerHTML'
            }).then(() => {
                // Clear form state after load
                if (typeof window.clearGlobalFormState === 'function') {
                    window.clearGlobalFormState();
                }
            });
        }
    }
}

// Bulk selection functions
function updateSelection() {
    const checkboxes = document.querySelectorAll('.clergy-select:checked');
    const count = checkboxes.length;
    const bulkActions = document.getElementById('bulk-actions');
    const selectedCount = document.getElementById('selected-count');
    
    if (selectedCount) {
        selectedCount.textContent = `${count} selected`;
    }
    
    if (bulkActions) {
        if (count > 0) {
            bulkActions.classList.add('visible');
        } else {
            bulkActions.classList.remove('visible');
        }
    }
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.clergy-select');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateSelection();
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.clergy-select');
    const selectAllCheckbox = document.getElementById('select-all');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
    }
    
    updateSelection();
}

function permanentlyDeleteSelected() {
    const checkboxes = document.querySelectorAll('.clergy-select:checked');
    const clergyIds = Array.from(checkboxes).map(cb => cb.dataset.clergyId);
    
    if (clergyIds.length === 0) {
        alert('Please select at least one record to delete.');
        return;
    }
    
    // Get the names of the records being deleted for confirmation
    const selectedItems = Array.from(checkboxes).map(cb => {
        const item = cb.closest('.clergy-item');
        const nameElement = item.querySelector('div[style*=\"font-weight: 500\"]');
        return nameElement ? nameElement.textContent.trim() : 'Unknown';
    });
    
    const confirmMessage = `Are you sure you want to permanently delete these ${clergyIds.length} record(s)?\n\n${selectedItems.join(', ')}\n\nThis action cannot be undone.`;
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // Show loading state
    const deleteButton = event.target;
    const originalText = deleteButton.innerHTML;
    deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.25em;"></i>Deleting...';
    deleteButton.disabled = true;
    
    // Send delete request
    fetch('/editor/permanently-delete-clergy', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ clergy_ids: clergyIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove deleted items from the list
            clergyIds.forEach(id => {
                const item = document.querySelector(`[data-clergy-id="${id}"]`);
                if (item) {
                    item.remove();
                }
            });
            
            // Reinitialize data after deletion
            initializeClergyData();
            
            // Update selection
            updateSelection();
            
            // Show success message
            alert(`Successfully deleted ${data.deleted_count} record(s).`);
        } else {
            alert('Error: ' + (data.message || 'Failed to delete records.'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting records. Please try again.');
    })
    .finally(() => {
        // Restore button state
        deleteButton.innerHTML = originalText;
        deleteButton.disabled = false;
    });
}

// Initialize when DOM is loaded
function initializeClergyList() {
    console.log('Initializing clergy list...');
    
    // Initialize clergy data
    initializeClergyData();
    console.log('Clergy data initialized:', allClergyData.length, 'items');
    
    // Debug: Check if audit logs tab exists and is still in the DOM (avoid HTMX insertBefore on detached nodes)
    const auditLogsTab = document.getElementById('clergy-audit-logs-content');
    const auditTabInDom = auditLogsTab && document.contains(auditLogsTab);
    console.log('üîç Audit logs tab exists:', !!auditLogsTab, 'in DOM:', !!auditTabInDom);
    if (auditTabInDom) {
        console.log('üîç Attempting to load audit logs content manually...');
        try {
            htmx.ajax('GET', '/editor/audit-logs', {
                target: auditLogsTab,
                swap: 'innerHTML'
            }).then(() => {
                console.log('‚úÖ Manual audit logs load successful');
            }).catch(error => {
                console.error('‚ùå Manual audit logs load failed:', error);
            });
        } catch (error) {
            console.error('‚ùå Error in manual audit logs load:', error);
        }
    }
    
    // Set up search input event listener
    const searchInput = document.getElementById('clergySearchInput');
    const clearBtn = document.getElementById('clearSearchBtn');
    
    if (searchInput) {
        console.log('Setting up search input listener');
        searchInput.addEventListener('input', applyFilters);
        
        // Clear search functionality
        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                applyFilters();
            });
        }
    } else {
        console.error('Search input not found!');
    }
    
    // Apply initial filters to set correct state
    applyFilters();
    
    // Initialize bulk actions visibility
    updateSelection();
    
    // Re-highlight selected clergy after list loads
    if (window.currentSelectedClergyId && typeof window.highlightClergyInList === 'function') {
        setTimeout(() => {
            window.highlightClergyInList(window.currentSelectedClergyId);
        }, 100);
    }

    if (window.StatusInheritance && typeof window.StatusInheritance.flagClergyListWithViolations === 'function') {
        window.StatusInheritance.flagClergyListWithViolations(clergyListData, bishopValidityMap);
    }
    
    console.log('Clergy list initialization complete');
}

// Try multiple initialization approaches
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeClergyList);
} else {
    // DOM already loaded
    initializeClergyList();
}

// Also try after a short delay in case HTMX is still loading content
setTimeout(initializeClergyList, 100);

// Internal panel resizing functionality
if (typeof ClergyPanelResizer === 'undefined') {
class ClergyPanelResizer {
    constructor() {
        this.isResizing = false;
        this.startY = 0;
        this.startHeight = 0;
        this.init();
    }

    init() {
        const resizer = document.getElementById('clergy-internal-resizer');
        if (!resizer) return;

        resizer.addEventListener('mousedown', (e) => this.handleMouseDown(e));
        document.addEventListener('mousemove', (e) => this.handleMouseMove(e));
        document.addEventListener('mouseup', () => this.handleMouseUp());
    }

    handleMouseDown(e) {
        this.isResizing = true;
        this.startY = e.clientY;
        
        const container = document.querySelector('.clergy-panel-container');
        if (!container) return;
        
        // Store initial heights
        const listSection = document.querySelector('.clergy-list-section');
        const tabsSection = document.querySelector('.clergy-tabs-section');
        
        if (listSection && tabsSection) {
            this.startListHeight = listSection.offsetHeight;
            this.startTabsHeight = tabsSection.offsetHeight;
        }
        
        document.body.style.cursor = 'row-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
    }

    handleMouseMove(e) {
        if (!this.isResizing) return;
        
        const deltaY = e.clientY - this.startY;
        const container = document.querySelector('.clergy-panel-container');
        if (!container) return;
        
        const containerHeight = container.offsetHeight;
        const availableHeight = containerHeight - 4; // Subtract resize handle height
        const minListHeight = 150; // Minimum height for clergy list
        const minTabsHeight = 100; // Minimum height for tabs
        
        // Calculate new heights
        let newListHeight = this.startListHeight + deltaY;
        let newTabsHeight = this.startTabsHeight - deltaY;
        
        // Apply constraints
        if (newListHeight < minListHeight) {
            newListHeight = minListHeight;
            newTabsHeight = availableHeight - minListHeight;
        } else if (newTabsHeight < minTabsHeight) {
            newTabsHeight = minTabsHeight;
            newListHeight = availableHeight - minTabsHeight;
        }
        
        // Apply the new layout with fixed resize handle height
        const listRatio = newListHeight / (containerHeight - 4);
        const tabsRatio = newTabsHeight / (containerHeight - 4);
        
        container.style.gridTemplateRows = `${listRatio}fr 4px ${tabsRatio}fr`;
        
        e.preventDefault();
    }

    handleMouseUp() {
        if (!this.isResizing) return;
        
        this.isResizing = false;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
    }
}

// Initialize clergy panel resizer
new ClergyPanelResizer();
}

// Clergy panel tab switching
document.addEventListener('DOMContentLoaded', function() {
    const clergyTabs = document.querySelectorAll('.clergy-tab');
    const clergyTabContents = document.querySelectorAll('.clergy-tab-content');

    clergyTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.dataset.tab;

            // Remove active class from all tabs and contents
            clergyTabs.forEach(t => t.classList.remove('active'));
            clergyTabContents.forEach(content => content.classList.remove('active'));

            // Add active class to clicked tab and corresponding content
            this.classList.add('active');
            const targetContent = document.getElementById('clergy-' + targetTab + '-content');
            if (targetContent) {
                targetContent.classList.add('active');
                
                // Handle audit logs tab specially - load content manually and initialize updater
                if (targetTab === 'audit-logs') {
                    loadAuditLogsContent();
                } else {
                    // Trigger HTMX load if not loaded yet
                    if (targetContent.getAttribute('hx-trigger') === 'revealed') {
                        htmx.trigger(targetContent, 'revealed');
                    }
                }
            }
        });
    });
    
    // Load audit logs content initially since it's the active tab
    console.log('üîç Clergy list initialization complete, calling loadAuditLogsContent...');
    try {
        // Add a small delay to ensure DOM is fully ready
        setTimeout(() => {
            loadAuditLogsContent();
            console.log('üîç loadAuditLogsContent() call completed');
        }, 50);
    } catch (error) {
        console.error('‚ùå Error calling loadAuditLogsContent():', error);
    }
});

// Function to load audit logs content manually
function loadAuditLogsContent() {
    console.log('üîç loadAuditLogsContent() function called');
    const auditLogsContent = document.getElementById('clergy-audit-logs-content');
    console.log('üîç Loading audit logs content...', auditLogsContent);
    
    if (!auditLogsContent) {
        console.log('‚ùå Audit logs content element not found');
        console.log('üîç Available elements with "audit" in ID:', 
            Array.from(document.querySelectorAll('[id*="audit"]')).map(el => el.id));
        console.log('üîç Available elements with "clergy" in ID:', 
            Array.from(document.querySelectorAll('[id*="clergy"]')).map(el => el.id));
        return;
    }
    
    // Check if content is still in loading state (more flexible check)
    const hasLoadingSpinner = auditLogsContent.querySelector('.loading-spinner');
    const hasAuditLogsList = auditLogsContent.querySelector('#audit-logs-list');
    
    if (!hasLoadingSpinner || hasAuditLogsList) {
        console.log('‚è≠Ô∏è Audit logs already loaded or not in loading state');
        return;
    }
    
    console.log('‚úÖ Loading audit logs content via HTMX...');
    
    // Load audit logs content via HTMX with better error handling
    try {
        htmx.ajax('GET', '/editor/audit-logs', {
            target: auditLogsContent,
            swap: 'innerHTML'
        }).then(() => {
            console.log('‚úÖ Audit logs content loaded, initializing smart updater...');
            // Initialize the smart updater after content is loaded
            setTimeout(() => {
                try {
                    if (!window.auditLogsUpdater && window.AuditLogsUpdater) {
                        console.log('üöÄ Creating new AuditLogsUpdater instance...');
                        window.auditLogsUpdater = new window.AuditLogsUpdater();
                    } else {
                        console.log('‚ôªÔ∏è AuditLogsUpdater already exists, skipping creation');
                    }
                } catch (error) {
                    console.error('‚ùå Error initializing AuditLogsUpdater:', error);
                }
            }, 100);
        }).catch(error => {
            console.error('‚ùå Error loading audit logs content:', error);
            // Show error message in the content area
            auditLogsContent.innerHTML = '<div style="text-align: center; padding: 1em; color: rgba(255, 255, 255, 0.6); font-size: 0.8em;">Error loading audit logs. Please try again.</div>';
        });
    } catch (error) {
        console.error('‚ùå Error in loadAuditLogsContent:', error);
        auditLogsContent.innerHTML = '<div style="text-align: center; padding: 1em; color: rgba(255, 255, 255, 0.6); font-size: 0.8em;">Error loading audit logs. Please try again.</div>';
    }
}
</script>