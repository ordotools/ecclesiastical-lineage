<!-- Settings Panel for Editor Interface -->
<div class="settings-panel">
  <!-- User Info Section -->
  <div class="settings-section mb-4">
    <div class="settings-section-header">
      <i class="fas fa-user"></i>
      <h4>Account Information</h4>
    </div>
    <div class="settings-content">
      <div class="user-info-grid">
        <div class="user-info-item">
          <label>Username:</label>
          <span>{{ user.username }}</span>
        </div>
        <div class="user-info-item">
          <label>Full Name:</label>
          <span>{{ user.full_name or 'Not specified' }}</span>
        </div>
        <div class="user-info-item">
          <label>Email:</label>
          <span>{{ user.email or 'Not specified' }}</span>
        </div>
        <div class="user-info-item">
          <label>Role:</label>
          <span class="role-badge">{{ user.role.name }}</span>
        </div>
        <div class="user-info-item">
          <label>Account Status:</label>
          <span class="status-badge {{ 'active' if user.is_active else 'inactive' }}">
            {{ 'Active' if user.is_active else 'Inactive' }}
          </span>
        </div>
        <div class="user-info-item">
          <label>Member Since:</label>
          <span>{{ user.created_at.strftime('%Y-%m-%d') }}</span>
        </div>
        <div class="user-info-item">
          <label>Last Login:</label>
          <span>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</span>
        </div>
      </div>
      
      <!-- Permissions List -->
      <div class="permissions-section">
        <h5>Permissions</h5>
        <div class="permissions-list">
          {% if user.can_edit_clergy() %}
          <div class="permission-item">
            <i class="fas fa-check"></i>
            <span>Edit clergy records</span>
          </div>
          {% endif %}
          {% if user.can_delete_clergy() %}
          <div class="permission-item">
            <i class="fas fa-check"></i>
            <span>Delete clergy records</span>
          </div>
          {% endif %}
          {% if user.can_manage_metadata() %}
          <div class="permission-item">
            <i class="fas fa-check"></i>
            <span>Manage metadata</span>
          </div>
          {% endif %}
          {% if user.can_manage_users() %}
          <div class="permission-item">
            <i class="fas fa-check"></i>
            <span>Manage users</span>
          </div>
          {% endif %}
          {% if user.can_comment() %}
          <div class="permission-item">
            <i class="fas fa-check"></i>
            <span>Add comments</span>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Password Change Section -->
  <div class="settings-section mb-4">
    <div class="settings-section-header">
      <i class="fas fa-lock"></i>
      <h4>Change Password</h4>
    </div>
    <div class="settings-content">
      <form id="change-password-form" method="post" action="/editor/settings/change-password" hx-post="/editor/settings/change-password" hx-target="#settings-messages" hx-swap="innerHTML">
        <div class="form-group">
          <label for="current_password">Current Password</label>
          <input type="password" id="current_password" name="current_password" required>
        </div>
        <div class="form-group">
          <label for="new_password">New Password</label>
          <input type="password" id="new_password" name="new_password" required>
          <div class="password-requirements">
            <small>Password must contain:</small>
            <ul>
              <li id="req-length">At least 8 characters</li>
              <li id="req-uppercase">One uppercase letter (A-Z)</li>
              <li id="req-lowercase">One lowercase letter (a-z)</li>
              <li id="req-number">One number (0-9)</li>
              <li id="req-special">One special character (!@#$%^&*(),.?":{}|<>)</li>
            </ul>
          </div>
        </div>
        <div class="form-group">
          <label for="confirm_password">Confirm New Password</label>
          <input type="password" id="confirm_password" name="confirm_password" required>
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-key"></i>
          Change Password
        </button>
      </form>
    </div>
  </div>

  <!-- User Management Section (only for users with manage_users permission) -->
  {% if user.can_manage_users() %}
  <div class="settings-section mb-4">
    <div class="settings-section-header">
      <i class="fas fa-users"></i>
      <h4>User Management</h4>
    </div>
    <div class="settings-content">
      <p>Add, edit, and manage user accounts with different permission levels.</p>
      <button class="btn btn-info" onclick="openUserManagementModal()">
        <i class="fas fa-users"></i>
        Manage Users
      </button>
    </div>
  </div>
  {% endif %}

  <!-- User Invite Section (only for Admins and Super Admins) -->
  {% if user.is_admin_or_super_admin() %}
  <div class="settings-section mb-4">
    <div class="settings-section-header">
      <i class="fas fa-user-plus"></i>
      <h4>Invite a New User</h4>
    </div>
    <div class="settings-content">
      <form id="invite-admin-form" method="post" action="/editor/settings/invite" hx-post="/editor/settings/invite" hx-target="#invite-link-section" hx-swap="innerHTML">
        <div class="form-group">
          <label for="role_id">Access Level</label>
          <select id="role_id" name="role_id" required>
            <option value="">Select access level...</option>
            {% for role in roles %}
            <option value="{{ role.id }}" data-description="{{ role.description }}">
              {{ role.name }}
            </option>
            {% endfor %}
          </select>
          <div class="role-description" id="role-description"></div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="expires_in_hours">
              Expires In (Hours)
              <span id="expires-icon" style="display: none;">
                <i class="fas fa-lock" title="Fixed for admin roles"></i>
              </span>
            </label>
            <input type="number" id="expires_in_hours" name="expires_in_hours" 
                   value="24" min="1" max="168" required>
            <div class="form-help" id="expires-help">1-168 hours (1 week max)</div>
          </div>
          <div class="form-group">
            <label for="max_uses">
              Maximum Uses
              <span id="uses-icon" style="display: none;">
                <i class="fas fa-lock" title="Fixed for admin roles"></i>
              </span>
            </label>
            <input type="number" id="max_uses" name="max_uses" 
                   value="1" min="1" max="100" required>
            <div class="form-help" id="uses-help">1-100 uses</div>
          </div>
        </div>
        
        <button type="submit" class="btn btn-success">
          <i class="fas fa-link"></i>
          Generate Invite Link
        </button>
      </form>
      
      <div id="invite-link-section" class="mt-3">
        {% if invite_link %}
          <div class="invite-link-success">
            <strong>Invite Link:</strong> 
            <a href="{{ invite_link }}" id="invite-link" title="{{ invite_link }}">
              <span id="invite-link-text">{{ invite_link }}</span>
            </a>
            <button class="btn btn-outline-secondary btn-sm" onclick="copyInviteLink()" type="button" id="copy-btn">
              <i class="fas fa-copy"></i> Copy
            </button>
            <span id="copy-feedback" class="copy-feedback">Copied!</span>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Messages Area -->
  <div id="settings-messages"></div>
</div>


<style>
  .settings-panel {
    padding: 1rem;
    color: rgba(255, 255, 255, 0.9);
  }

  .settings-section {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    overflow: hidden;
  }

  .settings-section-header {
    background: rgba(255, 255, 255, 0.1);
    padding: 0.75rem 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .settings-section-header i {
    font-size: 1.1em;
    color: rgba(255, 255, 255, 0.7);
  }

  .settings-section-header h4 {
    margin: 0;
    font-size: 1rem;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.9);
  }

  .settings-content {
    padding: 1rem;
  }

  .user-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .user-info-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .user-info-item label {
    font-size: 0.8em;
    color: rgba(255, 255, 255, 0.6);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .user-info-item span {
    font-size: 0.9em;
    color: rgba(255, 255, 255, 0.9);
  }

  .role-badge, .status-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75em;
    font-weight: 500;
  }

  .role-badge {
    background: rgba(59, 130, 246, 0.2);
    color: rgba(59, 130, 246, 1);
    border: 1px solid rgba(59, 130, 246, 0.3);
  }

  .status-badge.active {
    background: rgba(34, 197, 94, 0.2);
    color: rgba(34, 197, 94, 1);
    border: 1px solid rgba(34, 197, 94, 0.3);
  }

  .status-badge.inactive {
    background: rgba(239, 68, 68, 0.2);
    color: rgba(239, 68, 68, 1);
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  .permissions-section {
    margin-top: 1rem;
  }

  .permissions-section h5 {
    font-size: 0.9em;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 0.5rem;
    font-weight: 500;
  }

  .permissions-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .permission-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85em;
  }

  .permission-item i {
    color: rgba(34, 197, 94, 1);
    font-size: 0.8em;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-size: 0.85em;
    color: rgba(255, 255, 255, 0.8);
    font-weight: 500;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 0.5rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.9em;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: rgba(59, 130, 246, 0.5);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
  }

  .form-group input:disabled {
    background: rgba(255, 255, 255, 0.05);
    color: rgba(255, 255, 255, 0.5);
    cursor: not-allowed;
  }

  .password-requirements {
    margin-top: 0.5rem;
  }

  .password-requirements small {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.75em;
  }

  .password-requirements ul {
    margin: 0.25rem 0 0 0;
    padding-left: 1rem;
    list-style: none;
  }

  .password-requirements li {
    font-size: 0.75em;
    margin-bottom: 0.25rem;
    color: rgba(255, 255, 255, 0.6);
  }

  .password-requirements li:before {
    content: "• ";
    margin-right: 0.5rem;
  }

  .password-requirements li.text-success {
    color: rgba(34, 197, 94, 1);
  }

  .password-requirements li.text-success:before {
    content: "✓ ";
  }

  .password-requirements li.text-danger {
    color: rgba(239, 68, 68, 1);
  }

  .password-requirements li.text-danger:before {
    content: "✗ ";
  }

  .form-help {
    font-size: 0.75em;
    color: rgba(255, 255, 255, 0.6);
    margin-top: 0.25rem;
  }

  .role-description {
    font-size: 0.75em;
    color: rgba(255, 255, 255, 0.6);
    margin-top: 0.25rem;
    display: none;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  .btn-primary {
    background: rgba(59, 130, 246, 0.8);
    color: white;
  }

  .btn-primary:hover {
    background: rgba(59, 130, 246, 1);
  }

  .btn-info {
    background: rgba(6, 182, 212, 0.8);
    color: white;
  }

  .btn-info:hover {
    background: rgba(6, 182, 212, 1);
  }

  .btn-success {
    background: rgba(34, 197, 94, 0.8);
    color: white;
  }

  .btn-success:hover {
    background: rgba(34, 197, 94, 1);
  }

  .btn-outline-secondary {
    background: transparent;
    color: rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .btn-outline-secondary:hover {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
  }

  .invite-link-success {
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 4px;
    padding: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .invite-link-success strong {
    color: rgba(34, 197, 94, 1);
    font-size: 0.85em;
  }

  .invite-link-success a {
    color: rgba(59, 130, 246, 1);
    text-decoration: none;
    font-size: 0.8em;
    word-break: break-all;
  }

  .invite-link-success a:hover {
    text-decoration: underline;
  }

  .copy-feedback {
    color: rgba(34, 197, 94, 1);
    font-size: 0.8em;
    display: none;
  }

  #settings-messages {
    margin-top: 1rem;
  }

  .message-success {
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.3);
    color: rgba(34, 197, 94, 1);
    padding: 0.75rem;
    border-radius: 4px;
    font-size: 0.85em;
  }

  .message-error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: rgba(239, 68, 68, 1);
    padding: 0.75rem;
    border-radius: 4px;
    font-size: 0.85em;
  }


  /* Responsive adjustments */
  @media (max-width: 768px) {
    .user-info-grid {
      grid-template-columns: 1fr;
    }
    
    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // Password validation
  document.getElementById('new_password').addEventListener('input', function() {
    const password = this.value;
    const requirements = {
      length: password.length >= 8,
      uppercase: /[A-Z]/.test(password),
      lowercase: /[a-z]/.test(password),
      number: /\d/.test(password),
      special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
    };
    
    // Update requirement indicators
    document.getElementById('req-length').className = requirements.length ? 'text-success' : 'text-danger';
    document.getElementById('req-uppercase').className = requirements.uppercase ? 'text-success' : 'text-danger';
    document.getElementById('req-lowercase').className = requirements.lowercase ? 'text-success' : 'text-danger';
    document.getElementById('req-number').className = requirements.number ? 'text-success' : 'text-danger';
    document.getElementById('req-special').className = requirements.special ? 'text-success' : 'text-danger';
    
    // Check if passwords match
    const confirmPassword = document.getElementById('confirm_password').value;
    if (confirmPassword) {
      checkPasswordMatch();
    }
  });
  
  document.getElementById('confirm_password').addEventListener('input', checkPasswordMatch);
  
  function checkPasswordMatch() {
    const password = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const confirmField = document.getElementById('confirm_password');
    
    if (confirmPassword && password !== confirmPassword) {
      confirmField.setCustomValidity('Passwords do not match');
      confirmField.classList.add('is-invalid');
    } else {
      confirmField.setCustomValidity('');
      confirmField.classList.remove('is-invalid');
    }
  }
  
  // Copy invite link function
  function copyInviteLink() {
    const link = document.getElementById('invite-link').href;
    navigator.clipboard.writeText(link).then(function() {
      document.getElementById('copy-feedback').style.display = 'inline';
      setTimeout(function() {
        document.getElementById('copy-feedback').style.display = 'none';
      }, 1500);
    });
  }
  
  // Handle HTMX responses
  document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.xhr.status === 200) {
      try {
        const response = JSON.parse(evt.detail.xhr.responseText);
        if (response.success) {
          showMessage(response.message, 'success');
          
          // Handle invite link response
          if (response.invite_link) {
            const inviteSection = document.getElementById('invite-link-section');
            inviteSection.innerHTML = `
              <div class="invite-link-success">
                <strong>Invite Link:</strong> 
                <a href="${response.invite_link}" id="invite-link" title="${response.invite_link}">
                  <span id="invite-link-text">${response.invite_link}</span>
                </a>
                <button class="btn btn-outline-secondary btn-sm" onclick="copyInviteLink()" type="button" id="copy-btn">
                  <i class="fas fa-copy"></i> Copy
                </button>
                <span id="copy-feedback" class="copy-feedback">Copied!</span>
              </div>
            `;
          }
        } else {
          showMessage(response.message, 'error');
        }
      } catch (e) {
        // Not JSON response, ignore
      }
    }
  });
  
  // Show message function
  function showMessage(message, type) {
    const messagesDiv = document.getElementById('settings-messages');
    const messageClass = type === 'success' ? 'message-success' : 'message-error';
    messagesDiv.innerHTML = `<div class="${messageClass}">${message}</div>`;
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      messagesDiv.innerHTML = '';
    }, 5000);
  }
  
  // Role description display and field management
  document.getElementById('role_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const description = selectedOption.getAttribute('data-description');
    const descriptionDiv = document.getElementById('role-description');
    const roleName = selectedOption.textContent;
    
    // Update description
    if (description) {
      descriptionDiv.textContent = description;
      descriptionDiv.style.display = 'block';
    } else {
      descriptionDiv.style.display = 'none';
    }
    
    // Handle field restrictions for admin roles
    const expiresField = document.getElementById('expires_in_hours');
    const maxUsesField = document.getElementById('max_uses');
    const expiresHelp = document.getElementById('expires-help');
    const usesHelp = document.getElementById('uses-help');
    const expiresIcon = document.getElementById('expires-icon');
    const usesIcon = document.getElementById('uses-icon');
    
    if (roleName === 'Super Admin' || roleName === 'Admin') {
      // Disable fields for admin roles
      expiresField.disabled = true;
      maxUsesField.disabled = true;
      expiresField.value = '24'; // Fixed 24 hours for admin roles
      maxUsesField.value = '1';  // Fixed 1 use for admin roles
      
      // Update help text
      expiresHelp.textContent = 'Fixed at 24 hours for admin roles';
      usesHelp.textContent = 'Fixed at 1 use for admin roles';
      
      // Show lock icons
      expiresIcon.style.display = 'inline';
      usesIcon.style.display = 'inline';
      
    } else {
      // Enable fields for regular roles
      expiresField.disabled = false;
      maxUsesField.disabled = false;
      
      // Restore help text
      expiresHelp.textContent = '1-168 hours (1 week max)';
      usesHelp.textContent = '1-100 uses';
      
      // Hide lock icons
      expiresIcon.style.display = 'none';
      usesIcon.style.display = 'none';
    }
  });
  
  
  // Initialize field states on page load
  document.addEventListener('DOMContentLoaded', function() {
    const roleSelect = document.getElementById('role_id');
    if (roleSelect && roleSelect.value) {
      // Trigger change event to set initial state
      roleSelect.dispatchEvent(new Event('change'));
    }
  });
</script>
