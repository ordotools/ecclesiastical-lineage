{% extends "base.html" %}

{% block title %}Lineage Visualization - Ecclesiastical Lineage{% endblock %}

{% block full_content %}
<script>
  document.documentElement.style.setProperty('--lineage-green', '#27ae60');
  document.documentElement.style.setProperty('--lineage-black', '#000000');
</script>
<div class="full-viewport-container">
    <!-- Floating Menu Button (Mobile Only) -->
    <button id="mobile-menu-btn" class="d-block d-md-none floating-menu-btn" aria-label="Open menu" style="position:fixed;bottom:20px;left:20px;z-index:1100;display:none;">
      <svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true" focusable="false">
        <rect x="6" y="10" width="20" height="2.5" rx="1.2" fill="#2c3e50"/>
        <rect x="6" y="15" width="20" height="2.5" rx="1.2" fill="#2c3e50"/>
        <rect x="6" y="20" width="20" height="2.5" rx="1.2" fill="#2c3e50"/>
      </svg>
    </button>

    <!-- Modal Overlay for Mobile Menu -->
    <div id="mobile-menu-modal" class="mobile-menu-modal" style="display:none;">
      <div class="mobile-menu-modal-content">
        <button id="close-mobile-menu" class="close-mobile-menu" aria-label="Close menu">&times;</button>
        <div class="mobile-menu-legend-controls">
          <!-- Legend -->
          <div class="legend-visualization-mobile">
            <h6 class="fw-bold mb-2 text-dark">Lineage Types</h6>
            <div class="d-flex align-items-center mb-2">
                <div style="width: 20px; height: 2px; background: var(--lineage-black); margin-right: 8px;"></div>
                <small class="text-dark">Ordination</small>
            </div>
            <div class="d-flex align-items-center mb-2">
                <div style="width: 20px; height: 2px; background: var(--lineage-green); margin-right: 8px;"></div>
                <small class="text-dark">Consecration</small>
            </div>
            <div class="d-flex align-items-center mb-2">
                <div style="width: 20px; height: 2px; background: var(--lineage-green); border-top: 2px dotted var(--lineage-green); margin-right: 8px;"></div>
                <small class="text-dark">Co-consecration</small>
            </div>
          </div>
          <!-- Controls -->
          <div class="visualization-controls-mobile mt-3">
            <button id="reset-zoom-mobile" class="btn btn-sm btn-outline-secondary mb-2 w-100">
                <i class="fas fa-search-plus me-1"></i>Reset Zoom
            </button>
            <button id="center-graph-mobile" class="btn btn-sm btn-outline-secondary w-100">
                <i class="fas fa-crosshairs me-1"></i>Center Graph
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Legend -->
    <div class="legend-visualization">
        <h6 class="fw-bold mb-2 text-dark">Lineage Types</h6>
        <div class="d-flex align-items-center mb-2">
            <div style="width: 20px; height: 2px; background: var(--lineage-black); margin-right: 8px;"></div>
            <small class="text-dark">Ordination</small>
        </div>
        <div class="d-flex align-items-center mb-2">
            <div style="width: 20px; height: 2px; background: var(--lineage-green); margin-right: 8px;"></div>
            <small class="text-dark">Consecration</small>
        </div>
        <div class="d-flex align-items-center mb-2">
            <div style="width: 20px; height: 2px; background: var(--lineage-green); border-top: 2px dotted var(--lineage-green); margin-right: 8px;"></div>
            <small class="text-dark">Co-consecration</small>
        </div>
    </div>

    <!-- Controls -->
    <div class="visualization-controls">
        <button id="reset-zoom" class="btn btn-sm btn-outline-secondary mb-2 w-100">
            <i class="fas fa-search-plus me-1"></i>Reset Zoom
        </button>
        <button id="center-graph" class="btn btn-sm btn-outline-secondary w-100">
            <i class="fas fa-crosshairs me-1"></i>Center Graph
        </button>
    </div>

    <!-- Admin Navigation Button -->
    {% if session.user_id %}
    <div class="admin-nav-container">
        <a href="{{ url_for('auth.dashboard') }}" class="btn admin-nav-btn">
            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
        </a>
    </div>
    {% endif %}

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="position-fixed" style="top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1200;">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading lineage visualization...</p>
        </div>
    </div>

    <!-- Graph Container -->
    <div id="graph-container" class="graph-container-full"></div>
    
    <!-- Error Message Display -->
    {% if error_message %}
    <div class="alert alert-warning alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 1200;" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ error_message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/visualizer.css') }}">
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/d3.v7.min.js') }}"></script>
<script>
window.linksData = {{ links | safe }};
window.nodesData = {{ nodes | safe }};
</script>
<script src="{{ url_for('static', filename='js/lineageVisualization.js') }}"></script>
{% endblock %} 