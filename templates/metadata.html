{% extends "base.html" %}

{% block title %}Metadata - Ecclesiastical Lineage{% endblock %}

{% block full_content %}
    <div class="container mt-4">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2 mb-0">Metadata Management</h1>
        </div>

        <div class="row">
            <!-- Ranks Section -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h3 class="h5 mb-0">
                            <i class="fas fa-star me-2"></i>Clergy Ranks
                        </h3>
                    </div>
                    <div class="card-body">
                        <!-- <p class="text-muted mb-3">Common ranks used in ecclesiastical records</p> -->
                        
                        <div class="mb-4">
                            <h6 class="mb-3">Add New Rank</h6>
                            <div class="row g-2 align-items-center">
                                <div class="col-auto">
                                    <div class="d-flex align-items-center h-100">
                                        <span class="color-dot me-2" id="new-rank-color-display" style="background-color: #000000; width: 24px; height: 24px; border-radius: 50%; display: inline-block; border: 2px solid #ccc; cursor: pointer;" onclick="document.getElementById('new-rank-color').click()" title="Click to change color"></span>
                                        <input type="color" id="new-rank-color" value="#000000" style="position: absolute; opacity: 0; pointer-events: none;" onchange="updateColorDisplay('new-rank-color-display', this.value)">
                                    </div>
                                </div>
                                <div class="col">
                                    <input type="text" class="form-control" id="new-rank" placeholder="e.g., Bishop, Priest, Deacon">
                                </div>
                                <div class="col">
                                    <input type="text" class="form-control" id="new-rank-description" placeholder="Description (optional)">
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-primary" type="button" onclick="addRank()" title="Add new rank">
                                        <i class="fas fa-plus me-1"></i>Add Rank
                                    </button>
                                </div>
                            </div>
                            <div class="form-text mt-2">Click the color dot to change the rank's color. Press Enter in any field to add the rank.</div>
                        </div>

                        <div class="rank-list">
                            <h6 class="mb-2">Current Ranks ({{ ranks|length }})</h6>
                            {% if ranks %}
                                <div class="list-group list-group-flush" id="ranks-list">
                                    {% for rank in ranks %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center py-2" data-rank-id="{{ rank.id }}">
                                        <div class="d-flex align-items-center">
                                            <span class="color-dot me-2" style="background-color: {{ rank.color or '#000000' }}; width: 18px; height: 18px; border-radius: 50%; display: inline-block; border: 1px solid #ccc;" title="Color: {{ rank.color or '#000000' }}"></span>
                                            <span class="rank-badge" style="background-color: {{ rank.color or '#000000' }}; color: {{ 'white' if getContrastColor(rank.color or '#000000') == 'white' else 'black' }}; padding: 0.25em 0.5em; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; {{ getBorderStyle(rank.color or '#000000') }}">{{ rank.name }}</span>
                                            {% if rank.description %}
                                                <small class="text-muted d-block ms-2">{{ rank.description }}</small>
                                            {% endif %}
                                        </div>
                                        <div class="d-flex align-items-center">
                                            {% if rank.name in clergy_ranks %}
                                                <small class="text-muted me-2">Used in records</small>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editRank({{ rank.id }}, '{{ rank.name }}', '{{ rank.description or '' }}', '{{ rank.color or '#000000' }}')" title="Edit rank">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRank({{ rank.id }}, '{{ rank.name }}')" 
                                                    {% if rank.name in clergy_ranks %}disabled title="Cannot delete - used in clergy records"{% endif %}>
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">No ranks defined yet. Add your first rank above.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Organizations Section -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h3 class="h5 mb-0">
                            <i class="fas fa-church me-2"></i>Organizations
                        </h3>
                    </div>
                    <div class="card-body">
                        <!-- <p class="text-muted mb-3">Religious organizations and denominations</p> -->
                        
                        <div class="mb-4">
                            <h6 class="mb-3">Add New Organization</h6>
                            <div class="row g-2 mb-2 align-items-center">
                                <div class="col-auto">
                                    <div class="d-flex align-items-center h-100">
                                        <span class="color-dot me-2" id="new-organization-color-display" style="background-color: #27ae60; width: 24px; height: 24px; border-radius: 50%; display: inline-block; border: 2px solid #ccc; cursor: pointer;" onclick="document.getElementById('new-organization-color').click()" title="Click to change color"></span>
                                        <input type="color" id="new-organization-color" value="#27ae60" style="position: absolute; opacity: 0; pointer-events: none;" onchange="updateColorDisplay('new-organization-color-display', this.value)">
                                    </div>
                                </div>
                                <div class="col">
                                    <input type="text" class="form-control" id="new-organization" placeholder="Organization name">
                                </div>
                                <div class="col">
                                    <input type="text" class="form-control" id="new-organization-abbreviation" placeholder="Abbreviation (optional)">
                                </div>
                            </div>
                            <div class="row g-2 align-items-center">
                                <div class="col">
                                    <input type="text" class="form-control" id="new-organization-description" placeholder="Description (optional)">
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-primary" type="button" onclick="addOrganization()" title="Add new organization">
                                        <i class="fas fa-plus me-1"></i>Add Organization
                                    </button>
                                </div>
                            </div>
                            <div class="form-text mt-2">Click the color dot to change the organization's color. Press Enter in any field to add the organization.</div>
                        </div>

                        <div class="organization-list">
                            <h6 class="mb-2">Current Organizations ({{ organizations|length }})</h6>
                            {% if organizations %}
                                <div class="list-group list-group-flush" id="organizations-list">
                                    {% for organization in organizations %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center py-2" data-org-id="{{ organization.id }}">
                                        <div class="d-flex align-items-center">
                                            <span class="color-dot me-2" style="background-color: {{ organization.color or '#27ae60' }}; width: 18px; height: 18px; border-radius: 50%; display: inline-block; border: 1px solid #ccc;" title="Color: {{ organization.color or '#27ae60' }}"></span>
                                            <span class="organization-badge" style="background-color: {{ organization.color or '#27ae60' }}; color: {{ 'white' if getContrastColor(organization.color or '#27ae60') == 'white' else 'black' }}; padding: 0.25em 0.5em; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; {{ getBorderStyle(organization.color or '#27ae60') }}">{{ organization.name }}</span>
                                            {% if organization.abbreviation %}
                                                <span class="organization-abbreviation-badge" style="background-color: {{ organization.color or '#27ae60' }}; color: {{ 'white' if getContrastColor(organization.color or '#27ae60') == 'white' else 'black' }}; padding: 0.25em 0.5em; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; margin-left: 0.5rem; {{ getBorderStyle(organization.color or '#27ae60') }}">{{ organization.abbreviation }}</span>
                                            {% endif %}
                                            {% if organization.description %}
                                                <small class="text-muted d-block ms-2">{{ organization.description }}</small>
                                            {% endif %}
                                        </div>
                                        <div class="d-flex align-items-center">
                                            {% if organization.name in clergy_organizations %}
                                                <small class="text-muted me-2">Used in records</small>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editOrganization({{ organization.id }}, '{{ organization.name }}', '{{ organization.abbreviation or '' }}', '{{ organization.description or '' }}', '{{ organization.color or '#27ae60' }}')" title="Edit organization">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteOrganization({{ organization.id }}, '{{ organization.name }}')"
                                                    {% if organization.name in clergy_organizations %}disabled title="Cannot delete - used in clergy records"{% endif %}>
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">No organizations defined yet. Add your first organization above.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Metadata Sections -->
        <div class="row">
            <!-- Date Formats Section -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="h5 mb-0">
                            <i class="fas fa-calendar me-2"></i>Date Formats
                        </h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Configure date formats used in the system</p>
                        
                        <!-- Birth Date Format -->
                        <div class="mb-4 date-format-section">
                            <h6 class="mb-3">Birth Date Format</h6>
                            <div class="row g-2 align-items-center">
                                <div class="col">
                                    <select class="form-select date-format-select" id="birth-date-format" onchange="updateDateFormatPreview('birth')">
                                        <option value="YYYY-MM-DD" selected>YYYY-MM-DD (ISO Standard)</option>
                                        <option value="MM/DD/YYYY">MM/DD/YYYY (US Format)</option>
                                        <option value="DD/MM/YYYY">DD/MM/YYYY (European Format)</option>
                                        <option value="MM-DD-YYYY">MM-DD-YYYY (US with dashes)</option>
                                        <option value="DD-MM-YYYY">DD-MM-YYYY (European with dashes)</option>
                                        <option value="custom">Custom Format</option>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-outline-primary date-format-save-btn" type="button" onclick="saveDateFormat('birth')" title="Save birth date format">
                                        <i class="fas fa-save me-1"></i>Save
                                    </button>
                                </div>
                            </div>
                            <div class="mt-2 date-format-preview">
                                <small class="text-muted">Preview: <span id="birth-date-preview" class="fw-bold">2024-01-15</span></small>
                            </div>
                            <div class="mt-2" id="birth-custom-format" style="display: none;">
                                <input type="text" class="form-control form-control-sm custom-format-input" id="birth-custom-format-input" 
                                       placeholder="e.g., YYYY-MM-DD" value="YYYY-MM-DD" 
                                       onchange="updateCustomDateFormatPreview('birth')">
                                <small class="text-muted">Use YYYY for year, MM for month, DD for day</small>
                            </div>
                        </div>

                        <!-- Ordination Date Format -->
                        <div class="mb-4 date-format-section">
                            <h6 class="mb-3">Ordination Date Format</h6>
                            <div class="row g-2 align-items-center">
                                <div class="col">
                                    <select class="form-select date-format-select" id="ordination-date-format" onchange="updateDateFormatPreview('ordination')">
                                        <option value="YYYY-MM-DD" selected>YYYY-MM-DD (ISO Standard)</option>
                                        <option value="MM/DD/YYYY">MM/DD/YYYY (US Format)</option>
                                        <option value="DD/MM/YYYY">DD/MM/YYYY (European Format)</option>
                                        <option value="MM-DD-YYYY">MM-DD-YYYY (US with dashes)</option>
                                        <option value="DD-MM-YYYY">DD-MM-YYYY (European with dashes)</option>
                                        <option value="custom">Custom Format</option>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-outline-primary date-format-save-btn" type="button" onclick="saveDateFormat('ordination')" title="Save ordination date format">
                                        <i class="fas fa-save me-1"></i>Save
                                    </button>
                                </div>
                            </div>
                            <div class="mt-2 date-format-preview">
                                <small class="text-muted">Preview: <span id="ordination-date-preview" class="fw-bold">2024-01-15</span></small>
                            </div>
                            <div class="mt-2" id="ordination-custom-format" style="display: none;">
                                <input type="text" class="form-control form-control-sm custom-format-input" id="ordination-custom-format-input" 
                                       placeholder="e.g., YYYY-MM-DD" value="YYYY-MM-DD" 
                                       onchange="updateCustomDateFormatPreview('ordination')">
                                <small class="text-muted">Use YYYY for year, MM for month, DD for day</small>
                            </div>
                        </div>

                        <!-- Consecration Date Format -->
                        <div class="mb-4 date-format-section">
                            <h6 class="mb-3">Consecration Date Format</h6>
                            <div class="row g-2 align-items-center">
                                <div class="col">
                                    <select class="form-select date-format-select" id="consecration-date-format" onchange="updateDateFormatPreview('consecration')">
                                        <option value="YYYY-MM-DD" selected>YYYY-MM-DD (ISO Standard)</option>
                                        <option value="MM/DD/YYYY">MM/DD/YYYY (US Format)</option>
                                        <option value="DD/MM/YYYY">DD/MM/YYYY (European Format)</option>
                                        <option value="MM-DD-YYYY">MM-DD-YYYY (US with dashes)</option>
                                        <option value="DD-MM-YYYY">DD-MM-YYYY (European with dashes)</option>
                                        <option value="custom">Custom Format</option>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-outline-primary date-format-save-btn" type="button" onclick="saveDateFormat('consecration')" title="Save consecration date format">
                                        <i class="fas fa-save me-1"></i>Save
                                    </button>
                                </div>
                            </div>
                            <div class="mt-2 date-format-preview">
                                <small class="text-muted">Preview: <span id="consecration-date-preview" class="fw-bold">2024-01-15</span></small>
                            </div>
                            <div class="mt-2" id="consecration-custom-format" style="display: none;">
                                <input type="text" class="form-control form-control-sm custom-format-input" id="consecration-custom-format-input" 
                                       placeholder="e.g., YYYY-MM-DD" value="YYYY-MM-DD" 
                                       onchange="updateCustomDateFormatPreview('consecration')">
                                <small class="text-muted">Use YYYY for year, MM for month, DD for day</small>
                            </div>
                        </div>

                        <!-- Global Actions -->
                        <div class="border-top pt-3 date-format-actions">
                            <div class="row g-2">
                                <div class="col">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="resetAllDateFormats()" title="Reset all formats to default">
                                        <i class="fas fa-undo me-1"></i>Reset to Default
                                    </button>
                                </div>
                                <div class="col">
                                    <button class="btn btn-outline-info btn-sm" type="button" onclick="showDateFormatHelp()" title="Show date format help">
                                        <i class="fas fa-question-circle me-1"></i>Format Help
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Info Section -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="h5 mb-0">
                            <i class="fas fa-info-circle me-2"></i>System Information
                        </h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Current system statistics</p>
                        <div class="list-group list-group-flush">
                            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                                <span>Total Clergy Records</span>
                                <span class="badge bg-primary">{{ clergy_ranks|length + clergy_organizations|length }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                                <span>Defined Ranks</span>
                                <span class="badge bg-secondary">{{ ranks|length }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                                <span>Defined Organizations</span>
                                <span class="badge bg-info">{{ organizations|length }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Rank Modal -->
    <div class="modal fade" id="editRankModal" tabindex="-1" aria-labelledby="editRankModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editRankModalLabel">Edit Rank</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editRankForm">
                        <input type="hidden" id="edit-rank-id">
                        <div class="mb-3">
                            <label for="edit-rank-name" class="form-label">Rank Name</label>
                            <input type="text" class="form-control" id="edit-rank-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-rank-description" class="form-label">Description</label>
                            <input type="text" class="form-control" id="edit-rank-description" placeholder="Description (optional)">
                        </div>
                        <div class="mb-3">
                            <label for="edit-rank-color" class="form-label">Color</label>
                            <div class="d-flex align-items-center" style="position: relative;">
                                <span class="color-dot" id="edit-rank-color-display" style="background-color: #000000; width: 24px; height: 24px; border-radius: 50%; display: inline-block; border: 2px solid #ccc; cursor: pointer; margin-right: 12px;" onclick="document.getElementById('edit-rank-color').click()" title="Click to change color"></span>
                                <input type="color" id="edit-rank-color" value="#000000" style="position: absolute; top: 100%; left: 0; opacity: 0; pointer-events: none;" onchange="updateColorDisplay('edit-rank-color-display', this.value)">
                                <small class="text-muted">Click the dot to change color</small>
                            </div>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Press Enter to save, Escape to cancel
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveRankEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Organization Modal -->
    <div class="modal fade" id="editOrganizationModal" tabindex="-1" aria-labelledby="editOrganizationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editOrganizationModalLabel">Edit Organization</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editOrganizationForm">
                        <input type="hidden" id="edit-organization-id">
                        <div class="mb-3">
                            <label for="edit-organization-name" class="form-label">Organization Name</label>
                            <input type="text" class="form-control" id="edit-organization-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-organization-abbreviation" class="form-label">Abbreviation</label>
                            <input type="text" class="form-control" id="edit-organization-abbreviation" placeholder="Abbreviation (optional)">
                        </div>
                        <div class="mb-3">
                            <label for="edit-organization-description" class="form-label">Description</label>
                            <input type="text" class="form-control" id="edit-organization-description" placeholder="Description (optional)">
                        </div>
                        <div class="mb-3">
                            <label for="edit-organization-color" class="form-label">Color</label>
                            <div class="d-flex align-items-center" style="position: relative;">
                                <span class="color-dot" id="edit-organization-color-display" style="background-color: #27ae60; width: 24px; height: 24px; border-radius: 50%; display: inline-block; border: 2px solid #ccc; cursor: pointer; margin-right: 12px;" onclick="document.getElementById('edit-organization-color').click()" title="Click to change color"></span>
                                <input type="color" id="edit-organization-color" value="#27ae60" style="position: absolute; top: 100%; left: 0; opacity: 0; pointer-events: none;" onchange="updateColorDisplay('edit-organization-color-display', this.value)">
                                <small class="text-muted">Click the dot to change color</small>
                            </div>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Press Enter to save, Escape to cancel
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveOrganizationEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
// Color contrast utility function
function getContrastColor(hexColor) {
    // Convert hex to RGB
    const hex = hexColor.replace('#', '');
    const r = parseInt(hex.substr(0, 2), 16);
    const g = parseInt(hex.substr(2, 2), 16);
    const b = parseInt(hex.substr(4, 2), 16);
    
    // Calculate relative luminance (WCAG 2.1 formula)
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    
    // Return white for dark backgrounds, black for light backgrounds
    return luminance > 0.5 ? 'black' : 'white';
}

// Function to update color display and preview contrast
function updateColorDisplay(displayId, color) {
    const displayElement = document.getElementById(displayId);
    displayElement.style.backgroundColor = color;
    
    // If this is an edit modal, update the preview
    if (displayId.includes('edit-rank-color-display')) {
        const previewElement = document.getElementById('edit-rank-preview');
        if (previewElement) {
            previewElement.style.backgroundColor = color;
            previewElement.style.color = getContrastColor(color);
        }
    } else if (displayId.includes('edit-organization-color-display')) {
        const previewElement = document.getElementById('edit-organization-preview');
        if (previewElement) {
            previewElement.style.backgroundColor = color;
            previewElement.style.color = getContrastColor(color);
        }
    }
}

function showMessage(message, type = 'success') {
    // Create notification element using the existing glass-morphism system
    const notificationDiv = document.createElement('div');
    notificationDiv.className = `notification notification-${type === 'error' ? 'danger' : type}`;
    notificationDiv.innerHTML = `
        <div class="notification-content">
            <span class="notification-message">${message}</span>
            <button type="button" class="notification-close" onclick="dismissNotification(this)">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    // Find or create notification container
    let container = document.getElementById('notification-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notification-container';
        container.className = 'notification-container';
        document.body.appendChild(container);
    }
    
    // Add notification to container
    container.appendChild(notificationDiv);
    
    // Trigger show animation
    setTimeout(() => {
        notificationDiv.classList.add('show');
    }, 10);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notificationDiv.parentNode) {
            notificationDiv.classList.add('hide');
            setTimeout(() => {
                if (notificationDiv.parentNode) {
                    notificationDiv.remove();
                }
            }, 300);
        }
    }, 5000);
}

// Add the dismissNotification function if it doesn't exist
function dismissNotification(closeButton) {
    const notification = closeButton.closest('.notification');
    if (notification) {
        notification.classList.add('hide');
        setTimeout(function() {
            notification.remove();
        }, 300);
    }
}

function addRank() {
    const nameInput = document.getElementById('new-rank');
    const descInput = document.getElementById('new-rank-description');
    const colorInput = document.getElementById('new-rank-color');
    const rankName = nameInput.value.trim();
    const description = descInput.value.trim();
    const color = colorInput.value.trim() || '#000000';
    
    if (!rankName) {
        showMessage('Please enter a rank name.', 'error');
        return;
    }
    
    fetch('/metadata/rank/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: rankName,
            description: description,
            color: color
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            nameInput.value = '';
            descInput.value = '';
            // Reload the page to show the new rank
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Error adding rank. Please try again.', 'error');
        console.error('Error:', error);
    });
}

function deleteRank(rankId, rankName) {
    if (!confirm(`Are you sure you want to delete the rank "${rankName}"?`)) {
        return;
    }
    
    fetch(`/metadata/rank/${rankId}/delete`, {
        method: 'DELETE',
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            // Remove the rank from the DOM
            const rankElement = document.querySelector(`[data-rank-id="${rankId}"]`);
            if (rankElement) {
                rankElement.remove();
            }
            // Update the count
            const countElement = document.querySelector('.rank-list h6');
            const currentCount = parseInt(countElement.textContent.match(/\((\d+)\)/)[1]);
            countElement.textContent = `Current Ranks (${currentCount - 1})`;
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Error deleting rank. Please try again.', 'error');
        console.error('Error:', error);
    });
}

function addOrganization() {
    const nameInput = document.getElementById('new-organization');
    const abbrInput = document.getElementById('new-organization-abbreviation');
    const descInput = document.getElementById('new-organization-description');
    const colorInput = document.getElementById('new-organization-color');
    const orgName = nameInput.value.trim();
    const abbreviation = abbrInput.value.trim();
    const description = descInput.value.trim();
    const color = colorInput.value.trim() || '#27ae60';
    
    if (!orgName) {
        showMessage('Please enter an organization name.', 'error');
        return;
    }
    
    fetch('/metadata/organization/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: orgName,
            abbreviation: abbreviation,
            description: description,
            color: color
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            nameInput.value = '';
            abbrInput.value = '';
            descInput.value = '';
            // Reload the page to show the new organization
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Error adding organization. Please try again.', 'error');
        console.error('Error:', error);
    });
}

function deleteOrganization(orgId, orgName) {
    if (!confirm(`Are you sure you want to delete the organization "${orgName}"?`)) {
        return;
    }
    
    fetch(`/metadata/organization/${orgId}/delete`, {
        method: 'DELETE',
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            // Remove the organization from the DOM
            const orgElement = document.querySelector(`[data-org-id="${orgId}"]`);
            if (orgElement) {
                orgElement.remove();
            }
            // Update the count
            const countElement = document.querySelector('.organization-list h6');
            const currentCount = parseInt(countElement.textContent.match(/\((\d+)\)/)[1]);
            countElement.textContent = `Current Organizations (${currentCount - 1})`;
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Error deleting organization. Please try again.', 'error');
        console.error('Error:', error);
    });
}

// Handle logout redirect
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.xhr.status === 200) {
        const response = evt.detail.xhr.responseText;
        if (response.includes('logout')) {
            const redirectDiv = evt.detail.target.querySelector('#redirect');
            if (redirectDiv) {
                const url = redirectDiv.getAttribute('data-url');
                setTimeout(function() {
                    window.location.href = url;
                }, 1000);
            }
        }
    }
});

// Add enter key support for forms
document.getElementById('new-rank').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        addRank();
    }
});

document.getElementById('new-organization').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        addOrganization();
    }
});

document.getElementById('new-organization-abbreviation').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        addOrganization();
    }
});

// Edit functions
function editRank(rankId, rankName, rankDescription, rankColor) {
    document.getElementById('edit-rank-id').value = rankId;
    document.getElementById('edit-rank-name').value = rankName;
    document.getElementById('edit-rank-description').value = rankDescription;
    document.getElementById('edit-rank-color').value = rankColor || '#000000';
    document.getElementById('edit-rank-color-display').style.backgroundColor = rankColor || '#000000';
    
    const modal = new bootstrap.Modal(document.getElementById('editRankModal'));
    modal.show();
}

function saveRankEdit() {
    const rankId = document.getElementById('edit-rank-id').value;
    const rankName = document.getElementById('edit-rank-name').value.trim();
    const rankDescription = document.getElementById('edit-rank-description').value.trim();
    const rankColor = document.getElementById('edit-rank-color').value.trim() || '#000000';
    
    if (!rankName) {
        showMessage('Please enter a rank name.', 'error');
        return;
    }
    
    fetch(`/metadata/rank/${rankId}/edit`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: rankName,
            description: rankDescription,
            color: rankColor
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editRankModal'));
            modal.hide();
            // Reload the page to show updated data
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Error updating rank. Please try again.', 'error');
        console.error('Error:', error);
    });
}

function editOrganization(orgId, orgName, orgAbbreviation, orgDescription, orgColor) {
    document.getElementById('edit-organization-id').value = orgId;
    document.getElementById('edit-organization-name').value = orgName;
    document.getElementById('edit-organization-abbreviation').value = orgAbbreviation;
    document.getElementById('edit-organization-description').value = orgDescription;
    document.getElementById('edit-organization-color').value = orgColor || '#27ae60';
    document.getElementById('edit-organization-color-display').style.backgroundColor = orgColor || '#27ae60';
    
    const modal = new bootstrap.Modal(document.getElementById('editOrganizationModal'));
    modal.show();
}

function saveOrganizationEdit() {
    const orgId = document.getElementById('edit-organization-id').value;
    const orgName = document.getElementById('edit-organization-name').value.trim();
    const orgAbbreviation = document.getElementById('edit-organization-abbreviation').value.trim();
    const orgDescription = document.getElementById('edit-organization-description').value.trim();
    const orgColor = document.getElementById('edit-organization-color').value.trim() || '#27ae60';
    
    if (!orgName) {
        showMessage('Please enter an organization name.', 'error');
        return;
    }
    
    fetch(`/metadata/organization/${orgId}/edit`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: orgName,
            abbreviation: orgAbbreviation,
            description: orgDescription,
            color: orgColor
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editOrganizationModal'));
            modal.hide();
            // Reload the page to show updated data
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Error updating organization. Please try again.', 'error');
        console.error('Error:', error);
    });
}

// Add keyboard event handlers for modals
document.addEventListener('DOMContentLoaded', function() {
    // Rank edit modal keyboard handlers
    const editRankModal = document.getElementById('editRankModal');
    if (editRankModal) {
        editRankModal.addEventListener('shown.bs.modal', function() {
            document.getElementById('edit-rank-name').focus();
        });
        
        // Enter key to save
        document.getElementById('edit-rank-name').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveRankEdit();
            }
        });
        
        document.getElementById('edit-rank-description').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveRankEdit();
            }
        });
        
        // Escape key to cancel
        editRankModal.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = bootstrap.Modal.getInstance(editRankModal);
                modal.hide();
            }
        });
    }
    
    // Organization edit modal keyboard handlers
    const editOrganizationModal = document.getElementById('editOrganizationModal');
    if (editOrganizationModal) {
        editOrganizationModal.addEventListener('shown.bs.modal', function() {
            document.getElementById('edit-organization-name').focus();
        });
        
        // Enter key to save
        document.getElementById('edit-organization-name').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveOrganizationEdit();
            }
        });
        
        document.getElementById('edit-organization-abbreviation').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveOrganizationEdit();
            }
        });
        
        document.getElementById('edit-organization-description').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveOrganizationEdit();
            }
        });
        
        // Escape key to cancel
        editOrganizationModal.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = bootstrap.Modal.getInstance(editOrganizationModal);
                modal.hide();
            }
        });
    }
    
    // Initialize date format settings
    initializeDateFormatSettings();
});

// Date Format Functions
function initializeDateFormatSettings() {
    // Load saved date formats from localStorage
    const sections = ['birth', 'ordination', 'consecration'];
    
    sections.forEach(section => {
        const savedFormat = localStorage.getItem(`${section}_dateFormat`);
        if (savedFormat) {
            const formatSelect = document.getElementById(`${section}-date-format`);
            const customInput = document.getElementById(`${section}-custom-format-input`);
            
            // Check if it's a predefined format
            const predefinedFormats = ['YYYY-MM-DD', 'MM/DD/YYYY', 'DD/MM/YYYY', 'MM-DD-YYYY', 'DD-MM-YYYY'];
            if (predefinedFormats.includes(savedFormat)) {
                formatSelect.value = savedFormat;
            } else {
                formatSelect.value = 'custom';
                customInput.value = savedFormat;
                customInput.style.display = 'block';
            }
        }
        updateDateFormatPreview(section);
    });
}

function updateDateFormatPreview(section) {
    const formatSelect = document.getElementById(`${section}-date-format`);
    const customInput = document.getElementById(`${section}-custom-format-input`);
    const customFormatDiv = document.getElementById(`${section}-custom-format`);
    const previewSpan = document.getElementById(`${section}-date-preview`);
    
    if (formatSelect.value === 'custom') {
        customFormatDiv.style.display = 'block';
        previewSpan.textContent = customInput.value || 'YYYY-MM-DD';
    } else {
        customFormatDiv.style.display = 'none';
        previewSpan.textContent = formatSelect.value;
    }
}

function updateCustomDateFormatPreview(section) {
    const customInput = document.getElementById(`${section}-custom-format-input`);
    const previewSpan = document.getElementById(`${section}-date-preview`);
    previewSpan.textContent = customInput.value || 'YYYY-MM-DD';
}

function saveDateFormat(section) {
    const formatSelect = document.getElementById(`${section}-date-format`);
    const customInput = document.getElementById(`${section}-custom-format-input`);
    let format = formatSelect.value;
    
    if (format === 'custom') {
        format = customInput.value.trim();
        if (!format) {
            showMessage('Custom format cannot be empty.', 'error');
            return;
        }
        // Basic validation for custom format
        if (!format.includes('YYYY') || !format.includes('MM') || !format.includes('DD')) {
            showMessage('Custom format must include YYYY, MM, and DD placeholders.', 'error');
            return;
        }
    }
    
    localStorage.setItem(`${section}_dateFormat`, format);
    showMessage(`${section.charAt(0).toUpperCase() + section.slice(1)} date format saved successfully.`, 'success');
}

function resetAllDateFormats() {
    if (!confirm('Are you sure you want to reset all date formats to default?')) {
        return;
    }
    
    // Clear localStorage
    localStorage.removeItem('birth_dateFormat');
    localStorage.removeItem('ordination_dateFormat');
    localStorage.removeItem('consecration_dateFormat');
    
    // Reset form elements
    const sections = ['birth', 'ordination', 'consecration'];
    sections.forEach(section => {
        const formatSelect = document.getElementById(`${section}-date-format`);
        const customInput = document.getElementById(`${section}-custom-format-input`);
        const customFormatDiv = document.getElementById(`${section}-custom-format`);
        
        formatSelect.value = 'YYYY-MM-DD';
        customInput.value = 'YYYY-MM-DD';
        customFormatDiv.style.display = 'none';
        updateDateFormatPreview(section);
    });
    
    showMessage('All date formats have been reset to default (YYYY-MM-DD).', 'info');
}

function showDateFormatHelp() {
    const helpText = `
        <strong>Date Format Options:</strong><br>
        • <strong>YYYY-MM-DD</strong>: ISO 8601 standard (recommended)<br>
        • <strong>MM/DD/YYYY</strong>: US format (month/day/year)<br>
        • <strong>DD/MM/YYYY</strong>: European format (day/month/year)<br>
        • <strong>Custom</strong>: Define your own format using YYYY, MM, DD placeholders<br><br>
        <strong>Examples:</strong><br>
        • YYYY-MM-DD → 2024-01-15<br>
        • MM/DD/YYYY → 01/15/2024<br>
        • DD-MM-YYYY → 15-01-2024<br>
        • Custom: YYYY.MM.DD → 2024.01.15
    `;
    
    // Create a modal to show help
    const helpModal = document.createElement('div');
    helpModal.className = 'modal fade';
    helpModal.id = 'dateFormatHelpModal';
    helpModal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-question-circle me-2"></i>Date Format Help
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Date formats determine how dates are displayed and parsed throughout the system.
                    </div>
                    <div class="mb-3">
                        ${helpText}
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Note:</strong> Changing date formats affects how dates are displayed in forms and lists. 
                        Existing data will be reformatted according to the new format.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('dateFormatHelpModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body and show it
    document.body.appendChild(helpModal);
    const modal = new bootstrap.Modal(helpModal);
    modal.show();
    
    // Clean up modal after it's hidden
    helpModal.addEventListener('hidden.bs.modal', function() {
        helpModal.remove();
    });
}


</script>
{% endblock %} 