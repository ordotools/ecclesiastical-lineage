{% extends "base.html" %}

{% block title %}Metadata - Ecclesiastical Lineage{% endblock %}

{% block full_content %}
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="{{ url_for('dashboard') }}">Ecclesiastical Lineage</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    Welcome, <strong>{{ session.username }}</strong>
                    {% if session.is_admin %}
                        <span class="badge bg-primary ms-2">Admin</span>
                    {% endif %}
                </span>
                <a href="#" 
                   class="logout-link text-danger fw-bold ms-3"
                   style="text-decoration: underline; cursor: pointer;"
                   hx-get="{{ url_for('logout') }}"
                   hx-target="body"
                   hx-push-url="true">
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2 mb-0">Metadata Management</h1>
            <a href="{{ url_for('clergy_list') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Clergy List
            </a>
        </div>

        <div class="row">
            <!-- Ranks Section -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h3 class="h5 mb-0">
                            <i class="fas fa-star me-2"></i>Clergy Ranks
                        </h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Common ranks used in ecclesiastical records</p>
                        
                        <div class="mb-3">
                            <label for="new-rank" class="form-label">Add New Rank</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="new-rank" placeholder="e.g., Bishop, Priest, Deacon">
                                <input type="text" class="form-control" id="new-rank-description" placeholder="Description (optional)">
                                <button class="btn btn-outline-primary" type="button" onclick="addRank()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div class="rank-list">
                            <h6 class="mb-2">Current Ranks ({{ ranks|length }})</h6>
                            {% if ranks %}
                                <div class="list-group list-group-flush" id="ranks-list">
                                    {% for rank in ranks %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center py-2" data-rank-id="{{ rank.id }}">
                                        <div>
                                            <span class="badge bg-secondary">{{ rank.name }}</span>
                                            {% if rank.description %}
                                                <small class="text-muted d-block">{{ rank.description }}</small>
                                            {% endif %}
                                        </div>
                                        <div class="d-flex align-items-center">
                                            {% if rank.name in clergy_ranks %}
                                                <small class="text-muted me-2">Used in records</small>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editRank({{ rank.id }}, '{{ rank.name }}', '{{ rank.description or '' }}')" title="Edit rank">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRank({{ rank.id }}, '{{ rank.name }}')" 
                                                    {% if rank.name in clergy_ranks %}disabled title="Cannot delete - used in clergy records"{% endif %}>
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">No ranks defined yet. Add your first rank above.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Organizations Section -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h3 class="h5 mb-0">
                            <i class="fas fa-church me-2"></i>Organizations
                        </h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Religious organizations and denominations</p>
                        
                        <div class="mb-3">
                            <label for="new-organization" class="form-label">Add New Organization</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="new-organization" placeholder="Organization name">
                                <input type="text" class="form-control" id="new-organization-abbreviation" placeholder="Abbreviation (optional)">
                            </div>
                            <div class="input-group">
                                <input type="text" class="form-control" id="new-organization-description" placeholder="Description (optional)">
                                <button class="btn btn-outline-primary" type="button" onclick="addOrganization()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div class="organization-list">
                            <h6 class="mb-2">Current Organizations ({{ organizations|length }})</h6>
                            {% if organizations %}
                                <div class="list-group list-group-flush" id="organizations-list">
                                    {% for organization in organizations %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center py-2" data-org-id="{{ organization.id }}">
                                        <div>
                                            <span class="text-primary">{{ organization.name }}</span>
                                            {% if organization.abbreviation %}
                                                <span class="badge bg-info ms-2">{{ organization.abbreviation }}</span>
                                            {% endif %}
                                            {% if organization.description %}
                                                <small class="text-muted d-block">{{ organization.description }}</small>
                                            {% endif %}
                                        </div>
                                        <div class="d-flex align-items-center">
                                            {% if organization.name in clergy_organizations %}
                                                <small class="text-muted me-2">Used in records</small>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editOrganization({{ organization.id }}, '{{ organization.name }}', '{{ organization.abbreviation or '' }}', '{{ organization.description or '' }}')" title="Edit organization">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteOrganization({{ organization.id }}, '{{ organization.name }}')"
                                                    {% if organization.name in clergy_organizations %}disabled title="Cannot delete - used in clergy records"{% endif %}>
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">No organizations defined yet. Add your first organization above.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Metadata Sections -->
        <div class="row">
            <!-- Date Formats Section -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="h5 mb-0">
                            <i class="fas fa-calendar me-2"></i>Date Formats
                        </h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Standard date formats used in the system</p>
                        <div class="list-group list-group-flush">
                            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                                <span>Birth Date</span>
                                <code class="text-muted">YYYY-MM-DD</code>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                                <span>Ordination Date</span>
                                <code class="text-muted">YYYY-MM-DD</code>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                                <span>Consecration Date</span>
                                <code class="text-muted">YYYY-MM-DD</code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Info Section -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="h5 mb-0">
                            <i class="fas fa-info-circle me-2"></i>System Information
                        </h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Current system statistics</p>
                        <div class="list-group list-group-flush">
                            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                                <span>Total Clergy Records</span>
                                <span class="badge bg-primary">{{ clergy_ranks|length + clergy_organizations|length }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                                <span>Defined Ranks</span>
                                <span class="badge bg-secondary">{{ ranks|length }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                                <span>Defined Organizations</span>
                                <span class="badge bg-info">{{ organizations|length }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Rank Modal -->
    <div class="modal fade" id="editRankModal" tabindex="-1" aria-labelledby="editRankModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editRankModalLabel">Edit Rank</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editRankForm">
                        <input type="hidden" id="edit-rank-id">
                        <div class="mb-3">
                            <label for="edit-rank-name" class="form-label">Rank Name</label>
                            <input type="text" class="form-control" id="edit-rank-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-rank-description" class="form-label">Description</label>
                            <input type="text" class="form-control" id="edit-rank-description" placeholder="Description (optional)">
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Press Enter to save, Escape to cancel
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveRankEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Organization Modal -->
    <div class="modal fade" id="editOrganizationModal" tabindex="-1" aria-labelledby="editOrganizationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editOrganizationModalLabel">Edit Organization</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editOrganizationForm">
                        <input type="hidden" id="edit-organization-id">
                        <div class="mb-3">
                            <label for="edit-organization-name" class="form-label">Organization Name</label>
                            <input type="text" class="form-control" id="edit-organization-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-organization-abbreviation" class="form-label">Abbreviation</label>
                            <input type="text" class="form-control" id="edit-organization-abbreviation" placeholder="Abbreviation (optional)">
                        </div>
                        <div class="mb-3">
                            <label for="edit-organization-description" class="form-label">Description</label>
                            <input type="text" class="form-control" id="edit-organization-description" placeholder="Description (optional)">
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Press Enter to save, Escape to cancel
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveOrganizationEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
function showMessage(message, type = 'success') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show mb-3`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const flashContainer = document.getElementById('flash-messages');
    flashContainer.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function addRank() {
    const nameInput = document.getElementById('new-rank');
    const descInput = document.getElementById('new-rank-description');
    const rankName = nameInput.value.trim();
    const description = descInput.value.trim();
    
    if (!rankName) {
        showMessage('Please enter a rank name.', 'error');
        return;
    }
    
    fetch('/metadata/rank/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: rankName,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            nameInput.value = '';
            descInput.value = '';
            // Reload the page to show the new rank
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Error adding rank. Please try again.', 'error');
        console.error('Error:', error);
    });
}

function deleteRank(rankId, rankName) {
    if (!confirm(`Are you sure you want to delete the rank "${rankName}"?`)) {
        return;
    }
    
    fetch(`/metadata/rank/${rankId}/delete`, {
        method: 'DELETE',
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            // Remove the rank from the DOM
            const rankElement = document.querySelector(`[data-rank-id="${rankId}"]`);
            if (rankElement) {
                rankElement.remove();
            }
            // Update the count
            const countElement = document.querySelector('.rank-list h6');
            const currentCount = parseInt(countElement.textContent.match(/\((\d+)\)/)[1]);
            countElement.textContent = `Current Ranks (${currentCount - 1})`;
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Error deleting rank. Please try again.', 'error');
        console.error('Error:', error);
    });
}

function addOrganization() {
    const nameInput = document.getElementById('new-organization');
    const abbrInput = document.getElementById('new-organization-abbreviation');
    const descInput = document.getElementById('new-organization-description');
    const orgName = nameInput.value.trim();
    const abbreviation = abbrInput.value.trim();
    const description = descInput.value.trim();
    
    if (!orgName) {
        showMessage('Please enter an organization name.', 'error');
        return;
    }
    
    fetch('/metadata/organization/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: orgName,
            abbreviation: abbreviation,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            nameInput.value = '';
            abbrInput.value = '';
            descInput.value = '';
            // Reload the page to show the new organization
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Error adding organization. Please try again.', 'error');
        console.error('Error:', error);
    });
}

function deleteOrganization(orgId, orgName) {
    if (!confirm(`Are you sure you want to delete the organization "${orgName}"?`)) {
        return;
    }
    
    fetch(`/metadata/organization/${orgId}/delete`, {
        method: 'DELETE',
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            // Remove the organization from the DOM
            const orgElement = document.querySelector(`[data-org-id="${orgId}"]`);
            if (orgElement) {
                orgElement.remove();
            }
            // Update the count
            const countElement = document.querySelector('.organization-list h6');
            const currentCount = parseInt(countElement.textContent.match(/\((\d+)\)/)[1]);
            countElement.textContent = `Current Organizations (${currentCount - 1})`;
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Error deleting organization. Please try again.', 'error');
        console.error('Error:', error);
    });
}

// Handle logout redirect
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.xhr.status === 200) {
        const response = evt.detail.xhr.responseText;
        if (response.includes('logout')) {
            const redirectDiv = evt.detail.target.querySelector('#redirect');
            if (redirectDiv) {
                const url = redirectDiv.getAttribute('data-url');
                setTimeout(function() {
                    window.location.href = url;
                }, 1000);
            }
        }
    }
});

// Add enter key support for forms
document.getElementById('new-rank').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        addRank();
    }
});

document.getElementById('new-organization').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        addOrganization();
    }
});

document.getElementById('new-organization-abbreviation').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        addOrganization();
    }
});

// Edit functions
function editRank(rankId, rankName, rankDescription) {
    document.getElementById('edit-rank-id').value = rankId;
    document.getElementById('edit-rank-name').value = rankName;
    document.getElementById('edit-rank-description').value = rankDescription;
    
    const modal = new bootstrap.Modal(document.getElementById('editRankModal'));
    modal.show();
}

function saveRankEdit() {
    const rankId = document.getElementById('edit-rank-id').value;
    const rankName = document.getElementById('edit-rank-name').value.trim();
    const rankDescription = document.getElementById('edit-rank-description').value.trim();
    
    if (!rankName) {
        showMessage('Please enter a rank name.', 'error');
        return;
    }
    
    fetch(`/metadata/rank/${rankId}/edit`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: rankName,
            description: rankDescription
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editRankModal'));
            modal.hide();
            // Reload the page to show updated data
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Error updating rank. Please try again.', 'error');
        console.error('Error:', error);
    });
}

function editOrganization(orgId, orgName, orgAbbreviation, orgDescription) {
    document.getElementById('edit-organization-id').value = orgId;
    document.getElementById('edit-organization-name').value = orgName;
    document.getElementById('edit-organization-abbreviation').value = orgAbbreviation;
    document.getElementById('edit-organization-description').value = orgDescription;
    
    const modal = new bootstrap.Modal(document.getElementById('editOrganizationModal'));
    modal.show();
}

function saveOrganizationEdit() {
    const orgId = document.getElementById('edit-organization-id').value;
    const orgName = document.getElementById('edit-organization-name').value.trim();
    const orgAbbreviation = document.getElementById('edit-organization-abbreviation').value.trim();
    const orgDescription = document.getElementById('edit-organization-description').value.trim();
    
    if (!orgName) {
        showMessage('Please enter an organization name.', 'error');
        return;
    }
    
    fetch(`/metadata/organization/${orgId}/edit`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: orgName,
            abbreviation: orgAbbreviation,
            description: orgDescription
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editOrganizationModal'));
            modal.hide();
            // Reload the page to show updated data
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Error updating organization. Please try again.', 'error');
        console.error('Error:', error);
    });
}

// Add keyboard event handlers for modals
document.addEventListener('DOMContentLoaded', function() {
    // Rank edit modal keyboard handlers
    const editRankModal = document.getElementById('editRankModal');
    if (editRankModal) {
        editRankModal.addEventListener('shown.bs.modal', function() {
            document.getElementById('edit-rank-name').focus();
        });
        
        // Enter key to save
        document.getElementById('edit-rank-name').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveRankEdit();
            }
        });
        
        document.getElementById('edit-rank-description').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveRankEdit();
            }
        });
        
        // Escape key to cancel
        editRankModal.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = bootstrap.Modal.getInstance(editRankModal);
                modal.hide();
            }
        });
    }
    
    // Organization edit modal keyboard handlers
    const editOrganizationModal = document.getElementById('editOrganizationModal');
    if (editOrganizationModal) {
        editOrganizationModal.addEventListener('shown.bs.modal', function() {
            document.getElementById('edit-organization-name').focus();
        });
        
        // Enter key to save
        document.getElementById('edit-organization-name').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveOrganizationEdit();
            }
        });
        
        document.getElementById('edit-organization-abbreviation').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveOrganizationEdit();
            }
        });
        
        document.getElementById('edit-organization-description').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveOrganizationEdit();
            }
        });
        
        // Escape key to cancel
        editOrganizationModal.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = bootstrap.Modal.getInstance(editOrganizationModal);
                modal.hide();
            }
        });
    }
});
</script>
{% endblock %} 