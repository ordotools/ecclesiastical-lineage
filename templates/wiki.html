{% extends "base.html" %}

{% block title %}ClergyWiki - Knowledge Graph{% endblock %}

{% block navbar %}{% endblock %}

{% block extra_styles %}
<link href="{{ url_for('static', filename='css/wiki.css') }}" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap"
    rel="stylesheet">
{% endblock %}

{% block full_content %}
<div class="wiki-wrapper">
    <!-- Sidebar -->
    <aside class="wiki-sidebar" id="wiki-sidebar">
        <div class="wiki-sidebar-header">
            <div class="wiki-dropdown-container">
                <button id="wikiTitleBtn">
                    <i class="fas fa-book-open" style="color: var(--wiki-primary-color);"></i>
                    <span>ClergyWiki</span>
                </button>
                <div id="wikiDropdown">
                    <a class="wiki-dropdown-item" href="/">
                        <i class="fas fa-project-diagram me-2"></i>Lineage View
                    </a>
                    <a class="wiki-dropdown-item" href="/chapel-view">
                        <i class="fas fa-globe me-2"></i>Chapel View
                    </a>
                    <a class="wiki-dropdown-item" href="/wiki">
                        <i class="fas fa-book me-2"></i>ClergyWiki
                    </a>
                </div>
            </div>
        </div>

        <div class="wiki-sidebar-content">
            <!-- Search -->
            <div class="wiki-search-container">
                <input type="text" id="wiki-search-input" class="wiki-search-input" placeholder="Search articles...">
                <i class="fas fa-search wiki-search-icon"></i>
            </div>

            <!-- Nav -->
            <div style="margin-bottom: 2rem;">
                <button id="wiki-home-btn" class="wiki-nav-btn">
                    <i class="far fa-file-alt" style="width: 16px;"></i> Main Page
                </button>
                <button id="wiki-random-btn" class="wiki-nav-btn">
                    <i class="fas fa-random" style="width: 16px;"></i> Random Article
                </button>
                {% if session.get('user_id') %}
                <button id="wiki-new-page-btn" class="wiki-nav-btn primary">
                    <i class="fas fa-plus" style="width: 16px;"></i> New Page
                </button>
                {% endif %}
            </div>

            <!-- Page List -->
            <div>
                <div class="wiki-page-list-header">All Pages</div>
                <div id="wiki-pages-list" style="display: flex; flex-direction: column; gap: 2px;">
                    <!-- JS Populated -->
                </div>
            </div>

            <!-- Backlinks (view mode only) -->
            <div id="wiki-backlinks-section" class="wiki-backlinks-section" style="display: none;">
                <div class="wiki-page-list-header">Backlinks</div>
                <div id="wiki-backlinks-list" class="wiki-backlinks-list">
                    <!-- JS Populated -->
                </div>
            </div>
        </div>

        <div
            style="padding: 1rem; border-top: 1px solid var(--wiki-border-color); font-size: 0.75rem; color: #9ca3af; text-align: center;">
            ClergyWiki v1.0
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="wiki-main">
        <!-- Header -->
        <header class="wiki-header">
            <div class="wiki-header-left">
                <button id="wiki-toggle-sidebar" class="btn-icon">
                    <i class="fas fa-bars"></i>
                </button>

                <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                    <span id="wiki-exit-wrap" style="display: none; align-items: center; gap: 0.5rem;">
                        <button id="wiki-exit-btn" class="btn-icon" style="font-size: 0.75rem;">
                            <i class="fas fa-times"></i> Exit
                        </button>
                        <span style="color: #d1d5db;">|</span>
                    </span>
                    <span id="wiki-main-title" style="font-weight: 600; color: #111827;">Loading...</span>
                </div>
            </div>

            <div class="wiki-header-right">
                {% if session.get('user_id') %}
                <button id="wiki-edit-btn" class="btn-secondary">
                    <i class="far fa-edit"></i> Edit
                </button>
                <div class="wiki-auth-actions"
                    style="display: flex; gap: 0.5rem; border-left: 1px solid #e5e7eb; padding-left: 0.5rem; margin-left: 0.5rem;">
                    <!-- Logout handled via link or button -->
                    <a href="/wiki/dashboard" class="btn-secondary">
                        <i class="fas fa-list"></i> Manage Articles
                    </a>
                    <a href="{{ url_for('auth.logout', next=request.path) }}" class="btn-secondary"
                        style="color: #ef4444; border-color: #fca5a5;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
                {% else %}
                <a href="{{ url_for('auth.login', next=request.path) }}" class="btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Login to Edit
                </a>
                {% endif %}

                <button id="wiki-cancel-btn" class="btn-icon"
                    style="font-size: 0.875rem; color: #4b5563; display: none;">
                    Cancel
                </button>
                <button id="wiki-save-btn" class="btn-primary" style="display: none;">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </header>

        <!-- Content -->
        <div id="wiki-content-area" class="wiki-content-area">
            <div class="wiki-content-flex">
            <div class="wiki-article fade-in">
                <!-- View Mode -->
                <div id="wiki-view-container">
                    <!-- JS Populated -->
                </div>

                <!-- Edit Mode -->
                <div id="wiki-edit-container" class="wiki-editor" style="display: none;">
                    <div class="wiki-title-container" style="position: relative;">
                        <input type="text" id="wiki-edit-title-input" class="wiki-title-input"
                            placeholder="Page Title or Clergy Name" autocomplete="off">
                        <div id="wiki-clergy-dropdown" class="wiki-clergy-dropdown" style="display: none;"></div>
                    </div>

                    <!-- Metadata Controls -->
                    <div class="wiki-metadata-controls">
                        <div class="wiki-control-group">
                            <i class="fas fa-user-edit" style="color: #6b7280;"></i>
                            <select id="wiki-author-select" class="wiki-select">
                                <option value="">Select Author...</option>
                            </select>
                        </div>

                        <div class="wiki-control-group">
                            <label class="wiki-toggle-wrapper">
                                <input type="checkbox" id="wiki-visible-toggle" checked>
                                <span class="wiki-toggle-slider"></span>
                            </label>
                            <span class="wiki-control-label">Visible</span>
                        </div>

                        <div class="wiki-control-group">
                            <label class="wiki-toggle-wrapper danger">
                                <input type="checkbox" id="wiki-deleted-toggle">
                                <span class="wiki-toggle-slider"></span>
                            </label>
                            <span class="wiki-control-label">Deleted</span>
                        </div>
                    </div>

                    <div class="edit-tip-box">
                        <i class="fas fa-info-circle"></i>
                        <strong>Tip:</strong> Use markdown for formatting.
                        <code>[[Page Name]]</code> for links,
                        <code>**bold**</code>,
                        <code>*italic*</code>.
                        Citations: <code>[^1]</code> and <code>[^1]: Source</code>.
                        Clergy: <code>{% raw %}{{clergy:123}}{% endraw %}</code> or <code>{% raw %}{{clergy:123:ordinations}}{% endraw %}</code>.
                        Lineage: <code>{% raw %}{{lineage:123}}{% endraw %}</code> or <code>{% raw %}{{lineage:Clergy Name}}{% endraw %}</code>.
                        Drag and drop images to insert.
                        Shortcuts: <kbd>Ctrl+B</kbd> bold, <kbd>Ctrl+I</kbd> italic, <kbd>Ctrl+K</kbd> link, <kbd>Ctrl+S</kbd> save.
                    </div>

                    <div class="wiki-toolbar">
                        <button type="button" class="wiki-toolbar-btn" data-action="bold" title="Bold (Ctrl+B)">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button type="button" class="wiki-toolbar-btn" data-action="italic" title="Italic (Ctrl+I)">
                            <i class="fas fa-italic"></i>
                        </button>
                        <span class="wiki-toolbar-sep"></span>
                        <button type="button" class="wiki-toolbar-btn" data-action="h1" title="Heading 1">
                            <i class="fas fa-heading"></i> 1
                        </button>
                        <button type="button" class="wiki-toolbar-btn" data-action="h2" title="Heading 2">
                            <i class="fas fa-heading"></i> 2
                        </button>
                        <button type="button" class="wiki-toolbar-btn" data-action="h3" title="Heading 3">
                            <i class="fas fa-heading"></i> 3
                        </button>
                        <span class="wiki-toolbar-sep"></span>
                        <button type="button" class="wiki-toolbar-btn" data-action="link" title="Link (Ctrl+K)">
                            <i class="fas fa-link"></i>
                        </button>
                        <button type="button" class="wiki-toolbar-btn" data-action="citation" title="Citation">
                            <i class="fas fa-quote-right"></i>
                        </button>
                    </div>

                    <div class="wiki-editor-container">
                        <div id="wiki-backdrop" class="wiki-backdrop"></div>
                        <textarea id="wiki-textarea" class="wiki-textarea" placeholder="# Page Title..."></textarea>
                        <!-- Article Autocomplete Dropdown -->
                        <div id="wiki-article-dropdown" class="wiki-autocomplete-dropdown" style="display: none;"></div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="wiki-footer">
                    <span>Last updated: Just now</span>
                    <div style="display: flex; gap: 1rem;">
                        <span>Privacy Policy</span>
                        <span>Terms</span>
                    </div>
                </div>
            </div>
            <aside id="wiki-clergy-aside" class="wiki-clergy-aside" style="display: none;"></aside>
            </div>
        </div>
    </main>

</div>
{% endblock %}

{% block scripts %}
<script type="module" src="{{ url_for('static', filename='js/utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/fuzzySearch.js') }}"></script>
<script src="{{ url_for('static', filename='js/d3.v7.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/wiki-lineage-chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/wiki-renderer.js') }}"></script>
<script src="{{ url_for('static', filename='js/wiki.js') }}?v={{ range(1, 10000) | random }}"></script>
<script src="{{ url_for('static', filename='js/syntax_highlighter.js') }}"></script>
{% endblock %}